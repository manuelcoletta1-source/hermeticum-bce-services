<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>HERMETICUM — Creazione IPR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Creazione IPR (stile banca UE) — soggetto biologico, testo e/o file, PUBLIC/PRIVATE, hash-only, no data custody. Download automatico (bundle unico).">

  <style>
    :root{
      --bg:#0b0d10; --paper:#0f1318; --text:#e7edf5; --muted:#9fb0c2;
      --line:rgba(255,255,255,.12); --soft:rgba(255,255,255,.06); --max:980px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45}
    a{color:inherit;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--max);margin:0 auto;padding:0 16px}

    header{border-bottom:1px solid var(--line);background:rgba(0,0,0,.22);backdrop-filter:blur(6px)}
    .head{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 0}
    .brand{font-weight:900;letter-spacing:.9px}
    .brand small{display:block;font-weight:600;letter-spacing:.2px;color:var(--muted);font-size:12px;margin-top:2px}
    nav{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    nav a{padding:6px 8px;border-radius:10px}
    nav a:hover{background:var(--soft);color:var(--text);text-decoration:none}
    .policy{border-top:1px solid var(--line);padding:10px 0;font-size:12px;color:var(--muted)}
    .policy b{color:var(--text);font-weight:800}

    main{padding:22px 0 34px}
    .card{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:16px}
    h1{margin:0 0 6px;font-size:22px}
    .subtitle{margin:0;color:var(--muted);max-width:92ch;font-size:13px}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .section-title{margin:0 0 8px;font-size:13px;color:var(--text);letter-spacing:.2px}

    label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    input,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.22);color:var(--text);font-size:14px;outline:none
    }
    textarea{min-height:120px;resize:vertical}
    input[type="file"]{padding:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
    .row > div{flex:1;min-width:170px}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);font-size:14px;cursor:pointer
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:rgba(255,255,255,.06)}
    .btn.primary:hover{background:rgba(255,255,255,.09)}

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .out{
      margin-top:12px;padding:14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-family:ui-monospace,monospace;font-size:13px;
      white-space:pre-line;overflow:auto
    }

    footer{border-top:1px solid var(--line);background:rgba(0,0,0,.18);padding:18px 0 24px;color:var(--muted)}
    .sig{margin-top:10px;font-size:12px;opacity:.7;letter-spacing:.4px}
  </style>
</head>

<body>
<header>
  <div class="wrap head">
    <div class="brand">
      HERMETICUM
      <small>Creazione IPR — Modulo Standard (EU-style)</small>
    </div>
    <nav>
      <a href="../">Home</a>
      <a href="../verify/">Verifica</a>
      <a href="../audit/">Audit</a>
      <a href="../eu/pilot/">EU Pilot</a>
      <a href="../company/">Company</a>
    </nav>
  </div>
  <div class="wrap policy">
    <b>Audit-first</b> · <b>Fail-closed</b> · <b>Hash-only</b> · <b>No data custody</b>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h1>Creazione IPR</h1>
    <p class="subtitle">
      Compila i dati essenziali (self-declared). Inserisci un testo e/o allega un file.
      L’artefatto <b>PRIVATE</b> include il payload <b>solo nel file scaricato</b> (non viene mostrato in pagina).
      L’artefatto <b>PUBLIC</b> esclude il payload. Nessuna custodia dati.
    </p>

    <div class="divider"></div>

    <p class="section-title">A) Identità dichiarata (soggetto biologico)</p>

    <label>Nome e Cognome</label>
    <input id="nome" placeholder="Nome Cognome">

    <div class="row">
      <div>
        <label>Paese (ISO2 consigliato)</label>
        <input id="nazione" placeholder="IT">
      </div>
      <div>
        <label>Regione</label>
        <input id="regione" placeholder="Piemonte">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Città</label>
        <input id="citta" placeholder="Torino">
      </div>
      <div>
        <label>Zona (quartiere/area/municipio — no indirizzo)</label>
        <input id="zona" placeholder="Quartiere / Municipio / Area">
      </div>
    </div>

    <div class="hint">Nota UE: self-declared. Non inserire indirizzi/civici/coordinate o dati sensibili.</div>

    <div class="divider"></div>

    <p class="section-title">B) Contenuto (testo e/o file)</p>

    <label>Testo (facoltativo)</label>
    <textarea id="contenuto" placeholder="Testo riservato (verrà incluso SOLO nel PRIVATE scaricato)"></textarea>

    <label>File (facoltativo)</label>
    <input id="file" type="file">

    <div class="btnrow">
      <button class="btn primary" onclick="calcReference()">Calcola riferimento (hash)</button>
    </div>

    <div id="refout" class="out">STATO: IDLE</div>

    <div class="divider"></div>

    <p class="section-title">C) Emissione artefatto</p>

    <div class="btnrow">
      <button class="btn primary" onclick="issueArtifact(true)">Crea IPR (PRIVATE)</button>
      <button class="btn" onclick="issueArtifact(false)">Crea IPR (PUBLIC)</button>
    </div>

    <div id="status" class="out">STATO: IDLE</div>

    <div id="dlbox" style="margin-top:12px; display:none;">
      <p class="section-title">Download manuale (fallback)</p>
      <div class="btnrow">
        <a class="btn" id="dl_bundle" href="#" download>Scarica bundle IPR</a>
      </div>
      <div class="hint">Se il browser blocca l’avvio automatico, usa questo pulsante.</div>
    </div>

    <div class="hint">
      Scelta consigliata: <b>bundle unico</b> (un file) per evitare blocchi download su mobile.
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div>HERMETICUM — digital responsibility infrastructure</div>
    <div class="sig">HERMETICUM B.C.E. S.r.l. · EU</div>
  </div>
</footer>

<script>
let lastRef = "";
let lastAlgo = "SHA-256";
let hashBasis = ""; // "FILE" | "TEXT"

let payloadText = "";
let payloadFileMeta = null;
let payloadFileB64 = "";

async function sha256Bytes(uint8){
  const buf = await crypto.subtle.digest("SHA-256", uint8);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function sha256String(text){
  const bytes = new TextEncoder().encode(text);
  return await sha256Bytes(bytes);
}
function base64FromBytes(bytes){
  let binary = "";
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function makeId(prefix, iso){
  return prefix + iso.replace(/[-:TZ.]/g,"").slice(0,14);
}
async function readFileAsBytes(file){
  const ab = await file.arrayBuffer();
  return new Uint8Array(ab);
}

function getIdentity(){
  const name = (document.getElementById("nome").value || "").trim() || "N/A";
  const nation = (document.getElementById("nazione").value || "").trim() || "N/A";
  const region = (document.getElementById("regione").value || "").trim() || "N/A";
  const city = (document.getElementById("citta").value || "").trim() || "N/A";
  const zone = (document.getElementById("zona").value || "").trim() || "N/A";
  return {
    name, nation,
    status: "SELF_DECLARED",
    location: {
      country: nation, region, city, zone,
      granularity: "LOW",
      status: "SELF_DECLARED",
      note: "No address, no coordinates"
    }
  };
}

async function calcReference(){
  const out = document.getElementById("refout");
  const fileInput = document.getElementById("file");
  const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

  payloadText = (document.getElementById("contenuto").value || "").trim();
  payloadFileMeta = null;
  payloadFileB64 = "";
  lastRef = "";
  hashBasis = "";

  if(file){
    const bytes = await readFileAsBytes(file);
    lastRef = await sha256Bytes(bytes);
    hashBasis = "FILE";
    payloadFileMeta = { name:file.name, type:file.type || "application/octet-stream", size:file.size };
    payloadFileB64 = base64FromBytes(bytes);

    out.textContent =
      "STATO: OK\nHASH_BASIS: FILE\nALGORITMO: " + lastAlgo +
      "\nFILE: " + payloadFileMeta.name + " (" + payloadFileMeta.size + " bytes)\n" +
      (payloadText ? "TESTO: presente (incluso solo nel PRIVATE scaricato)\n" : "TESTO: assente\n") +
      "RIFERIMENTO:\n" + lastRef;
    return;
  }

  if(!payloadText){
    out.textContent = "STATO: FAIL\nMOTIVO: inserire testo o allegare un file";
    return;
  }

  lastRef = await sha256Bytes(new TextEncoder().encode(payloadText));
  hashBasis = "TEXT";
  out.textContent =
    "STATO: OK\nHASH_BASIS: TEXT\nALGORITMO: " + lastAlgo + "\nRIFERIMENTO:\n" + lastRef;
}

function buildArtifactTXT({iprID, nowISO, identity, includePayload}){
  const loc = identity.location || {};
  const hasText = !!(payloadText && payloadText.trim());
  const hasFile = !!payloadFileMeta;

  // IMPORTANTISSIMO: NON stampiamo mai payload quando includePayload=false
  const payloadBlock = includePayload ? (() => {
    if(!hasText && !hasFile){
      return "Embedded Payload (PRIVATE)\nMode: EMPTY\n";
    }
    let s = "Embedded Payload (PRIVATE)\n";
    s += "Mode: " + (hasFile && hasText ? "FILE+TEXT" : (hasFile ? "FILE" : "TEXT")) + "\n";
    s += "Hash basis: " + hashBasis + "\n\n";
    if(hasText){
      s += "-----BEGIN PAYLOAD TEXT-----\n" + payloadText + "\n-----END PAYLOAD TEXT-----\n\n";
    }
    if(hasFile){
      s += "File:\n";
      s += "Filename: " + payloadFileMeta.name + "\n";
      s += "MIME: " + payloadFileMeta.type + "\n";
      s += "Size: " + payloadFileMeta.size + " bytes\n";
      s += "Encoding: base64\n\n";
      s += "-----BEGIN PAYLOAD BASE64-----\n" + payloadFileB64 + "\n-----END PAYLOAD BASE64-----\n";
    }
    return s;
  })() : (
    "Embedded Payload\nMode: NONE (PUBLIC ARTIFACT)\nNote: public artifact excludes the payload.\n"
  );

  return `IPR — IDENTITY PRIMARY RECORD
Official Responsibility Artifact

System: HERMETICUM
Regime: Audit-first · Fail-closed · Hash-only · No data custody
Version: IPR-OFFICIAL-v1

IPR ID:
${iprID}

Timestamp (UTC):
${nowISO}

Declared Biological Identity (self-declared)
Name: ${identity.name}
Nation: ${identity.nation}
Status: ${identity.status}

Declared Location (self-declared, low granularity)
Country: ${loc.country}
Region: ${loc.region}
City: ${loc.city}
Zone: ${loc.zone}
Granularity: ${loc.granularity}
Note: ${loc.note}

Cryptographic Reference
Hash: ${lastRef}
Algorithm: ${lastAlgo}
Hash basis: ${hashBasis}

${payloadBlock}

Infrastructure Seal
Generated by HERMETICUM infrastructure
Digital Responsibility Infrastructure
HERMETICUM B.C.E. S.r.l. · EU

Status
Active · Traceable · Verifiable

Note
This document does not constitute legal identification.
It provides a verifiable responsibility record only.
`;
}

async function issueArtifact(isPrivate){
  const status = document.getElementById("status");
  const dlbox = document.getElementById("dlbox");
  dlbox.style.display = "none";

  if(!lastRef || !hashBasis){
    status.textContent = "STATO: FAIL\nMOTIVO: calcolare prima il riferimento (hash)";
    return;
  }

  const anyPayload = (!!(payloadText && payloadText.trim())) || (!!payloadFileMeta);
  if(isPrivate && !anyPayload){
    status.textContent = "STATO: FAIL\nMOTIVO: PRIVATE richiede testo e/o file";
    return;
  }

  const now = new Date().toISOString();
  const iprID = makeId("IPR-O-", now);
  const suffix = isPrivate ? "PRIVATE" : "PUBLIC";
  const identity = getIdentity();

  const artifactTXT = buildArtifactTXT({iprID, nowISO: now, identity, includePayload: isPrivate});

  const payloadObj = isPrivate ? {
    mode: (payloadFileMeta && payloadText && payloadText.trim()) ? "FILE+TEXT" : (payloadFileMeta ? "FILE" : "TEXT"),
    hash_basis: hashBasis,
    text: (payloadText && payloadText.trim()) ? payloadText : undefined,
    file: payloadFileMeta ? {
      filename: payloadFileMeta.name,
      mime: payloadFileMeta.type,
      size: payloadFileMeta.size,
      encoding: "base64",
      data: payloadFileB64
    } : undefined
  } : { mode: "NONE" };

  if(payloadObj.text === undefined) delete payloadObj.text;
  if(payloadObj.file === undefined) delete payloadObj.file;

  const jsonObj = {
    kind: isPrivate ? "IPR_OFFICIAL_PRIVATE" : "IPR_OFFICIAL_PUBLIC",
    version: "IPR-OFFICIAL-v1",
    system: "HERMETICUM",
    regime: ["AUDIT-FIRST","FAIL-CLOSED","HASH-ONLY","NO-DATA-CUSTODY"],
    ipr_id: iprID,
    timestamp_utc: now,
    subject_type: "BIOLOGICAL_SUBJECT",
    declared_identity: identity,
    reference: { hash: lastRef, algorithm: lastAlgo, hash_basis: hashBasis },
    payload: payloadObj,
    seal: { generated_by:"HERMETICUM infrastructure", signature_line:"HERMETICUM B.C.E. S.r.l. · EU" }
  };

  const jsonText = JSON.stringify(jsonObj, null, 2);
  const receipt = await sha256String(jsonText);

  // BUNDLE UNICO (un file solo) => meno blocchi su mobile
  const bundle =
`HERMETICUM IPR BUNDLE (single-file)
ID: ${iprID}
TYPE: ${suffix}
receipt_sha256(json): ${receipt}

===== SECTION: ARTIFACT.TXT =====
${artifactTXT}

===== SECTION: ARTIFACT.JSON =====
${jsonText}

===== SECTION: RECEIPT.SHA256.TXT =====
${receipt}
`;

  const blob = new Blob([bundle], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const filename = `${iprID}_${suffix}_BUNDLE.txt`;

  // fallback manuale pronto
  dlbox.style.display = "block";
  const a = document.getElementById("dl_bundle");
  a.href = url;
  a.download = filename;

  // AUTO-DOWNLOAD (come vuoi tu)
  try { a.click(); } catch(e) {}

  // NON mostriamo payload in pagina: solo status + receipt
  status.textContent =
    "STATO: OK\n" +
    "ARTEFATTO: " + suffix + "\n" +
    "ID: " + iprID + "\n" +
    "receipt_sha256(json):\n" + receipt + "\n\n" +
    "Download automatico avviato (bundle unico).";
  
  // “non si veda fuori”: pulizia immediata a richiesta
  // (se vuoi tenere i campi compilati, commenta le 3 righe sotto)
  // document.getElementById("contenuto").value = "";
  // document.getElementById("file").value = "";
  // payloadText = "";
}
</script>

</body>
</html>
