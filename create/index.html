<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create ‚Äî Riferimento (hash + receipt)</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <header class="hdr">
    <div class="sym">üúè</div>
    <div class="brand">
      HERMETICUM - BLINDATA ¬∑ COMPUTABILE ¬∑ EVOLUTIVA<br />
      <strong>HERMETICUM B.C.E. S.r.l.</strong> ¬∑ UE
    </div>
    <h1>Create ‚Äî Riferimento (hash + receipt)</h1>
    <p class="muted">Non genera IPR. Produce hash-only + receipt. Nessuna custodia dati.</p>
    <nav class="nav">
      <a href="../">Home</a>
      <a href="./">Create</a>
      <a href="../verify/">Verify</a>
      <a href="../audit/">Audit</a>
      <a href="../architecture/">Architettura</a>
      <a href="../eu/pilot/">Pilota UE</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Istruzioni (importante)</h2>
      <p class="small">
        1) Incolla un <strong>payload JSON</strong><br>
        2) Premi <strong>Crea riferimento</strong><br>
        3) Poi premi <strong>Scarica receipt.json</strong> (sempre disponibile)<br>
        4) Se sei in modalit√† <strong>PRIVATE</strong>, puoi anche scaricare <strong>payload.json</strong>
      </p>
      <p class="small">
        Su Android/Chrome: se il download non parte, riprova una seconda volta oppure apri in browser esterno.
        Il sistema non invia dati: genera i file localmente nel tuo browser.
      </p>
    </section>

    <section class="card">
      <h2>Input</h2>

      <label>Modalit√†</label>
      <select id="mode">
        <option value="PRIVATE">PRIVATE (include payload nel download)</option>
        <option value="PUBLIC">PUBLIC (solo receipt, payload non incluso)</option>
      </select>

      <label>Payload (JSON)</label>
      <textarea id="payload" rows="10" placeholder='Esempio: {"evento":"X","valore":123}'></textarea>

      <div class="hr"></div>

      <button class="btn" id="btnCreate">Crea riferimento</button>
      <span class="pill" id="pillStatus">IDLE</span>

      <p class="small" id="hintAfterCreate">
        Dopo la creazione, sotto compariranno <strong>payload_sha256</strong> e <strong>receipt</strong>.
        Poi usa i pulsanti ‚ÄúScarica‚Äù.
      </p>

      <div class="hr"></div>

      <h2>Output</h2>

      <label>payload_sha256</label>
      <input id="outPayloadSha" readonly />

      <label>receipt (JSON)</label>
      <textarea id="outReceipt" rows="10" readonly></textarea>

      <div class="hr"></div>

      <h2>Download</h2>
      <p class="small">
        <strong>receipt.json</strong> √® sempre scaricabile dopo ‚ÄúCrea riferimento‚Äù.<br>
        <strong>payload.json</strong> √® scaricabile solo in modalit√† <strong>PRIVATE</strong>.
      </p>

      <div class="row">
        <button class="btn" id="btnDlReceipt">Scarica receipt.json</button>
        <button class="btn" id="btnDlPayload">Scarica payload.json (PRIVATE)</button>
      </div>

      <p class="small">
        Nota tecnica: il payload viene canonicalizzato (chiavi ordinate) prima dell‚Äôhash.
        In PUBLIC scarichi solo il receipt (hash-only). In PRIVATE scarichi receipt + payload.
      </p>
    </section>
  </main>

  <footer class="ftr">
    üúè HERMETICUM ‚Äî Create (hash-only) ¬∑ HERMETICUM B.C.E. S.r.l.
  </footer>

<script src="../assets/app.js"></script>
<script>
  const $ = (id) => document.getElementById(id);

  let lastReceipt = null;
  let lastPayloadObj = null;

  function setStatus(t){
    $("pillStatus").textContent = t;
  }

  $("btnCreate").addEventListener("click", async () => {
    setStatus("WORK");
    const mode = $("mode").value.trim();
    const parsed = safeParseJson($("payload").value.trim());

    if(!parsed.ok){
      setStatus("FAIL");
      alert("Payload JSON non valido:\n" + parsed.error);
      return;
    }

    lastPayloadObj = parsed.value;
    const payloadCanon = canonicalStringify(lastPayloadObj);
    const payloadSha = await sha256Hex(payloadCanon);

    const receipt = await buildReceipt({
      mode,
      payloadSha256: payloadSha,
      prevHash: ""
    });

    lastReceipt = receipt;

    $("outPayloadSha").value = payloadSha;
    $("outReceipt").value = JSON.stringify(receipt, null, 2);
    setStatus("OK");
  });

  $("btnDlReceipt").addEventListener("click", () => {
    if(!lastReceipt){ alert("Prima premi: Crea riferimento."); return; }
    downloadText("receipt.json", JSON.stringify(lastReceipt, null, 2));
  });

  $("btnDlPayload").addEventListener("click", () => {
    if(!lastReceipt){ alert("Prima premi: Crea riferimento."); return; }
    if($("mode").value !== "PRIVATE"){
      alert("payload.json √® disponibile solo in modalit√† PRIVATE.");
      return;
    }
    downloadText("payload.json", JSON.stringify(lastPayloadObj, null, 2));
  });
</script>
</body>
</html>
