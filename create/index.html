<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>HERMETICUM ‚Äî Creazione IPR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Creazione IPR UE-style ‚Äî PUBLIC hash-only, PRIVATE include payload sealed (üúè) nel file scaricato. Client-side, no data custody.">

  <style>
    :root{--bg:#05070a;--paper:#0b0f14;--text:#e9f0f8;--muted:#8fa3b8;--line:#1c2733;--line2:#223140;--max:980px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45}
    a{color:inherit;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--max);margin:0 auto;padding:0 16px}
    header{border-bottom:1px solid var(--line);background:rgba(0,0,0,.22);backdrop-filter:blur(6px)}
    .head{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 0}
    .brand{font-weight:900;letter-spacing:.9px}
    .brand small{display:block;font-weight:600;letter-spacing:.2px;color:var(--muted);font-size:12px;margin-top:2px}
    nav{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    nav a{padding:6px 8px;border-radius:10px}
    nav a:hover{background:rgba(255,255,255,.06);color:var(--text);text-decoration:none}
    .policy{border-top:1px solid var(--line);padding:10px 0;font-size:12px;color:var(--muted)}
    .policy b{color:var(--text);font-weight:800}

    main{padding:22px 0 34px}
    .card{background:var(--paper);border:1px solid var(--line);border-radius:0;padding:18px}
    h1{margin:0 0 6px;font-size:22px;letter-spacing:.5px}
    .subtitle{margin:0;color:var(--muted);max-width:92ch;font-size:13px}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .section-title{margin:0 0 8px;font-size:13px;color:var(--text);letter-spacing:.6px}

    label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    input,textarea{
      width:100%;padding:12px;border-radius:0;border:1px solid var(--line2);
      background:rgba(0,0,0,.22);color:var(--text);font-size:14px;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    input[type="file"]{padding:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:180px}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:0;border:1px solid var(--line2);
      background:rgba(255,255,255,.03);font-size:14px;cursor:pointer
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:rgba(255,255,255,.08)}
    .btn.primary:hover{background:rgba(255,255,255,.11)}

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .out{
      margin-top:12px;padding:14px;border-radius:0;border:1px solid var(--line2);
      background:rgba(0,0,0,.18);font-family:ui-monospace,monospace;font-size:13px;
      white-space:pre-line;overflow:auto
    }

    footer{border-top:1px solid var(--line);background:rgba(0,0,0,.18);padding:18px 0 24px;color:var(--muted)}
    .sig{margin-top:10px;font-size:12px;opacity:.75;letter-spacing:.4px;text-align:center}
    .seal{font-size:22px;letter-spacing:6px;margin-top:18px;text-align:center}
  </style>
</head>

<body>
<header>
  <div class="wrap head">
    <div class="brand">
      HERMETICUM
      <small>Creazione IPR ‚Äî Modulo Standard (UE-style)</small>
    </div>
    <nav>
      <a href="/hermeticum-bce-platform/">Home</a>
      <a href="/hermeticum-bce-platform/verify/">Verifica</a>
      <a href="/hermeticum-bce-platform/audit/">Audit</a>
      <a href="/hermeticum-bce-platform/standard/ipr/">Standard</a>
      <a href="/hermeticum-bce-platform/company/">Company</a>
    </nav>
  </div>
  <div class="wrap policy">
    <b>Audit-first</b> ¬∑ <b>Fail-closed</b> ¬∑ <b>Hash-only</b> ¬∑ <b>No data custody</b>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h1>Creazione IPR</h1>
    <p class="subtitle">
      PUBLIC = condivisibile (hash-only). PRIVATE = include payload <b>sigillato</b> (üúè) nel file scaricato.
      Tutto client-side. Nessuna custodia dati.
    </p>

    <div class="divider"></div>

    <p class="section-title">A) Identit√† dichiarata (self-declared)</p>
    <div class="row">
      <div>
        <label>Nome e Cognome</label>
        <input id="full_name" placeholder="es. Mario Rossi">
      </div>
      <div>
        <label>Paese (ISO2 consigliato)</label>
        <input id="country" placeholder="es. IT">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Regione</label>
        <input id="region" placeholder="es. Piemonte">
      </div>
      <div>
        <label>Citt√†</label>
        <input id="city" placeholder="es. Torino">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Zona (quartiere/area/municipio ‚Äî no indirizzo)</label>
        <input id="zone" placeholder="es. Centro / Circoscrizione 1">
      </div>
    </div>
    <div class="hint">Nota UE: dati self-declared. Non inserire indirizzi, coordinate, dati sensibili.</div>

    <div class="divider"></div>

    <p class="section-title">B) Contenuto (riservato all‚Äôutente)</p>
    <div class="row">
      <div>
        <label>Testo (facoltativo)</label>
        <textarea id="note" placeholder="Testo riservato (comparir√† SOLO nel PRIVATE scaricato)"></textarea>
      </div>
      <div>
        <label>File (facoltativo)</label>
        <input id="file" type="file">
        <div class="hint">Se presente il file: SHA-256(file). Altrimenti: SHA-256(testo). Se entrambi: file = hash principale, testo viene comunque sigillato nel PRIVATE.</div>
      </div>
    </div>

    <div class="btnrow">
      <button class="btn primary" onclick="prepare()">Calcola riferimento (hash)</button>
    </div>
    <div id="prepout" class="out">STATO: IDLE</div>

    <div class="divider"></div>

    <p class="section-title">C) Emissione</p>
    <div class="btnrow">
      <button class="btn primary" onclick="issuePRIVATE()">Crea IPR (PRIVATE)</button>
      <button class="btn" onclick="issuePUBLIC()">Crea IPR (PUBLIC)</button>
    </div>
    <div id="out" class="out">STATO: IDLE</div>

    <div id="dlbox" style="margin-top:12px; display:none;">
      <p class="section-title">Download manuale (fallback)</p>
      <div class="btnrow">
        <a class="btn" id="dl_bundle" href="#" download>Scarica bundle</a>
        <a class="btn" id="dl_json" href="#" download>Scarica JSON</a>
        <a class="btn" id="dl_receipt" href="#" download>Scarica receipt</a>
      </div>
      <div class="hint">Se Android blocca l‚Äôavvio automatico, usa questi pulsanti.</div>
    </div>

    <div class="hint">
      PUBLIC non contiene payload. PRIVATE contiene payload sigillato (üúè) e rende l‚Äôutente responsabile del contenuto.
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div>HERMETICUM ‚Äî digital responsibility infrastructure</div>
    <div class="seal">üúè</div>
    <div class="sig">HERMETICUM ‚Äî Blindata ¬∑ Computabile ¬∑ Evolutiva<br>HERMETICUM B.C.E. S.r.l. ¬∑ EU</div>
  </div>
</footer>

<script>
const ALGO = "SHA-256";
const VERSION = "CREATE-v2.2"; // utile per capire se stai vedendo la pagina aggiornata (cache)
let prepared = false;

let SNAP = {
  mode: "EMPTY",
  content_hash: "",
  content_basis: "",
  note: "",
  file_meta: null,
  file_b64: "",
  file_hash: ""
};

async function sha256Bytes(uint8){
  const buf = await crypto.subtle.digest("SHA-256", uint8);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function sha256String(text){
  const bytes = new TextEncoder().encode(text);
  return await sha256Bytes(bytes);
}
async function readFileAsBytes(file){
  const ab = await file.arrayBuffer();
  return new Uint8Array(ab);
}
function base64FromBytes(bytes){
  let binary = "";
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function norm(s){ return (s||"").trim(); }
function makeId(prefix, iso){
  return prefix + iso.replace(/[-:TZ.]/g,"").slice(0,14);
}

async function prepare(){
  const prepout = document.getElementById("prepout");
  prepared = false;

  const note = norm(document.getElementById("note").value);
  const f = document.getElementById("file").files[0];

  SNAP = { mode:"EMPTY", content_hash:"", content_basis:"EMPTY", note:"", file_meta:null, file_b64:"", file_hash:"" };

  if(f){
    const bytes = await readFileAsBytes(f);
    const fh = await sha256Bytes(bytes);
    SNAP.file_hash = fh;
    SNAP.file_meta = { name:f.name, type:(f.type||"application/octet-stream"), size:f.size };
    SNAP.file_b64 = base64FromBytes(bytes);
    SNAP.note = note;
    SNAP.content_hash = fh;
    SNAP.content_basis = "FILE";
    SNAP.mode = note ? "FILE+TEXT" : "FILE";

    prepout.textContent =
      "STATO: OK\nVERSION: " + VERSION +
      "\nMODE: " + SNAP.mode +
      "\nALGORITMO: " + ALGO +
      "\nCONTENT_BASIS: FILE\nCONTENT_HASH:\n" + SNAP.content_hash +
      "\nFILE: " + SNAP.file_meta.name + " (" + SNAP.file_meta.size + " bytes)\n" +
      (note ? "TESTO: presente (sigillato nel PRIVATE)\n" : "TESTO: assente\n");
    prepared = true;
    return;
  }

  if(note){
    const th = await sha256String(note);
    SNAP.note = note;
    SNAP.content_hash = th;
    SNAP.content_basis = "TEXT";
    SNAP.mode = "TEXT";

    prepout.textContent =
      "STATO: OK\nVERSION: " + VERSION +
      "\nMODE: TEXT\nALGORITMO: " + ALGO +
      "\nCONTENT_BASIS: TEXT\nCONTENT_HASH:\n" + SNAP.content_hash;
    prepared = true;
    return;
  }

  SNAP.content_hash = "0".repeat(64);
  SNAP.content_basis = "EMPTY";
  SNAP.mode = "EMPTY";
  prepout.textContent =
    "STATO: OK\nVERSION: " + VERSION +
    "\nMODE: EMPTY\nCONTENT_HASH:\n" + SNAP.content_hash +
    "\nNOTA: nessun contenuto inserito.";
  prepared = true;
}

function issuePRIVATE(){ issue("PRIVATE"); }
function issuePUBLIC(){ issue("PUBLIC"); }

async function issue(kind){
  const out = document.getElementById("out");
  const dlbox = document.getElementById("dlbox");
  dlbox.style.display = "none";

  if(!prepared){
    out.textContent = "STATO: FAIL\nMOTIVO: eseguire prima 'Calcola riferimento (hash)'";
    return;
  }

  const full_name = norm(document.getElementById("full_name").value);
  const country = norm(document.getElementById("country").value);
  const region = norm(document.getElementById("region").value);
  const city = norm(document.getElementById("city").value);
  const zone = norm(document.getElementById("zone").value);

  const now = new Date().toISOString();
  const id = makeId("IPR-O-", now);

  const base = {
    kind: "HBCE_IPR_OFFICIAL",
    version: "IPR-O-v1",
    generator: { module: "HERMETICUM_CREATE", module_version: VERSION },
    system: "HERMETICUM",
    regime: ["AUDIT-FIRST","FAIL-CLOSED","HASH-ONLY","NO-DATA-CUSTODY"],
    artifact: { visibility: kind },
    ipr_id: id,
    timestamp_utc: now,
    subject: {
      type: "BIOLOGICAL",
      self_declared: true,
      full_name: full_name || undefined,
      geo: {
        country: country || undefined,
        region: region || undefined,
        city: city || undefined,
        zone: zone || undefined
      }
    },
    content: {
      algorithm: ALGO,
      basis: SNAP.content_basis,
      hash: SNAP.content_hash,
      mode: SNAP.mode
    },
    seal: {
      seal_symbol: "üúè",
      signature_line_1: "HERMETICUM ‚Äî Blindata ¬∑ Computabile ¬∑ Evolutiva",
      signature_line_2: "HERMETICUM B.C.E. S.r.l. ¬∑ EU",
      generated_by: "HERMETICUM infrastructure"
    }
  };

  // cleanup undefined
  if(base.subject.full_name === undefined) delete base.subject.full_name;
  if(base.subject.geo.country === undefined) delete base.subject.geo.country;
  if(base.subject.geo.region === undefined) delete base.subject.geo.region;
  if(base.subject.geo.city === undefined) delete base.subject.geo.city;
  if(base.subject.geo.zone === undefined) delete base.subject.geo.zone;

  // payload ONLY PRIVATE
  if(kind === "PRIVATE"){
    const payload = {
      note: SNAP.note || undefined,
      evidence: SNAP.file_meta ? {
        filename: SNAP.file_meta.name,
        mime: SNAP.file_meta.type,
        size: SNAP.file_meta.size,
        encoding: "base64",
        data: SNAP.file_b64,
        sha256: SNAP.file_hash
      } : undefined
    };
    if(payload.note === undefined) delete payload.note;
    if(payload.evidence === undefined) delete payload.evidence;

    base.payload = payload;
  }

  const jsonText = JSON.stringify(base, null, 2);
  const receipt = await sha256String(jsonText);

  // SEALED payload section (only PRIVATE, readable)
  const sealed =
    (kind === "PRIVATE")
      ? (`===== SECTION: PRIVATE_PAYLOAD (SEALED) =====
üúè HERMETICUM ‚Äî Blindata ¬∑ Computabile ¬∑ Evolutiva
HERMETICUM B.C.E. S.r.l. ¬∑ EU

NOTE:
${SNAP.note ? SNAP.note : "[ASSENTE]"}

FILE:
${SNAP.file_meta ? (SNAP.file_meta.name + " (" + SNAP.file_meta.size + " bytes) sha256=" + SNAP.file_hash) : "[ASSENTE]"}
`)
      : "";

  const bundle =
`HERMETICUM IPR BUNDLE (single-file)
IPR_ID: ${id}
ARTEFATTO: ${kind}
timestamp_utc: ${now}
content_basis: ${SNAP.content_basis}
content_hash_sha256: ${SNAP.content_hash}
receipt_sha256(json): ${receipt}

${sealed}
===== SECTION: IPR.JSON =====
${jsonText}

===== SECTION: RECEIPT.SHA256.TXT =====
${receipt}
`;

  const bBundle = new Blob([bundle], {type:"text/plain"});
  const bJson = new Blob([jsonText], {type:"application/json"});
  const bRec = new Blob([receipt + "\n"], {type:"text/plain"});

  const uBundle = URL.createObjectURL(bBundle);
  const uJson = URL.createObjectURL(bJson);
  const uRec = URL.createObjectURL(bRec);

  const fnBase = `${id}_${kind}`;
  const fnBundle = `${fnBase}_BUNDLE.txt`;
  const fnJson = `${fnBase}.json`;
  const fnRec = `${fnBase}.receipt.sha256.txt`;

  // fallback
  dlbox.style.display = "block";
  const aB = document.getElementById("dl_bundle");
  const aJ = document.getElementById("dl_json");
  const aR = document.getElementById("dl_receipt");
  aB.href = uBundle; aB.download = fnBundle;
  aJ.href = uJson;   aJ.download = fnJson;
  aR.href = uRec;    aR.download = fnRec;

  // auto download best-effort
  try{ aB.click(); }catch(e){}

  out.textContent =
    "STATO: OK\n" +
    "ARTEFATTO: " + kind + "\n" +
    "ID: " + id + "\n" +
    "VERSION: " + VERSION + "\n" +
    "MODE: " + SNAP.mode + "\n" +
    "RIFERIMENTO (content_hash):\n" + SNAP.content_hash + "\n" +
    "receipt_sha256(json):\n" + receipt + "\n\n" +
    (kind === "PRIVATE" ? "PRIVATE include payload sigillato (üúè) nel bundle.\n" : "PUBLIC √® hash-only (nessun payload).\n") +
    "Download avviato ‚Äî fallback disponibile.";
}
</script>

</body>
</html>
