<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>HERMETICUM — Create IPR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="HERMETICUM create — official IPR artifact generation with embedded private payload, optional AI interface metadata, and standardized self-declared fields (hash-only, no data custody).">

  <style>
    :root{--bg:#0b0d10;--card:#0f1318;--text:#e7edf5;--muted:#9fb0c2;--line:rgba(255,255,255,.12);--soft:rgba(255,255,255,.06);--max:1100px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45}
    a{color:inherit;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--max);margin:0 auto;padding:0 16px}

    .nav{border-bottom:1px solid var(--line);background:rgba(0,0,0,.2);backdrop-filter:blur(6px)}
    .nav-inner{max-width:var(--max);margin:0 auto;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:16px}
    .brand{font-weight:800;letter-spacing:.8px}
    .nav-links{display:flex;gap:12px;font-size:14px;color:var(--muted);flex-wrap:wrap}
    .nav-links a{padding:6px 8px;border-radius:10px}
    .nav-links a:hover{background:var(--soft);color:var(--text);text-decoration:none}

    .policy{border-bottom:1px solid var(--line);background:rgba(255,255,255,.03);font-size:13px;color:var(--muted);padding:10px 16px}

    main{padding:32px 0}
    .hero h1{margin:0 0 10px;font-size:26px;line-height:1.15}
    .hero p{margin:0;max-width:92ch;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:24px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    @media(min-width:900px){.half{grid-column:span 6}}

    .section-title{margin:0 0 8px;font-size:14px;color:var(--text);letter-spacing:.2px}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input,textarea,select{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.22);color:var(--text);font-size:14px;outline:none
    }
    textarea{min-height:140px;resize:vertical}
    input[type="file"]{padding:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
    .row > div{flex:1;min-width:170px}

    .chk{display:flex;align-items:center;gap:10px;margin-top:12px;color:var(--muted);font-size:13px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:14px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:rgba(255,255,255,.06)}
    .btn.primary:hover{background:rgba(255,255,255,.09)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .out{margin-top:12px;padding:14px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.18);font-family:ui-monospace,monospace;font-size:13px;white-space:pre-line;overflow:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    footer{border-top:1px solid var(--line);background:rgba(0,0,0,.18);padding:22px 0 26px;color:var(--muted)}
    .footer-inner{max-width:var(--max);margin:0 auto;padding:0 16px}
    .mini{font-size:13px;opacity:.9}
    .sig{margin-top:18px;font-size:12px;opacity:.6;letter-spacing:.4px}
  </style>
</head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <div class="brand">HERMETICUM</div>
    <div class="nav-links">
      <a href="../">Home</a>
      <a href="../architecture/">Architecture</a>
      <a href="../use-cases/">Use-Cases</a>
      <a href="../create/">Create</a>
      <a href="../verify/">Verify</a>
      <a href="../audit/">Audit</a>
      <a href="../eu/pilot/">EU Pilot</a>
      <a href="../company/">Company</a>
    </div>
  </div>
</nav>

<div class="policy"><div class="wrap">Audit-first · Fail-closed · Hash-only · No data custody</div></div>

<main class="wrap">
  <section class="hero">
    <h1>Generazione IPR Ufficiale</h1>
    <p>
      Artefatto PUBLIC/PRIVATE con payload incastonato (PRIVATE), metadati AI opzionali,
      e dati self-declared standardizzati. Nessuna custodia dati.
    </p>
  </section>

  <section class="grid">
    <div class="card half">
      <div class="section-title">Tipo soggetto</div>
      <div class="row">
        <div class="chk">
          <input id="sub_bio" type="radio" name="subtype" checked onchange="renderSubjectMode()">
          <label for="sub_bio" style="margin:0">BIOLOGICO (utente)</label>
        </div>
        <div class="chk">
          <input id="sub_ai" type="radio" name="subtype" onchange="renderSubjectMode()">
          <label for="sub_ai" style="margin:0">AI (entità cibernetica personale evolutiva)</label>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title" id="subjectTitle">Dati del soggetto (self-declared)</div>

      <div id="bioBlock">
        <label>Nome e Cognome</label>
        <input id="nome" placeholder="Nome Cognome">

        <div class="row">
          <div>
            <label>Nazione (ISO2 consigliato)</label>
            <input id="nazione" placeholder="IT">
          </div>
          <div>
            <label>Regione</label>
            <input id="regione" placeholder="Piemonte">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Città</label>
            <input id="citta" placeholder="Torino">
          </div>
          <div>
            <label>Zona (quartiere/area/municipio — no indirizzo)</label>
            <input id="zona" placeholder="Area / Quartiere / Municipio">
          </div>
        </div>

        <div class="hint">
          Nota UE: self-declared, non verificato. Inserire granularità bassa (no indirizzi, no coordinate).
        </div>
      </div>

      <div id="aiBlock" style="display:none">
        <label>Nome entità AI (self-declared)</label>
        <input id="ai_name" placeholder="AI JOKER / entità personale">

        <div class="row">
          <div>
            <label>Tipo</label>
            <input id="ai_type" value="CYBERNETIC_ENTITY_PERSONAL_EVOLUTIVE" />
          </div>
          <div>
            <label>Version / Epoch (opzionale)</label>
            <input id="ai_epoch" placeholder="v1 / epoch / build">
          </div>
        </div>

        <label>Owner IPR / Root reference (opzionale)</label>
        <input id="ai_owner" placeholder="IPR-3 / root hash / reference">

        <div class="hint">
          UE-style: entità AI dichiarata, nessuna verifica identità. Audit temporale gestito in /audit/.
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">Payload (riservato)</div>

      <label>Payload — Testo</label>
      <textarea id="contenuto" placeholder="scrivi qui, oppure carica un file sotto"></textarea>

      <label>Payload — File</label>
      <input id="file" type="file">

      <div class="hint">
        Hash calcolato su file (se presente) altrimenti su testo.
        PRIVATE include payload (non condividere). PUBLIC esclude payload (condivisibile).
      </div>

      <div class="btnrow">
        <button class="btn primary" onclick="generateHash()">Genera Hash</button>
      </div>

      <div id="hashout" class="out">STATO: IDLE</div>
    </div>

    <div class="card half">
      <div class="section-title">Interfaccia AI (opzionale)</div>

      <div class="chk">
        <input id="ai_enabled" type="checkbox" />
        <label for="ai_enabled" style="margin:0">Includi metadati AI / interfaccia JOKER</label>
      </div>

      <div class="row">
        <div>
          <label>Availability</label>
          <select id="ai_avail">
            <option value="PUBLIC">PUBLIC</option>
            <option value="PILOT">PILOT</option>
            <option value="INSTITUTIONAL">INSTITUTIONAL</option>
          </select>
        </div>
        <div>
          <label>Mode</label>
          <select id="ai_mode">
            <option value="READ_ONLY">READ_ONLY</option>
            <option value="AUDIT_ASSIST">AUDIT_ASSIST</option>
            <option value="C2_INTERFACE">C2_INTERFACE</option>
          </select>
        </div>
      </div>

      <label>Joker handle / endpoint (opzionale)</label>
      <input id="ai_handle" placeholder="TBD">

      <div class="hint">
        Metadati AI = descrizione di interfaccia tecnica. Nessuna verifica identità, nessuna promessa operativa.
      </div>

      <div class="divider"></div>

      <div class="section-title">Generazione artefatto</div>

      <div class="btnrow">
        <button class="btn primary" onclick="generateIPRPrivate()">GENERA IPR UFFICIALE (PRIVATE)</button>
        <button class="btn" onclick="generateIPRPublic()">GENERA IPR UFFICIALE (PUBLIC)</button>
      </div>

      <div id="iprout" class="out">STATO: IDLE</div>

      <div class="divider"></div>

      <div class="section-title">Download manuale (anti-blocco browser)</div>
      <div class="btnrow">
        <button class="btn" id="dl_txt" onclick="downloadPrepared('txt')" disabled>Scarica TXT</button>
        <button class="btn" id="dl_json" onclick="downloadPrepared('json')" disabled>Scarica JSON</button>
        <button class="btn" id="dl_rcpt" onclick="downloadPrepared('rcpt')" disabled>Scarica receipt</button>
      </div>

      <div class="hint">
        Android/Chrome spesso blocca download automatici multipli. Qui fai 3 click manuali: zero blocchi.
      </div>

      <div class="divider"></div>

      <div class="section-title">AI: crea IPR entità cibernetica + audit</div>
      <div class="hint">
        Dopo aver creato l’IPR (PUBLIC o PRIVATE), vai su <b>/audit/</b> e usa come <b>prev_hash</b> il
        <b>receipt_sha256(json)</b>. Quello è l’aggancio audit-temporale.
        Firma infrastruttura: <b>HERMETICUM B.C.E. S.r.l.</b>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-inner">
    <div class="mini">HERMETICUM — digital responsibility infrastructure</div>
    <div class="sig">HERMETICUM B.C.E. S.r.l. · EU</div>
  </div>
</footer>

<script>
let lastHash = "";
let lastAlgo = "SHA-256";
let payloadMode = "";        // "TEXT" | "FILE"
let payloadText = "";
let payloadFileMeta = null;  // {name,type,size}
let payloadFileB64 = "";     // base64

// prepared downloads (manual)
let PREP = {
  id: "",
  suffix: "",
  txtName: "",
  jsonName: "",
  rcptName: "",
  txtContent: "",
  jsonContent: "",
  rcptContent: ""
};

function setDownloadEnabled(on){
  document.getElementById("dl_txt").disabled = !on;
  document.getElementById("dl_json").disabled = !on;
  document.getElementById("dl_rcpt").disabled = !on;
}

function renderSubjectMode(){
  const isAI = document.getElementById("sub_ai").checked;
  document.getElementById("bioBlock").style.display = isAI ? "none" : "block";
  document.getElementById("aiBlock").style.display = isAI ? "block" : "none";
  document.getElementById("subjectTitle").textContent = isAI
    ? "Dati soggetto AI (self-declared)"
    : "Dati del soggetto (self-declared)";
}

async function sha256Bytes(uint8){
  const buf = await crypto.subtle.digest("SHA-256", uint8);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function sha256String(text){
  const bytes = new TextEncoder().encode(text);
  return await sha256Bytes(bytes);
}
function base64FromBytes(bytes){
  let binary = "";
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function makeId(prefix, iso){
  return prefix + iso.replace(/[-:TZ.]/g,"").slice(0,14);
}
async function readFileAsBytes(file){
  const ab = await file.arrayBuffer();
  return new Uint8Array(ab);
}

function aiConfig(){
  const enabled = document.getElementById("ai_enabled").checked;
  if(!enabled) return { enabled:false };
  return {
    enabled: true,
    name: "AI JOKER ΦΩ — C2 SOFTWARE",
    availability: document.getElementById("ai_avail").value,
    mode: document.getElementById("ai_mode").value,
    handle: (document.getElementById("ai_handle").value || "").trim() || "TBD",
    entrypoints: { verify:"../verify/", audit:"../audit/", pilot:"../eu/pilot/" }
  };
}

function getSubject(){
  const isAI = document.getElementById("sub_ai").checked;

  if(isAI){
    const ai_name = (document.getElementById("ai_name").value || "").trim() || "N/A";
    const ai_type = (document.getElementById("ai_type").value || "").trim() || "CYBERNETIC_ENTITY_PERSONAL_EVOLUTIVE";
    const ai_epoch = (document.getElementById("ai_epoch").value || "").trim() || "N/A";
    const ai_owner = (document.getElementById("ai_owner").value || "").trim() || "N/A";
    return {
      subject_type: "AI_CYBERNETIC_ENTITY",
      ai: { name: ai_name, type: ai_type, epoch: ai_epoch, owner_reference: ai_owner },
      declared_identity: { name: ai_name, nation: "N/A", status: "SELF_DECLARED" }
    };
  }

  const name = (document.getElementById("nome").value || "").trim() || "N/A";
  const nation = (document.getElementById("nazione").value || "").trim() || "N/A";
  const region = (document.getElementById("regione").value || "").trim() || "N/A";
  const city = (document.getElementById("citta").value || "").trim() || "N/A";
  const zone = (document.getElementById("zona").value || "").trim() || "N/A";

  return {
    subject_type: "BIOLOGICAL_SUBJECT",
    declared_identity: {
      name,
      nation,
      status: "SELF_DECLARED",
      location: {
        country: nation,
        region,
        city,
        zone,
        granularity: "LOW",
        status: "SELF_DECLARED",
        note: "No address, no coordinates"
      }
    }
  };
}

async function generateHash(){
  const out = document.getElementById("hashout");
  const fileInput = document.getElementById("file");
  const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

  payloadText = "";
  payloadFileMeta = null;
  payloadFileB64 = "";
  lastHash = "";
  payloadMode = "";

  if(file){
    const bytes = await readFileAsBytes(file);
    lastHash = await sha256Bytes(bytes);
    payloadMode = "FILE";
    payloadFileMeta = { name:file.name, type:file.type || "application/octet-stream", size:file.size };
    payloadFileB64 = base64FromBytes(bytes);
    out.textContent =
      "STATO: OK\nMODE: FILE\nALGORITMO: " + lastAlgo +
      "\nFILE: " + payloadFileMeta.name + " (" + payloadFileMeta.size + " bytes)\nRIFERIMENTO:\n" + lastHash;
    return;
  }

  const txt = (document.getElementById("contenuto").value || "").trim();
  if(!txt){
    out.textContent = "STATO: FAIL\nMOTIVO: payload mancante (testo o file)";
    return;
  }
  payloadMode = "TEXT";
  payloadText = txt;
  lastHash = await sha256Bytes(new TextEncoder().encode(txt));
  out.textContent = "STATO: OK\nMODE: TEXT\nALGORITMO: " + lastAlgo + "\nRIFERIMENTO:\n" + lastHash;
}

function buildAISectionTXT(ai){
  if(!ai || !ai.enabled) return "AI Interface (optional)\nMode: NONE\n";
  return `AI Interface (optional)
Interface: ${ai.name}
Availability: ${ai.availability}
Mode: ${ai.mode}
Handle: ${ai.handle}
Entrypoints:
- verify: ${ai.entrypoints.verify}
- audit: ${ai.entrypoints.audit}
- pilot: ${ai.entrypoints.pilot}
`;
}

function buildSubjectSectionTXT(subject){
  if(subject.subject_type === "AI_CYBERNETIC_ENTITY"){
    return `Declared Subject
Type: AI_CYBERNETIC_ENTITY (self-declared)

AI Identity (self-declared)
Name: ${subject.ai.name}
Type: ${subject.ai.type}
Epoch: ${subject.ai.epoch}
Owner reference: ${subject.ai.owner_reference}

No external verification is performed by the infrastructure.
`;
  }

  const id = subject.declared_identity || {};
  const loc = id.location || {};
  return `Declared Biological Identity
Name: ${id.name}
Nation: ${id.nation}
Status: ${id.status}

Declared Location (self-declared, low granularity)
Country: ${loc.country}
Region: ${loc.region}
City: ${loc.city}
Zone: ${loc.zone}
Granularity: ${loc.granularity}
Note: ${loc.note}

No external verification is performed by the infrastructure.
`;
}

function buildPayloadSectionTXT(includePayload){
  if(!includePayload){
    return `Embedded Payload
Mode: NONE (PUBLIC ARTIFACT)
Note: This public artifact intentionally excludes the payload.`;
  }
  if(payloadMode === "FILE"){
    return `Embedded Payload (PRIVATE)
Mode: FILE
Filename: ${payloadFileMeta.name}
MIME: ${payloadFileMeta.type}
Size: ${payloadFileMeta.size} bytes
Encoding: base64

-----BEGIN PAYLOAD BASE64-----
${payloadFileB64}
-----END PAYLOAD BASE64-----`;
  }
  return `Embedded Payload (PRIVATE)
Mode: TEXT
Encoding: utf-8

-----BEGIN PAYLOAD TEXT-----
${payloadText}
-----END PAYLOAD TEXT-----`;
}

function buildIPRDoc({iprID, nowISO, subject, hash, includePayload, ai}){
  return `IPR — IDENTITY PRIMARY RECORD
Official Responsibility Artifact

System: HERMETICUM
Regime: Audit-first · Fail-closed · Hash-only · No data custody
Version: IPR-OFFICIAL-v1

IPR ID:
${iprID}

Timestamp (UTC):
${nowISO}

${buildSubjectSectionTXT(subject)}

Digital Event
Digital event under responsibility of the declared subject.

Cryptographic Reference
Hash: ${hash}
Algorithm: ${lastAlgo}

${buildPayloadSectionTXT(includePayload)}

${buildAISectionTXT(ai)}

Responsibility Statement
The declared subject assumes responsibility for the digital event
associated with the reference hash above.

Infrastructure Seal
Generated by HERMETICUM infrastructure
Digital Responsibility Infrastructure
HERMETICUM B.C.E. S.r.l. · EU

Status
Active · Traceable · Verifiable

Note
This document does not constitute legal identification.
It provides a verifiable responsibility record only.
`;
}

function prepareDownloadText(filename, content){
  const blob = new Blob([content], {type:"text/plain"});
  return { filename, blob };
}
function prepareDownloadJson(filename, content){
  const blob = new Blob([content], {type:"application/json"});
  return { filename, blob };
}
function saveBlob(filename, blob){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function downloadPrepared(kind){
  if(!PREP.id) return;
  if(kind === "txt") return saveBlob(PREP.txtName, new Blob([PREP.txtContent], {type:"text/plain"}));
  if(kind === "json") return saveBlob(PREP.jsonName, new Blob([PREP.jsonContent], {type:"application/json"}));
  if(kind === "rcpt") return saveBlob(PREP.rcptName, new Blob([PREP.rcptContent], {type:"text/plain"}));
}

async function generateIPR(includePayload){
  const out = document.getElementById("iprout");
  setDownloadEnabled(false);

  if(!lastHash) return out.textContent = "STATO: FAIL\nMOTIVO: genera prima l'hash";
  if(includePayload && (payloadMode !== "TEXT" && payloadMode !== "FILE")){
    return out.textContent = "STATO: FAIL\nMOTIVO: payload non definito";
  }

  const now = new Date().toISOString();
  const iprID = makeId("IPR-O-", now);
  const suffix = includePayload ? "PRIVATE" : "PUBLIC";

  const subject = getSubject();
  const ai = aiConfig();

  const doc = buildIPRDoc({iprID, nowISO:now, subject, hash:lastHash, includePayload, ai});

  const jsonObj = {
    kind: includePayload ? "IPR_OFFICIAL_PRIVATE" : "IPR_OFFICIAL_PUBLIC",
    version: "IPR-OFFICIAL-v1",
    system: "HERMETICUM",
    regime: ["AUDIT-FIRST","FAIL-CLOSED","HASH-ONLY","NO-DATA-CUSTODY"],
    ipr_id: iprID,
    timestamp_utc: now,
    subject_type: subject.subject_type,
    declared_identity: subject.declared_identity,
    ai_subject: subject.ai ? subject.ai : undefined,
    reference: { hash:lastHash, algorithm:lastAlgo },
    payload: includePayload
      ? (payloadMode === "FILE"
          ? { mode:"FILE", filename: payloadFileMeta.name, mime: payloadFileMeta.type, size: payloadFileMeta.size, encoding:"base64", data: payloadFileB64 }
          : { mode:"TEXT", encoding:"utf-8", data: payloadText })
      : { mode:"NONE" },
    ai_interface: ai,
    seal: { generated_by:"HERMETICUM infrastructure", signature_line:"HERMETICUM B.C.E. S.r.l. · EU" }
  };

  // remove undefined fields (ai_subject) cleanly
  if(jsonObj.ai_subject === undefined) delete jsonObj.ai_subject;

  const jsonText = JSON.stringify(jsonObj, null, 2);
  const receipt = await sha256String(jsonText);

  // prepare downloads instead of auto-click
  PREP.id = iprID;
  PREP.suffix = suffix;
  PREP.txtName = iprID + "_" + suffix + ".txt";
  PREP.jsonName = iprID + "_" + suffix + ".json";
  PREP.rcptName = iprID + "_" + suffix + ".receipt.sha256.txt";
  PREP.txtContent = doc;
  PREP.jsonContent = jsonText;
  PREP.rcptContent = receipt + "\n";

  setDownloadEnabled(true);

  // message exactly in your style (but "Download pronto", not "avviato")
  out.textContent =
    "STATO: OK\n" +
    "ARTEFATTO: " + suffix + "\n" +
    "AI_INTERFACE: " + (ai.enabled ? "ON" : "OFF") + "\n" +
    "ID: " + iprID + "\n" +
    "receipt_sha256(json):\n" + receipt + "\n\n" +
    "Download pronto: usa i 3 pulsanti (TXT + JSON + receipt).";
}

function generateIPRPrivate(){ return generateIPR(true); }
function generateIPRPublic(){ return generateIPR(false); }

// init
renderSubjectMode();
</script>

</body>
</html>
