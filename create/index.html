<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create IPR — HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA</title>
  <meta name="description" content="Genera ipr.json + receipt.json firmata (ED25519). Client-side. UE-first, GDPR-min, hash-only, fail-closed." />
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c131c; --txt:#e8eef6; --mut:#a7b3c2;
      --brd:#1d2a3a; --acc:#7dd3fc; --ok:#86efac; --bad:#fda4af; --warn:#fde68a;
      --r:16px; --pad:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{margin:0;background:radial-gradient(900px 600px at 15% 0%, #0d1b2a 0%, var(--bg) 55%);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:26px 18px 60px;}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px}
    .seal{font-weight:900;letter-spacing:.3px}
    .company{color:var(--mut);font-size:12px}
    .tag{color:var(--mut);font-size:13px;line-height:1.45;max-width:520px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--brd);border-radius:var(--r);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .title{font-size:18px;font-weight:800;margin:0 0 8px}
    label{display:block;font-size:12px;color:var(--mut);margin:10px 0 6px}
    input,select,textarea{
      width:100%;box-sizing:border-box;background:#071018;border:1px solid var(--brd);
      color:var(--txt);border-radius:12px;padding:10px 12px;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:1px solid var(--brd);background:#0a1320;color:var(--txt);
      border-radius:12px;padding:10px 12px;font-weight:750;cursor:pointer
    }
    button.primary{border-color:rgba(125,211,252,.6);background:rgba(125,211,252,.1)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status{margin-top:10px;font-size:12px;line-height:1.35}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .out{white-space:pre;overflow:auto;background:#06101a;border:1px solid var(--brd);border-radius:12px;padding:12px;font-size:12px}
    .hr{height:1px;background:var(--brd);margin:14px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="seal">HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA</div>
        <div class="company">HERMETICUM B.C.E. S.r.l.</div>
      </div>
      <div class="tag">
        Generazione client-side di <span class="mono">ipr.json</span> + <span class="mono">receipt.json</span> (firma <b>ED25519</b>).
        Nessun invio a server. Fail-closed.
      </div>
    </header>

    <section class="card">
      <h1 class="title">Create IPR</h1>

      <label for="level">Livello</label>
      <select id="level">
        <option value="BASIC">BASIC</option>
        <option value="STRONG">STRONG</option>
        <option value="INSTITUTION">INSTITUTION</option>
      </select>

      <label for="purpose">Scopo (obbligatorio)</label>
      <input id="purpose" placeholder="Esempio: AI accountability personale" />

      <div class="hr"></div>

      <label for="consentScope">Consenso · scope</label>
      <select id="consentScope">
        <option value="AI_ACCOUNTABILITY">AI_ACCOUNTABILITY</option>
        <option value="PROOF_OF_EXISTENCE">PROOF_OF_EXISTENCE</option>
        <option value="AUDIT_TRAIL">AUDIT_TRAIL</option>
      </select>

      <label for="consentDurationDays">Consenso · durata (giorni)</label>
      <input id="consentDurationDays" type="number" min="1" max="3650" value="365" />

      <label for="consentNote">Consenso · nota (facoltativa)</label>
      <input id="consentNote" placeholder="Breve nota (max 280)" />

      <label style="margin-top:12px">
        <input type="checkbox" id="consentCheck" />
        Confermo: non è IDP (SPID/CIE/eIDAS) e non inserisco dati personali in chiaro.
      </label>

      <div class="hr"></div>

      <label for="country">Nazione ISO2 (facoltativo)</label>
      <input id="country" placeholder="IT" maxlength="2" />

      <label for="region">Regione (facoltativo)</label>
      <input id="region" placeholder="Piemonte" />

      <label for="city">Città (facoltativo)</label>
      <input id="city" placeholder="Torino" />

      <label for="district">Quartiere (facoltativo)</label>
      <input id="district" placeholder="San Salvario" />

      <label for="localSecret">Segreto locale (obbligatorio, non viene esportato in chiaro)</label>
      <input id="localSecret" type="password" placeholder="Passphrase (min 10 caratteri)" />

      <label for="notes">Note operative (facoltative)</label>
      <textarea id="notes" placeholder="Evita dati personali."></textarea>

      <div class="btns">
        <button class="primary" id="generate">Genera</button>
        <button id="downloadIpr" disabled>Scarica ipr.json</button>
        <button id="downloadReceipt" disabled>Scarica receipt.json</button>
      </div>

      <div class="status warn" id="status"></div>

      <div class="hr"></div>

      <label>Anteprima ipr.json</label>
      <div class="out mono" id="iprOut">—</div>

      <label style="margin-top:12px">Anteprima receipt.json</label>
      <div class="out mono" id="rcpOut">—</div>
    </section>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const POLICY = Object.freeze({
    UE_FIRST: true,
    GDPR_MIN: true,
    HASH_ONLY: true,
    FAIL_CLOSED: true,
    AUDIT_APPEND_ONLY: true
  });

  const CFG = Object.freeze({
    SECRET_MIN_LEN: 10,
    PURPOSE_MIN: 3,
    PURPOSE_MAX: 200,
    SUBJECT_PREFIX: "ipr-subject:",
    SUBJECT_HEX_LEN: 32
  });

  let lastIPR = null;
  let lastReceipt = null;

  function setStatus(msg, kind){
    const el = $("status");
    el.className = "status " + (kind || "warn");
    el.textContent = msg || "";
  }

  function nowISO(){ return new Date().toISOString(); }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function stableStringify(obj){
    const seen = new WeakSet();
    const norm = (v) => {
      if(v && typeof v === "object"){
        if(seen.has(v)) throw new Error("Cyclic object not allowed");
        seen.add(v);
        if(Array.isArray(v)) return v.map(norm);
        const keys = Object.keys(v).sort();
        const out = {};
        for(const k of keys) out[k] = norm(v[k]);
        return out;
      }
      return v;
    };
    return JSON.stringify(norm(obj));
  }

  function bufToB64(buf){
    const bytes = new Uint8Array(buf);
    let bin = "";
    for(const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin);
  }

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function cleanISO2(x){
    const s = (x||"").trim().toUpperCase();
    if(!s) return null;
    return /^[A-Z]{2}$/.test(s) ? s : null;
  }

  function optStr(x, max){
    const s = (x||"").trim();
    if(!s) return null;
    return (max && s.length>max) ? s.slice(0,max) : s;
  }

  function reqStr(x, min, max){
    const s = (x||"").trim();
    if(s.length < min) return null;
    if(max && s.length > max) return null;
    return s;
  }

  async function buildSubject(secret, purpose, issuedAt){
    const h = await sha256Hex(secret + "|" + purpose + "|" + issuedAt);
    return CFG.SUBJECT_PREFIX + h.slice(0, CFG.SUBJECT_HEX_LEN);
  }

  async function buildAudit(evt, at, by, subject){
    const h = await sha256Hex(evt + "|" + at + "|" + by + "|" + subject);
    return { evt, at, by, hash_sha256: h };
  }

  async function buildIPR({ level, purpose, consentScope, consentDurationDays, consentNote, notes, ctx, secret }){
    const issued_at = nowISO();
    const subject = await buildSubject(secret, purpose, issued_at);

    const fields_present = Object.entries(ctx).filter(([_,v])=>!!v).map(([k])=>k);
    const context_hash = await sha256Hex(stableStringify(ctx));

    return {
      proto: "AI_JOKER_C2",
      type: "IPR_PACKAGE",
      version: "v1",
      issuer: "HERMETICUM B.C.E. S.r.l.",
      seal: "HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA",
      issued_at,
      level,
      subject,
      purpose,
      policy: POLICY,
      consent: {
        scope: consentScope,
        duration_days: consentDurationDays,
        note: consentNote,
        acknowledged: true
      },
      context: {
        kind: "COARSE_GEO",
        hash_sha256: context_hash,
        fields_present
      },
      notes,
      audit: [
        await buildAudit("EVT-IPR-ISSUED", issued_at, "CLIENT_SIDE_WIZARD", subject)
      ]
    };
  }

  function buildPayload({ ipr, ipr_hash_sha256 }){
    return {
      ipr_subject: ipr.subject,
      ipr_level: ipr.level,
      purpose: ipr.purpose,
      policy: ipr.policy,
      consent_scope: ipr.consent.scope,
      issued_at: ipr.issued_at,
      ipr_hash_sha256
    };
  }

  async function signEd25519OverText(text){
    const keyPair = await crypto.subtle.generateKey(
      { name: "Ed25519" },
      true,
      ["sign","verify"]
    );

    const publicJwk = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
    const kid = await sha256Hex(stableStringify(publicJwk));

    const sigBuf = await crypto.subtle.sign(
      { name: "Ed25519" },
      keyPair.privateKey,
      new TextEncoder().encode(text)
    );

    return {
      scheme: "ED25519",
      kid,
      value: bufToB64(sigBuf),
      public_key_jwk: publicJwk,
      note: "Firma Ed25519 client-side (MVP)."
    };
  }

  $("generate").onclick = async () => {
    try{
      setStatus("Generazione in corso…", "warn");

      const level = $("level").value;

      const purpose = reqStr($("purpose").value, CFG.PURPOSE_MIN, CFG.PURPOSE_MAX);
      if(!purpose) throw new Error("purpose non valido (fail-closed).");

      const consentScope = $("consentScope").value;
      const consentDurationDays = Number($("consentDurationDays").value);
      if(!(consentDurationDays>=1 && consentDurationDays<=3650)) throw new Error("durata consenso non valida (fail-closed).");

      if(!$("consentCheck").checked) throw new Error("consenso non confermato (fail-closed).");

      const secret = ($("localSecret").value||"").trim();
      if(secret.length < CFG.SECRET_MIN_LEN) throw new Error("segreto locale troppo corto (fail-closed).");

      const ctx = {
        country: cleanISO2($("country").value),
        region: optStr($("region").value, 120),
        city: optStr($("city").value, 120),
        district: optStr($("district").value, 120)
      };

      const consentNote = optStr($("consentNote").value, 280);
      const notes = optStr($("notes").value, 2000);

      const ipr = await buildIPR({
        level, purpose,
        consentScope, consentDurationDays, consentNote,
        notes, ctx, secret
      });

      const ipr_hash_sha256 = await sha256Hex(stableStringify(ipr));

      const payload = buildPayload({ ipr, ipr_hash_sha256 });
      const payload_hash_sha256 = await sha256Hex(stableStringify(payload));

      // CRITICAL: we sign the declared payload_hash_sha256 text (hex string)
      const signature = await signEd25519OverText(payload_hash_sha256);

      const receipt = {
        proto: "AI_JOKER_C2",
        type: "RECEIPT",
        version: "v1",
        kind: "IPR_ISSUANCE",
        issued_at: ipr.issued_at,
        payload_hash_sha256,
        payload,
        signature
      };

      lastIPR = ipr;
      lastReceipt = receipt;

      $("iprOut").textContent = JSON.stringify(ipr, null, 2);
      $("rcpOut").textContent = JSON.stringify(receipt, null, 2);

      $("downloadIpr").disabled = false;
      $("downloadReceipt").disabled = false;

      setStatus("OK: generati ipr.json + receipt.json (ED25519).", "ok");
    }catch(e){
      console.error(e);
      setStatus("Errore: " + (e?.message || String(e)), "bad");
    }
  };

  $("downloadIpr").onclick = () => { if(lastIPR) downloadJSON("ipr.json", lastIPR); };
  $("downloadReceipt").onclick = () => { if(lastReceipt) downloadJSON("receipt.json", lastReceipt); };
})();
</script>
</body>
</html>
