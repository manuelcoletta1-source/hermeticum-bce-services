<script>
/* =========================
   AI_JOKER_C2 — CREATE IPR
   UE-first · GDPR-min · hash-only · fail-closed
   Client-side only (GitHub Pages friendly)
========================= */

(() => {
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);

  const POLICY = Object.freeze({
    UE_FIRST: true,
    GDPR_MIN: true,
    HASH_ONLY: true,
    FAIL_CLOSED: true,
    AUDIT_APPEND_ONLY: true
  });

  const CFG = Object.freeze({
    SUBJECT_PREFIX: "ipr-subject:",
    SUBJECT_HEX_LEN: 32,
    SECRET_MIN_LEN: 10,
    PURPOSE_MIN_LEN: 3,
    PURPOSE_MAX_LEN: 200
  });

  function nowISO(){
    return new Date().toISOString();
  }

  function setStep(n){
    for(const k of [1,2,3,4]){
      $("step"+k).style.display = (k===n) ? "block" : "none";
      $("chip-"+k).classList.toggle("on", k===n);
    }
  }

  function setStatus(el, msg, kind="warn"){
    el.className = "status " + kind;
    el.textContent = msg || "";
  }

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function stableStringify(obj){
    // JSON deterministico: ordina chiavi ricorsivamente
    const seen = new WeakSet();
    const norm = (v) => {
      if(v && typeof v === "object"){
        if(seen.has(v)) throw new Error("Cyclic object not allowed");
        seen.add(v);
        if(Array.isArray(v)) return v.map(norm);
        const keys = Object.keys(v).sort();
        const out = {};
        for(const k of keys) out[k] = norm(v[k]);
        return out;
      }
      return v;
    };
    return JSON.stringify(norm(obj));
  }

  function cleanISO2(country){
    const c = (country || "").trim().toUpperCase();
    if(!c) return null;
    // accetta solo 2 lettere (ISO3166 alpha-2)
    return /^[A-Z]{2}$/.test(c) ? c : null;
  }

  function requiredStr(v, min, max){
    const s = (v || "").trim();
    if(s.length < min) return null;
    if(max && s.length > max) return null;
    return s;
  }

  function optionalStr(v, max){
    const s = (v || "").trim();
    if(!s) return null;
    if(max && s.length > max) return s.slice(0, max);
    return s;
  }

  function contextObjFromForm(){
    const ctx = {
      country: cleanISO2($("country").value),
      region: optionalStr($("region").value, 120),
      city: optionalStr($("city").value, 120),
      district: optionalStr($("district").value, 120)
    };
    return ctx;
  }

  function contextFieldsPresent(ctx){
    return Object.entries(ctx)
      .filter(([_,v]) => !!v)
      .map(([k]) => k);
  }

  async function buildSubject(secret, purpose, issuedAt){
    // subject pseudonimo (hash): non è PII
    const h = await sha256Hex(`${secret}|${purpose}|${issuedAt}`);
    return CFG.SUBJECT_PREFIX + h.slice(0, CFG.SUBJECT_HEX_LEN);
  }

  async function buildAuditEvent(evt, at, by, subject){
    const h = await sha256Hex(`${evt}|${at}|${by}|${subject}`);
    return { evt, at, by, hash_sha256: h };
  }

  // ---------- state ----------
  let lastIPR = null;
  let lastReceipt = null;

  // ---------- wizard init ----------
  setStep(1);

  $("to2").onclick = () => {
    const purpose = requiredStr($("purpose").value, CFG.PURPOSE_MIN_LEN, CFG.PURPOSE_MAX_LEN);
    if(!purpose){
      setStatus($("s1"), `Serve uno scopo dichiarato (purpose: ${CFG.PURPOSE_MIN_LEN}-${CFG.PURPOSE_MAX_LEN} caratteri).`, "bad");
      return;
    }
    setStatus($("s1"), "OK.", "ok");
    setStep(2);
  };

  $("back1").onclick = () => setStep(1);

  $("to3").onclick = () => {
    const checked = $("consentCheck").checked;
    const days = Number($("consentDurationDays").value);
    if(!checked){
      setStatus($("s2"), "Devi confermare la comprensione del consenso per procedere.", "bad");
      return;
    }
    if(!(days>=1 && days<=3650)){
      setStatus($("s2"), "Durata consenso non valida (1–3650 giorni).", "bad");
      return;
    }
    setStatus($("s2"), "OK.", "ok");
    setStep(3);
  };

  $("back2").onclick = () => setStep(2);

  $("to4").onclick = () => {
    const secret = ($("localSecret").value || "").trim();
    if(secret.length < CFG.SECRET_MIN_LEN){
      setStatus($("s3"), `Segreto locale troppo corto: usa almeno ${CFG.SECRET_MIN_LEN} caratteri.`, "bad");
      return;
    }
    setStatus($("s3"), "OK.", "ok");
    setStep(4);
  };

  $("back3").onclick = () => setStep(3);

  // ---------- generate ----------
  $("generate").onclick = async () => {
    try{
      setStatus($("s4"), "Generazione in corso…", "warn");

      // Fail-closed validations (hard gates)
      const level = $("level").value;

      const purpose = requiredStr($("purpose").value, CFG.PURPOSE_MIN_LEN, CFG.PURPOSE_MAX_LEN);
      if(!purpose) throw new Error("purpose non valido (fail-closed).");

      const consentScope = $("consentScope").value;
      const consentDurationDays = Number($("consentDurationDays").value);
      if(!(consentDurationDays>=1 && consentDurationDays<=3650)) throw new Error("consentDurationDays non valido (fail-closed).");
      if(!$("consentCheck").checked) throw new Error("consent non acknowledged (fail-closed).");

      const secret = ($("localSecret").value || "").trim();
      if(secret.length < CFG.SECRET_MIN_LEN) throw new Error("localSecret troppo corto (fail-closed).");

      const consentNote = optionalStr($("consentNote").value, 280);
      const notes = optionalStr($("notes").value, 2000);

      const issued_at = nowISO();
      const subject = await buildSubject(secret, purpose, issued_at);

      const ctx = contextObjFromForm();
      const ctxFields = contextFieldsPresent(ctx);
      const context_hash = await sha256Hex(stableStringify(ctx));

      // Build IPR (without embedding raw context)
      const ipr = {
        proto: "AI_JOKER_C2",
        type: "IPR_PACKAGE",
        version: "v1",
        issuer: "HERMETICUM B.C.E. S.r.l.",
        seal: "HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA",
        issued_at,
        level,
        subject,
        purpose,
        policy: POLICY,
        consent: {
          scope: consentScope,
          duration_days: consentDurationDays,
          note: consentNote,
          acknowledged: true
        },
        context: {
          kind: "COARSE_GEO",
          hash_sha256: context_hash,
          fields_present: ctxFields
        },
        notes,
        audit: [
          await buildAuditEvent("EVT-IPR-ISSUED", issued_at, "CLIENT_SIDE_WIZARD", subject)
        ]
      };

      // Deterministic IPR hash for receipt linkage
      const ipr_hash_sha256 = await sha256Hex(stableStringify(ipr));

      // Receipt payload = minimal accountable linkage (no PII)
      const receipt_payload = {
        ipr_subject: subject,
        ipr_level: level,
        purpose,
        policy: POLICY,
        consent_scope: consentScope,
        issued_at,
        ipr_hash_sha256
      };

      const payload_hash_sha256 = await sha256Hex(stableStringify(receipt_payload));

      const receipt = {
        proto: "AI_JOKER_C2",
        type: "RECEIPT",
        version: "v1",
        kind: "IPR_ISSUANCE",
        issued_at,
        payload_hash_sha256,
        payload: receipt_payload,
        signature: {
          scheme: "NONE",
          kid: null,
          value: null,
          note: "Firma/timestamp non inclusi nel MVP. Step successivo: firma + anchor."
        }
      };

      // Save state + render
      lastIPR = ipr;
      lastReceipt = receipt;

      $("iprOut").textContent = JSON.stringify(ipr, null, 2);
      $("rcpOut").textContent = JSON.stringify(receipt, null, 2);

      $("downloadIpr").disabled = false;
      $("downloadReceipt").disabled = false;

      setStatus($("s4"), "OK: package generato. Scarica ipr.json e receipt.json.", "ok");
    }catch(e){
      console.error(e);
      setStatus($("s4"), "Errore (fail-closed): " + (e?.message || String(e)), "bad");
    }
  };

  $("downloadIpr").onclick = () => { if(lastIPR) downloadJSON("ipr.json", lastIPR); };
  $("downloadReceipt").onclick = () => { if(lastReceipt) downloadJSON("receipt.json", lastReceipt); };

  $("reset").onclick = () => {
    lastIPR = null; lastReceipt = null;

    $("purpose").value = "";
    $("consentNote").value = "";
    $("consentCheck").checked = false;

    $("country").value = "";
    $("region").value = "";
    $("city").value = "";
    $("district").value = "";

    $("localSecret").value = "";
    $("notes").value = "";

    $("iprOut").textContent = "—";
    $("rcpOut").textContent = "—";

    $("downloadIpr").disabled = true;
    $("downloadReceipt").disabled = true;

    setStatus($("s1"), "", "warn");
    setStatus($("s2"), "", "warn");
    setStatus($("s3"), "", "warn");
    setStatus($("s4"), "Reset completato.", "warn");

    setStep(1);
  };
})();
</script>
