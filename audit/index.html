<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>HERMETICUM — Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Audit (stile banca UE) — catena temporale prev_hash -> receipt_sha256(json). Client-side, hash-only, no data custody. Bundle unico.">

  <style>
    :root{--bg:#0b0d10;--paper:#0f1318;--text:#e7edf5;--muted:#9fb0c2;--line:rgba(255,255,255,.12);--soft:rgba(255,255,255,.06);--max:980px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.45}
    a{color:inherit;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--max);margin:0 auto;padding:0 16px}

    header{border-bottom:1px solid var(--line);background:rgba(0,0,0,.22);backdrop-filter:blur(6px)}
    .head{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 0}
    .brand{font-weight:900;letter-spacing:.9px}
    .brand small{display:block;font-weight:600;letter-spacing:.2px;color:var(--muted);font-size:12px;margin-top:2px}
    nav{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    nav a{padding:6px 8px;border-radius:10px}
    nav a:hover{background:var(--soft);color:var(--text);text-decoration:none}
    .policy{border-top:1px solid var(--line);padding:10px 0;font-size:12px;color:var(--muted)}
    .policy b{color:var(--text);font-weight:800}

    main{padding:22px 0 34px}
    .card{background:var(--paper);border:1px solid var(--line);border-radius:16px;padding:16px}
    h1{margin:0 0 6px;font-size:22px}
    .subtitle{margin:0;color:var(--muted);max-width:92ch;font-size:13px}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .section-title{margin:0 0 8px;font-size:13px;color:var(--text);letter-spacing:.2px}

    label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    input,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.22);color:var(--text);font-size:14px;outline:none
    }
    textarea{min-height:120px;resize:vertical}
    input[type="file"]{padding:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
    .row > div{flex:1;min-width:170px}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);font-size:14px;cursor:pointer
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{background:rgba(255,255,255,.06)}
    .btn.primary:hover{background:rgba(255,255,255,.09)}

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .out{
      margin-top:12px;padding:14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-family:ui-monospace,monospace;font-size:13px;
      white-space:pre-line;overflow:auto
    }

    footer{border-top:1px solid var(--line);background:rgba(0,0,0,.18);padding:18px 0 24px;color:var(--muted)}
    .sig{margin-top:10px;font-size:12px;opacity:.7;letter-spacing:.4px}
  </style>
</head>

<body>
<header>
  <div class="wrap head">
    <div class="brand">
      HERMETICUM
      <small>Audit — Catena temporale (EU-style)</small>
    </div>
    <nav>
      <a href="../">Home</a>
      <a href="../create/">Create</a>
      <a href="../verify/">Verifica</a>
      <a href="../eu/pilot/">EU Pilot</a>
      <a href="../company/">Company</a>
    </nav>
  </div>
  <div class="wrap policy">
    <b>Audit-first</b> · <b>Fail-closed</b> · <b>Hash-only</b> · <b>No data custody</b>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h1>Audit temporale</h1>
    <p class="subtitle">
      Inserisci <b>prev_hash</b> (receipt precedente). Aggiungi un evento (testo e/o file).
      Il sistema genera un nuovo record audit con <b>receipt_sha256(json)</b> e scarica un <b>bundle unico</b>.
      Nessun dato viene inviato o conservato.
    </p>

    <div class="divider"></div>

    <p class="section-title">A) Catena</p>

    <label>prev_hash (receipt_sha256(json) precedente)</label>
    <input id="prev_hash" placeholder="es. 620d9a35... (64 hex)">

    <div class="hint">
      Regola: ogni audit punta al receipt del passo prima. Questo crea la catena opponibile nel tempo.
    </div>

    <div class="divider"></div>

    <p class="section-title">B) Evento audit (opzionale, riservato)</p>

    <label>Testo evento (facoltativo)</label>
    <textarea id="note" placeholder="Nota riservata (verrà inclusa SOLO nel bundle scaricato)"></textarea>

    <label>File evidenza (facoltativo)</label>
    <input id="evidence" type="file">

    <div class="btnrow">
      <button class="btn primary" onclick="prepare()">Prepara audit (calcolo hash)</button>
    </div>

    <div id="prepout" class="out">STATO: IDLE</div>

    <div class="divider"></div>

    <p class="section-title">C) Emissione</p>

    <div class="btnrow">
      <button class="btn primary" onclick="issue()">Genera AUDIT (bundle)</button>
    </div>

    <div id="out" class="out">STATO: IDLE</div>

    <div id="dlbox" style="margin-top:12px; display:none;">
      <p class="section-title">Download manuale (fallback)</p>
      <div class="btnrow">
        <a class="btn" id="dl_bundle" href="#" download>Scarica bundle AUDIT</a>
      </div>
      <div class="hint">Se il browser blocca l’avvio automatico, usa questo pulsante.</div>
    </div>

    <div class="hint">
      In pagina mostriamo solo hash e receipt (nessun payload). Il contenuto rimane nel file scaricato.
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div>HERMETICUM — digital responsibility infrastructure</div>
    <div class="sig">HERMETICUM B.C.E. S.r.l. · EU</div>
  </div>
</footer>

<script>
let algo = "SHA-256";
let prepared = false;

let noteText = "";
let evidenceMeta = null;
let evidenceB64 = "";
let evidenceHash = ""; // sha256(file) if present
let eventHash = "";    // sha256(note) if present AND no file; else evidenceHash when file present
let eventBasis = "";   // "FILE" | "TEXT" | "EMPTY"

async function sha256Bytes(uint8){
  const buf = await crypto.subtle.digest("SHA-256", uint8);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function sha256String(text){
  const bytes = new TextEncoder().encode(text);
  return await sha256Bytes(bytes);
}
async function readFileAsBytes(file){
  const ab = await file.arrayBuffer();
  return new Uint8Array(ab);
}
function base64FromBytes(bytes){
  let binary = "";
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function normHex(s){
  return (s || "").trim().toLowerCase().replace(/^0x/,"").replace(/[^0-9a-f]/g,"");
}
function makeId(prefix, iso){
  return prefix + iso.replace(/[-:TZ.]/g,"").slice(0,14);
}

async function prepare(){
  const prepout = document.getElementById("prepout");
  prepared = false;

  noteText = (document.getElementById("note").value || "").trim();

  const f = document.getElementById("evidence").files[0];
  evidenceMeta = null;
  evidenceB64 = "";
  evidenceHash = "";
  eventHash = "";
  eventBasis = "";

  if(f){
    const bytes = await readFileAsBytes(f);
    evidenceHash = await sha256Bytes(bytes);
    evidenceMeta = { name:f.name, type:f.type || "application/octet-stream", size:f.size };
    evidenceB64 = base64FromBytes(bytes);
    eventHash = evidenceHash;
    eventBasis = "FILE";

    prepout.textContent =
      "STATO: OK\nEVENT_BASIS: FILE\nALGORITMO: " + algo +
      "\nFILE: " + evidenceMeta.name + " (" + evidenceMeta.size + " bytes)\n" +
      (noteText ? "TESTO: presente (incluso nel bundle)\n" : "TESTO: assente\n") +
      "EVENT_HASH:\n" + eventHash;
    prepared = true;
    return;
  }

  if(noteText){
    eventHash = await sha256String(noteText);
    eventBasis = "TEXT";
    prepout.textContent =
      "STATO: OK\nEVENT_BASIS: TEXT\nALGORITMO: " + algo +
      "\nEVENT_HASH:\n" + eventHash;
    prepared = true;
    return;
  }

  // nessun evento: consentito, ma dichiarato
  eventBasis = "EMPTY";
  eventHash = "0".repeat(64);
  prepout.textContent =
    "STATO: OK\nEVENT_BASIS: EMPTY\nEVENT_HASH:\n" + eventHash + "\nNOTA: audit senza evento allegato.";
  prepared = true;
}

async function issue(){
  const out = document.getElementById("out");
  const dlbox = document.getElementById("dlbox");
  dlbox.style.display = "none";

  const prev = normHex(document.getElementById("prev_hash").value);
  if(!prev || prev.length !== 64){
    out.textContent = "STATO: FAIL\nMOTIVO: prev_hash non valido (serve SHA-256 64 hex)";
    return;
  }
  if(!prepared){
    out.textContent = "STATO: FAIL\nMOTIVO: eseguire prima 'Prepara audit (calcolo hash)'";
    return;
  }

  const now = new Date().toISOString();
  const auditID = makeId("AUDIT-", now);

  // JSON audit (catena + evento)
  const payload = {
    mode: (eventBasis === "FILE" && noteText) ? "FILE+TEXT"
        : (eventBasis === "FILE" ? "FILE"
        : (eventBasis === "TEXT" ? "TEXT" : "EMPTY")),
    event_basis: eventBasis,
    event_hash: eventHash,
    note: noteText ? noteText : undefined,
    evidence: evidenceMeta ? {
      filename: evidenceMeta.name,
      mime: evidenceMeta.type,
      size: evidenceMeta.size,
      encoding: "base64",
      data: evidenceB64,
      sha256: evidenceHash
    } : undefined
  };
  if(payload.note === undefined) delete payload.note;
  if(payload.evidence === undefined) delete payload.evidence;

  const jsonObj = {
    kind: "HBCE_AUDIT_RECORD",
    version: "AUDIT-v1",
    system: "HERMETICUM",
    regime: ["AUDIT-FIRST","FAIL-CLOSED","HASH-ONLY","NO-DATA-CUSTODY"],
    audit_id: auditID,
    timestamp_utc: now,
    chain: { prev_hash: prev },
    event: {
      algorithm: algo,
      hash_basis: eventBasis,
      event_hash: eventHash
    },
    payload: payload,
    seal: { generated_by:"HERMETICUM infrastructure", signature_line:"HERMETICUM B.C.E. S.r.l. · EU" }
  };

  const jsonText = JSON.stringify(jsonObj, null, 2);
  const receipt = await sha256String(jsonText);

  // bundle unico (download singolo)
  const bundle =
`HERMETICUM AUDIT BUNDLE (single-file)
ID: ${auditID}
prev_hash: ${prev}
receipt_sha256(json): ${receipt}

===== SECTION: AUDIT.JSON =====
${jsonText}

===== SECTION: RECEIPT.SHA256.TXT =====
${receipt}
`;

  const blob = new Blob([bundle], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const filename = `${auditID}_BUNDLE.txt`;

  // fallback manuale
  dlbox.style.display = "block";
  const a = document.getElementById("dl_bundle");
  a.href = url;
  a.download = filename;

  // auto-download
  try{ a.click(); }catch(e){}

  // output in pagina: solo chain + receipt (no payload)
  out.textContent =
    "STATO: OK\n" +
    "AUDIT_ID: " + auditID + "\n" +
    "prev_hash:\n" + prev + "\n" +
    "receipt_sha256(json):\n" + receipt + "\n\n" +
    "Download automatico avviato (bundle unico).";
}
</script>

</body>
</html>
