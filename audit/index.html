<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit ‚Äî Catena append-only</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <header class="hdr">
    <div class="sym">üúè</div>
    <div class="brand">
      HERMETICUM - BLINDATA ¬∑ COMPUTABILE ¬∑ EVOLUTIVA<br />
      <strong>HERMETICUM B.C.E. S.r.l.</strong> ¬∑ UE
    </div>
    <h1>Audit ‚Äî Catena append-only</h1>
    <p class="muted">Crea receipt concatenati con prev_hash. Nessuna custodia dati: solo locale (browser).</p>
    <nav class="nav">
      <a href="../">Home</a>
      <a href="../create/">Create</a>
      <a href="../verify/">Verify</a>
      <a href="./">Audit</a>
      <a href="../architecture/">Architettura</a>
      <a href="../eu/pilot/">Pilota UE</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Nuovo step audit</h2>

      <label>prev_hash (receipt_sha256 precedente) ‚Äî opzionale</label>
      <input id="prevHash" placeholder="Se vuoto: inizio catena" />

      <label>Modalit√†</label>
      <select id="mode">
        <option value="PUBLIC">PUBLIC (solo receipt)</option>
        <option value="PRIVATE">PRIVATE (receipt + payload)</option>
      </select>

      <label>Payload (JSON)</label>
      <textarea id="payload" rows="8" placeholder='Esempio: {"azione":"step","n":1}'></textarea>

      <div class="hr"></div>
      <button class="btn" id="btnStep">Crea step</button>
      <button class="btn" id="btnClear">Pulisci storage locale</button>
      <span class="pill" id="pill">IDLE</span>

      <div class="hr"></div>

      <label>receipt generato (JSON)</label>
      <textarea id="outReceipt" rows="10" readonly></textarea>

      <div class="row">
        <button class="btn" id="btnDlReceipt">Download receipt.json</button>
        <button class="btn" id="btnDlPayload">Download payload.json (solo PRIVATE)</button>
      </div>

      <p class="small">
        Nota: la catena √® ‚Äúappend-only‚Äù perch√© ogni receipt pu√≤ includere il prev_hash del receipt precedente.
        La lista degli step viene salvata solo in <strong>localStorage</strong> del browser.
      </p>
    </section>

    <section class="card">
      <h2>Catena locale (browser)</h2>
      <div class="mono" id="chain">Nessun elemento.</div>
    </section>
  </main>

  <footer class="ftr">
    üúè HERMETICUM ‚Äî Audit (append-only) ¬∑ HERMETICUM B.C.E. S.r.l.
  </footer>

<script src="../assets/app.js"></script>
<script>
  const $ = (id) => document.getElementById(id);
  const KEY = "HBCE_AUDIT_CHAIN_V1";

  let lastReceipt = null;
  let lastPayloadObj = null;

  function loadChain(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return [];
    try { return JSON.parse(raw); } catch(e){ return []; }
  }

  function saveChain(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function renderChain(){
    const arr = loadChain();
    if(arr.length === 0){
      $("chain").textContent = "Nessun elemento.";
      return;
    }
    const lines = arr.map((x,i) =>
      `#${i+1}  ${x.receipt_sha256}\n     prev: ${x.prev_hash || "(inizio)"}\n     at:   ${x.created_at}`
    );
    $("chain").textContent = lines.join("\n\n");
  }

  function setPill(t){ $("pill").textContent = t; }

  $("btnStep").addEventListener("click", async () => {
    setPill("WORK");
    const prevHash = $("prevHash").value.trim();
    const mode = $("mode").value.trim();

    const parsed = safeParseJson($("payload").value.trim());
    if(!parsed.ok){
      setPill("FAIL");
      alert("Payload JSON non valido:\n" + parsed.error);
      return;
    }

    lastPayloadObj = parsed.value;
    const payloadCanon = canonicalStringify(lastPayloadObj);
    const payloadSha = await sha256Hex(payloadCanon);

    const receipt = await buildReceipt({ mode, payloadSha256: payloadSha, prevHash });
    lastReceipt = receipt;

    // salva in catena locale
    const chain = loadChain();
    chain.push(receipt);
    saveChain(chain);

    $("outReceipt").value = JSON.stringify(receipt, null, 2);
    $("prevHash").value = receipt.receipt_sha256; // auto-prosegue
    setPill("OK");
    renderChain();
  });

  $("btnClear").addEventListener("click", () => {
    localStorage.removeItem(KEY);
    lastReceipt = null;
    lastPayloadObj = null;
    $("outReceipt").value = "";
    $("prevHash").value = "";
    setPill("IDLE");
    renderChain();
  });

  $("btnDlReceipt").addEventListener("click", () => {
    if(!lastReceipt){ alert("Crea prima uno step."); return; }
    downloadText("receipt.json", JSON.stringify(lastReceipt, null, 2));
  });

  $("btnDlPayload").addEventListener("click", () => {
    if(!lastReceipt){ alert("Crea prima uno step."); return; }
    if($("mode").value !== "PRIVATE"){
      alert("Il payload si scarica solo in modalit√† PRIVATE.");
      return;
    }
    downloadText("payload.json", JSON.stringify(lastPayloadObj, null, 2));
  });

  renderChain();
</script>
</body>
</html>
