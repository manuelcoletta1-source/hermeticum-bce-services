<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify ‚Äî PASS/FAIL</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <header class="hdr">
    <div class="sym">üúè</div>
    <div class="brand">
      HERMETICUM - BLINDATA ¬∑ COMPUTABILE ¬∑ EVOLUTIVA<br />
      <strong>HERMETICUM B.C.E. S.r.l.</strong> ¬∑ UE
    </div>
    <h1>Verify ‚Äî Verifica deterministica (PASS/FAIL)</h1>
    <p class="muted">Hash-only. Nessuna custodia dati. Verifica receipt e (opzionale) payload.</p>
    <nav class="nav">
      <a href="../">Home</a>
      <a href="../create/">Create</a>
      <a href="./">Verify</a>
      <a href="../audit/">Audit</a>
      <a href="../architecture/">Architettura</a>
      <a href="../eu/pilot/">Pilota UE</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Input</h2>

      <label>Receipt (JSON)</label>
      <textarea id="receipt" rows="10" placeholder='Incolla receipt.json'></textarea>

      <label>Payload (JSON) ‚Äî opzionale</label>
      <textarea id="payload" rows="8" placeholder='Se lo hai, incollalo: serve a verificare anche payload_sha256'></textarea>

      <div class="hr"></div>
      <button class="btn" id="btnVerify">Verifica</button>
      <span class="pill" id="pill">IDLE</span>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Esito</label>
          <input id="outResult" readonly />
        </div>
        <div>
          <label>payload_sha256 (calcolato)</label>
          <input id="outPayloadSha" readonly />
        </div>
      </div>

      <label>expected_receipt_sha256</label>
      <input id="outExpected" readonly />

      <label>declared_receipt_sha256</label>
      <input id="outDeclared" readonly />

      <p class="small">
        PASS significa che la firma hash del receipt √® coerente con i campi e (se fornito) con il payload.
        FAIL significa che non combacia.
      </p>
    </section>
  </main>

  <footer class="ftr">
    üúè HERMETICUM ‚Äî Verify (hash-only) ¬∑ HERMETICUM B.C.E. S.r.l.
  </footer>

<script src="../assets/app.js"></script>
<script>
  const $ = (id) => document.getElementById(id);

  function setPill(t){
    $("pill").textContent = t;
  }

  $("btnVerify").addEventListener("click", async () => {
    setPill("WORK");

    const r = safeParseJson($("receipt").value.trim());
    if(!r.ok){
      setPill("FAIL");
      alert("Receipt JSON non valido:\n" + r.error);
      return;
    }

    let payloadObj = null;
    const payloadTxt = $("payload").value.trim();
    if(payloadTxt.length > 0){
      const p = safeParseJson(payloadTxt);
      if(!p.ok){
        setPill("FAIL");
        alert("Payload JSON non valido:\n" + p.error);
        return;
      }
      payloadObj = p.value;
    }

    const out = await verifyReceipt(r.value, payloadObj);

    $("outResult").value = out.pass ? "PASS" : "FAIL";
    $("outResult").className = out.pass ? "ok" : "bad";

    $("outPayloadSha").value = out.payload_sha256 || "";
    $("outExpected").value = out.expected_receipt_sha256 || "";
    $("outDeclared").value = r.value.receipt_sha256 || "";

    setPill(out.pass ? "PASS" : "FAIL");
  });
</script>
</body>
</html>
