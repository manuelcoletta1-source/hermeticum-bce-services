<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify ‚Äî Hermeticum B.C.E.</title>

  <!-- Base per GitHub Pages (root del progetto) -->
  <base href="/hermeticum-bce-platform/" />

  <link rel="stylesheet" href="assets/hbce.css" />
  <meta name="color-scheme" content="dark" />
</head>

<body>
  <header class="hbce-header">
    <div class="hbce-wrap hbce-header__inner">
      <div class="hbce-brand">
        <div class="hbce-brand__mark">üúè</div>
        <div class="hbce-brand__text">
          <div class="hbce-brand__title">HERMETICUM</div>
          <div class="hbce-brand__sub">BLINDATA ¬∑ COMPUTABILE ¬∑ EVOLUTIVA</div>
        </div>
      </div>

      <nav class="hbce-nav" aria-label="Navigazione principale">
        <a class="hbce-nav__a" href="./">Home</a>
        <a class="hbce-nav__a" href="onboarding/">Onboarding</a>
        <a class="hbce-nav__a" href="citizen/">Cittadini UE</a>
        <a class="hbce-nav__a" href="ai-joker-c2/">AI JOKER-C2</a>
        <a class="hbce-nav__a" href="institution/">Istituzioni</a>
        <a class="hbce-nav__a" href="member-states/">UE Stati Membri</a>
        <a class="hbce-nav__a" href="technology/">Tecnologia</a>
        <a class="hbce-nav__a hbce-nav__a--active" href="verify/">Verify</a>
        <a class="hbce-nav__a" href="security/">Sicurezza</a>
        <a class="hbce-nav__a" href="governance/">Governance</a>
        <a class="hbce-nav__a" href="manual/">Manuale</a>
      </nav>
    </div>
  </header>

  <main class="hbce-main">
    <section class="hbce-hero">
      <div class="hbce-wrap">
        <h1 class="hbce-h1">Verify</h1>
        <p class="hbce-lead">Deterministico ¬∑ SHA-512 ¬∑ fail-closed</p>
        <p class="hbce-kicker">PROVA MINIMA ¬∑ NIENTE ‚ÄúFORSE‚Äù</p>

        <div class="hbce-card">
          <h2 class="hbce-h2">Verifica IPR: se i file combaciano ‚Üí <span class="hbce-pass">PASS</span>. Altrimenti ‚Üí <span class="hbce-fail">FAIL</span>.</h2>
          <p class="hbce-p">
            Questa pagina scarica i file dal repository, calcola SHA-512 del canonico e confronta con il digest dichiarato.
            Se manca evidenza verificabile: <b>FAIL</b>. Una differenza minima cambia l‚Äôhash: <b>‚Äúvirgola = FAIL‚Äù</b>.
          </p>

          <div class="hbce-actions">
            <button id="run" class="hbce-btn">Esegui verifica</button>
            <a class="hbce-link" href="technology/">Capire ‚Äúvirgola=FAIL‚Äù</a>
            <a class="hbce-link" href="governance/">Limiti & responsabilit√†</a>
          </div>
        </div>

        <div class="hbce-card">
          <h3 class="hbce-h3">File verificati</h3>
          <ul class="hbce-ul">
            <li><code>ipr.canon.json</code> ‚Äî contenuto canonico (input)</li>
            <li><code>ipr.json</code> ‚Äî digest atteso (output dichiarato)</li>
          </ul>
          <p class="hbce-note">Nota: questa demo esegue la verifica SHA-512. (Firma ED25519 opzionale: non necessaria per la prova minima.)</p>
        </div>

        <div class="hbce-card">
          <h3 class="hbce-h3">Esito</h3>
          <div id="result" class="hbce-result hbce-result--idle">
            <div class="hbce-result__title">Stato: <span id="status">IDLE</span></div>
            <div class="hbce-result__meta">
              <div>mode: <b>fail-closed</b></div>
              <div>base: <code id="base"></code></div>
              <div>time: <code id="time"></code></div>
            </div>

            <hr class="hbce-hr" />

            <div class="hbce-grid">
              <div>
                <h4 class="hbce-h4">Digest calcolato (SHA-512)</h4>
                <pre id="calc" class="hbce-pre">‚Äî</pre>
              </div>
              <div>
                <h4 class="hbce-h4">Digest atteso (da ipr.json)</h4>
                <pre id="exp" class="hbce-pre">‚Äî</pre>
              </div>
            </div>

            <h4 class="hbce-h4">Log (motivi di FAIL)</h4>
            <pre id="log" class="hbce-pre">‚Äî</pre>

            <h4 class="hbce-h4">Diagnosi rapida</h4>
            <ul class="hbce-ul">
              <li>Se vedi <b>404</b>: file non esiste nel branch pubblicato (o Pages punta alla cartella sbagliata).</li>
              <li>Se vedi <b>CORS</b> o fetch bloccato: il browser non riesce a leggere (raro su GitHub Pages).</li>
              <li>Se vedi <b>Digest missing</b>: ipr.json non contiene il digest in un campo riconosciuto.</li>
              <li>Se vedi <b>MISMATCH</b>: canonico cambiato oppure digest dichiarato vecchio.</li>
            </ul>

            <p class="hbce-note"><b>Regola:</b> se manca evidenza verificabile: FAIL. ‚Äúvirgola = FAIL‚Äù.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="hbce-footer">
    <div class="hbce-wrap">
      <div class="hbce-footer__row">
        <div>
          <div class="hbce-footer__title">HERMETICUM - BLINDATA ¬∑ COMPUTABILE ¬∑ EVOLUTIVA</div>
          <div class="hbce-footer__sub">HERMETICUM B.C.E. S.r.l.</div>
        </div>
        <div class="hbce-footer__links">
          <a href="privacy/">Privacy</a>
          <a href="terms/">Termini</a>
          <a href="governance/">Governance</a>
        </div>
      </div>
      <div class="hbce-footer__note">Questo portale √® informativo e valutativo: nessun effetto giuridico automatico. Verifica deterministica, fail-closed.</div>
    </div>
  </footer>

  <script>
    // --- Helpers ---
    function nowIso() { return new Date().toISOString(); }
    function normHex(s) { return (s || "").toString().trim().toLowerCase(); }
    function isSha512Hex(s) { return /^[a-f0-9]{128}$/.test(normHex(s)); }

    function deepGet(obj, path) {
      try {
        return path.split(".").reduce((acc, k) => (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
      } catch { return undefined; }
    }

    function findAnyDigest(iprObj, rawText) {
      // 1) Campi ‚Äúclassici‚Äù (compatibilit√† massima)
      const candidates = [
        deepGet(iprObj, "digest"),
        deepGet(iprObj, "digest_hex"),
        deepGet(iprObj, "sha512"),
        deepGet(iprObj, "sha512_hex"),
        deepGet(iprObj, "expected_digest"),
        deepGet(iprObj, "hash.sha512"),
        deepGet(iprObj, "hash.digest_hex"),
        deepGet(iprObj, "hash.sha512_hex"),
        deepGet(iprObj, "hash.sha512Digest"),
      ].map(normHex).filter(Boolean);

      for (const c of candidates) {
        if (isSha512Hex(c)) return c;
      }

      // 2) Fallback: regex su JSON testuale (128 hex)
      const m = (rawText || "").match(/[A-Fa-f0-9]{128}/);
      if (m && isSha512Hex(m[0])) return normHex(m[0]);

      return null;
    }

    async function sha512HexFromText(text) {
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest("SHA-512", data);
      const bytes = Array.from(new Uint8Array(hash));
      return bytes.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function fetchJsonNoStore(path) {
      // Cache-buster forte + no-store
      const url = new URL(path, document.baseURI);
      url.searchParams.set("v", Date.now().toString());
      const res = await fetch(url.toString(), { cache: "no-store" });
      const text = await res.text();
      if (!res.ok) {
        const err = new Error("HTTP " + res.status);
        err.status = res.status;
        err.text = text;
        throw err;
      }
      let json = null;
      try { json = JSON.parse(text); } catch { json = null; }
      return { url: url.toString(), text, json };
    }

    function setState(kind, statusText) {
      const box = document.getElementById("result");
      box.classList.remove("hbce-result--idle","hbce-result--pass","hbce-result--fail");
      box.classList.add(kind === "PASS" ? "hbce-result--pass" : kind === "FAIL" ? "hbce-result--fail" : "hbce-result--idle");
      document.getElementById("status").textContent = statusText;
    }

    function logLine(arr, s) { arr.push(s); }

    // --- Main ---
    async function runVerify() {
      const base = document.baseURI;
      document.getElementById("base").textContent = base;
      document.getElementById("time").textContent = nowIso();

      const logs = [];
      setState("IDLE","RUNNING");
      document.getElementById("calc").textContent = "‚Ä¶";
      document.getElementById("exp").textContent = "‚Ä¶";
      document.getElementById("log").textContent = "‚Ä¶";

      try {
        logLine(logs, "START " + nowIso());
        logLine(logs, "BASE " + base);

        // 1) fetch canon
        const canon = await fetchJsonNoStore("ipr.canon.json");
        logLine(logs, "FETCH " + canon.url);

        // hash deterministico = SHA-512 sul testo cos√¨ come servito (byte-identical)
        const calc = await sha512HexFromText(canon.text);
        logLine(logs, "SHA-512(canon) = " + calc);

        // 2) fetch ipr.json
        const ipr = await fetchJsonNoStore("ipr.json");
        logLine(logs, "FETCH " + ipr.url);

        // estrai digest atteso
        const expected = findAnyDigest(ipr.json || {}, ipr.text);

        // debug: chiavi visibili
        if (ipr.json && typeof ipr.json === "object") {
          const topKeys = Object.keys(ipr.json).slice(0, 30).join(", ");
          logLine(logs, "IPR.TOP_KEYS = " + topKeys);
        } else {
          logLine(logs, "IPR.JSON_PARSE = FAILED (not valid JSON?)");
        }

        document.getElementById("calc").textContent = calc;
        document.getElementById("exp").textContent = expected ? expected : "‚Äî";

        if (!expected) {
          setState("FAIL","FAIL (digest missing)");
          logLine(logs, "FAIL: digest atteso non trovato in ipr.json");
          document.getElementById("log").textContent = logs.join("\n");
          return;
        }

        if (normHex(expected) !== normHex(calc)) {
          setState("FAIL","FAIL (mismatch)");
          logLine(logs, "FAIL: MISMATCH (canon != expected)");
          document.getElementById("log").textContent = logs.join("\n");
          return;
        }

        setState("PASS","PASS");
        logLine(logs, "PASS: canon matches expected digest");
        document.getElementById("log").textContent = logs.join("\n");
      } catch (e) {
        setState("FAIL","FAIL (fetch/error)");
        logLine(logs, "ERROR: " + (e && e.message ? e.message : String(e)));
        if (e && e.status) logLine(logs, "HTTP_STATUS: " + e.status);
        if (e && e.text) logLine(logs, "BODY: " + (e.text.slice(0, 300)));
        document.getElementById("log").textContent = logs.join("\n");
      }
    }

    document.getElementById("run").addEventListener("click", runVerify);
  </script>
</body>
</html>
