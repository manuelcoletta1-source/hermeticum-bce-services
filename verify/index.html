<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify — IPR deterministico (SHA-512) · PASS/FAIL</title>

  <!-- GitHub Pages project site base -->
  <base href="/hermeticum-bce-platform/">

  <link rel="stylesheet" href="assets/hbce.css" />
  <meta name="color-scheme" content="dark" />
</head>
<body>
  <header class="topbar">
    <div class="wrap nav">
      <div class="brand">
        <div class="sig" aria-hidden="true"></div>
        <div>
          <h1>Verify</h1>
          <span class="sub">Deterministico · SHA-512 · fail-closed</span>
        </div>
      </div>

      <nav class="menu" aria-label="Navigazione principale">
        <a class="pill" data-nav href="./"><strong>Home</strong></a>
        <a class="pill" data-nav href="onboarding/"><strong>Onboarding</strong></a>
        <a class="pill" data-nav href="citizen/"><strong>Cittadini UE</strong></a>
        <a class="pill" data-nav href="ai-joker-c2/"><strong>AI JOKER-C2</strong></a>
        <a class="pill" data-nav href="institution/">Istituzioni UE</a>
        <a class="pill" data-nav href="member-states/">Stati Membri</a>
        <a class="pill" data-nav href="technology/">Tecnologia</a>
        <a class="pill active" data-nav href="verify/"><strong>Verify</strong></a>
        <a class="pill" data-nav href="security/">Sicurezza</a>
        <a class="pill" data-nav href="governance/">Governance</a>
        <a class="pill" data-nav href="manual/">Manuale</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="kicker">PROVA MINIMA · NIENTE “FORSE”</div>
      <h2 class="title">Verifica IPR: se i file combaciano → PASS. Altrimenti → FAIL.</h2>
      <p class="lead">
        Questa pagina scarica i file dal repository, calcola <strong>SHA-512</strong> del canonico e confronta
        con il digest dichiarato. Se manca un file o non coincide: <strong>FAIL</strong>.
      </p>

      <div class="btnrow">
        <button id="runBtn" class="btn" type="button">Esegui verifica</button>
        <a class="btn secondary" href="technology/">Capire “virgola=FAIL”</a>
        <a class="btn ghost" href="governance/">Limiti & responsabilità</a>
      </div>
    </section>

    <section class="grid">
      <article class="card cols-12">
        <h3>File verificati</h3>
        <ul class="list">
          <li><span class="mono">ipr.canon.json</span> — contenuto canonico (input)</li>
          <li><span class="mono">ipr.json</span> — digest atteso (output dichiarato)</li>
        </ul>
        <p style="margin-top:10px; color:rgba(232,236,255,.8)">
          Nota: questa demo esegue la verifica SHA-512. (Firma ED25519 opzionale: non necessaria per la prova minima.)
        </p>
      </article>

      <article class="card cols-12">
        <h3>Esito</h3>

        <div id="statusBox" class="notice" style="border-radius:16px">
          Stato: <strong id="status">IN ATTESA</strong>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
            <span class="tag" id="tagMode">mode: fail-closed</span>
            <span class="tag" id="tagBase">base: —</span>
            <span class="tag" id="tagTime">time: —</span>
          </div>
        </div>

        <div class="grid" style="gap:12px; margin-top:12px">
          <div class="card cols-6" style="padding:14px">
            <h4 style="margin:0 0 6px">Digest calcolato (SHA-512)</h4>
            <div class="mono" id="digestCalc" style="word-break:break-all; opacity:.9">—</div>
          </div>
          <div class="card cols-6" style="padding:14px">
            <h4 style="margin:0 0 6px">Digest atteso (da ipr.json)</h4>
            <div class="mono" id="digestExpected" style="word-break:break-all; opacity:.9">—</div>
          </div>
        </div>
      </article>

      <article class="card cols-12">
        <h3>Log (motivi di FAIL)</h3>
        <pre id="log" style="margin:0; white-space:pre-wrap; color:rgba(232,236,255,.92)">—</pre>
      </article>

      <article class="card cols-12">
        <h3>Se non funziona (diagnosi rapida)</h3>
        <ul class="list">
          <li>Se vedi <strong>404</strong>: il file non esiste nel branch pubblicato (o Pages punta alla cartella sbagliata).</li>
          <li>Se vedi <strong>CORS</strong> o fetch bloccato: il browser non riesce a leggere (raro su GitHub Pages).</li>
          <li>Se vedi <strong>Digest missing</strong>: <span class="mono">ipr.json</span> non contiene il digest in un campo riconosciuto.</li>
          <li>Se vedi <strong>MISMATCH</strong>: il canonico è cambiato oppure il digest dichiarato è vecchio.</li>
        </ul>
      </article>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">
      <div class="notice">
        <strong>Regola</strong><br/>
        Se manca evidenza verificabile: FAIL.  
        Una differenza minima cambia l’hash: “virgola = FAIL”.
      </div>
    </div>
  </footer>

  <script src="assets/hbce.js"></script>
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      const runBtn = $("runBtn");
      const statusEl = $("status");
      const statusBox = $("statusBox");
      const logEl = $("log");
      const digestCalcEl = $("digestCalc");
      const digestExpectedEl = $("digestExpected");
      const tagBase = $("tagBase");
      const tagTime = $("tagTime");

      const base = document.baseURI; // respects <base href="...">
      tagBase.textContent = "base: " + base;

      function nowISO() {
        return new Date().toISOString();
      }

      function setStatus(text, kind) {
        statusEl.textContent = text;
        // kind: ok | warn | danger | neutral
        statusBox.style.border = "1px solid rgba(255,255,255,.16)";
        if (kind === "ok") statusBox.style.border = "1px solid rgba(120,255,170,.35)";
        if (kind === "danger") statusBox.style.border = "1px solid rgba(255,120,120,.35)";
        if (kind === "warn") statusBox.style.border = "1px solid rgba(255,210,120,.35)";
      }

      function log(line) {
        if (logEl.textContent === "—") logEl.textContent = "";
        logEl.textContent += line + "\n";
      }

      function hexFromArrayBuffer(buf) {
        const bytes = new Uint8Array(buf);
        let hex = "";
        for (let i = 0; i < bytes.length; i++) {
          const h = bytes[i].toString(16).padStart(2, "0");
          hex += h;
        }
        return hex;
      }

      async function fetchText(path) {
        const url = new URL(path, base).toString();
        log("FETCH " + url);
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status + " on " + path);
        }
        return await res.text();
      }

      function extractExpectedDigest(iprJsonText) {
        // Support multiple common shapes without breaking old files
        // 1) { "hash": { "algorithm": "SHA-512", "digest_hex": "..." } }
        // 2) { "digest": "..." } or { "sha512": "..." }
        // 3) { "hash": "..." } (discouraged, but tolerated)
        let obj;
        try { obj = JSON.parse(iprJsonText); }
        catch { return null; }

        const candidates = [];
        if (obj && typeof obj === "object") {
          if (obj.hash && typeof obj.hash === "object") {
            if (typeof obj.hash.digest_hex === "string") candidates.push(obj.hash.digest_hex);
            if (typeof obj.hash.digest === "string") candidates.push(obj.hash.digest);
            if (typeof obj.hash.sha512 === "string") candidates.push(obj.hash.sha512);
          }
          if (typeof obj.digest === "string") candidates.push(obj.digest);
          if (typeof obj.sha512 === "string") candidates.push(obj.sha512);
          if (typeof obj.hash === "string") candidates.push(obj.hash);
        }

        const cleaned = candidates
          .map(s => (s || "").trim().toLowerCase())
          .find(s => /^[0-9a-f]{128}$/.test(s));

        return cleaned || null;
      }

      async function sha512Hex(text) {
        if (!crypto || !crypto.subtle) {
          throw new Error("WebCrypto non disponibile: impossibile calcolare SHA-512 in questo browser.");
        }
        const data = new TextEncoder().encode(text);
        const digest = await crypto.subtle.digest("SHA-512", data);
        return hexFromArrayBuffer(digest);
      }

      async function runVerify() {
        tagTime.textContent = "time: " + nowISO();

        logEl.textContent = "—";
        digestCalcEl.textContent = "—";
        digestExpectedEl.textContent = "—";

        setStatus("IN CORSO…", "warn");
        log("START " + nowISO());
        log("BASE " + base);

        try {
          // 1) Fetch canonical file
          const canonText = await fetchText("ipr.canon.json");

          // 2) Compute SHA-512
          const calc = await sha512Hex(canonText);
          digestCalcEl.textContent = calc;
          log("SHA-512(canon) = " + calc);

          // 3) Fetch expected digest container
          const iprJsonText = await fetchText("ipr.json");
          const expected = extractExpectedDigest(iprJsonText);

          if (!expected) {
            digestExpectedEl.textContent = "—";
            log("FAIL: digest atteso non trovato in ipr.json");
            setStatus("FAIL (digest missing)", "danger");
            return;
          }

          digestExpectedEl.textContent = expected;
          log("EXPECTED = " + expected);

          // 4) Compare
          if (calc === expected) {
            log("RESULT: PASS (match)");
            setStatus("PASS", "ok");
          } else {
            log("RESULT: FAIL (mismatch)");
            log("CAUSE: ipr.canon.json e ipr.json non sono allineati (anche un solo carattere basta).");
            setStatus("FAIL (mismatch)", "danger");
          }
        } catch (err) {
          log("ERROR: " + (err && err.message ? err.message : String(err)));
          setStatus("FAIL (error)", "danger");
        }
      }

      runBtn.addEventListener("click", runVerify);

      // Auto-run once on load (user can re-run)
      window.addEventListener("load", () => {
        setStatus("PRONTO", "neutral");
        // avvio automatico per ridurre frizione
        runVerify();
      });
    })();
  </script>
</body>
</html>
