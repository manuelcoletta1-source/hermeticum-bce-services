<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify | HERMETICUM B.C.E.</title>
  <meta name="description" content="Verifica tecnica: hash, timestamp e bundle. Esiti: VALID / INVALID / INCONCLUSIVE. Nessuna narrativa, solo prova." />
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>
  <header class="wrap">
    <nav class="nav">
      <a class="brand" href="../">HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA</a>
      <div class="navlinks">
        <a href="../standards/">Standard</a>
        <a href="../research/">Ricerca (Horizon)</a>
        <a href="../phase-1/">Fase 1 (ONLY)</a>
        <a class="active" href="./">Verify</a>
        <a href="../governance/">Governance</a>
        <a href="../privacy/">Privacy</a>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>Verify (Tecnico)</h1>
      <p class="lead">
        Questo livello verifica <strong>integrità</strong> e <strong>coerenza minima</strong>.
        Non certifica identità. Non interpreta contenuti. Produce solo esiti verificabili.
      </p>
      <div class="notice">
        <strong>Esiti:</strong> VALID / INVALID / INCONCLUSIVE.
        Se manca un requisito minimo → FAIL-CLOSED (INVALID).
      </div>
      <div class="pillrow">
        <span class="pill">hash-only</span>
        <span class="pill">append-only</span>
        <span class="pill">fail-closed</span>
        <span class="pill">audit-ready</span>
      </div>
    </section>

    <section class="grid">
      <article class="card">
        <h2>1) Verifica hash (base)</h2>
        <p class="muted">
          Incolla un hash (es. SHA-256) e un riferimento (timestamp/nota). Questo tool non “controlla internet”:
          verifica struttura, formato e coerenza interna del bundle.
        </p>

        <label class="muted">Hash</label>
        <input id="hash" type="text" placeholder="es. 64 caratteri hex (SHA-256)" />

        <label class="muted" style="margin-top:10px;">Timestamp (opzionale)</label>
        <input id="ts" type="text" placeholder="es. 2026-01-27T20:00:00Z" />

        <div class="btnrow" style="margin-top:14px;">
          <button class="btn" id="checkHash">Check</button>
          <button class="btn secondary" id="reset">Reset</button>
        </div>
      </article>

      <article class="card">
        <h2>2) Evidence Bundle (consigliato)</h2>
        <p class="muted">
          Incolla un bundle JSON (es. generato da Fase 1). Il portale controlla che i campi minimi esistano
          e siano coerenti. Nessun dato sensibile richiesto.
        </p>

        <label class="muted">Evidence Bundle (JSON)</label>
        <textarea id="bundle" rows="10" placeholder='{"HRR":"...","POLICY":"...","PAYLOAD_MIN":{...}}'></textarea>

        <div class="btnrow" style="margin-top:14px;">
          <button class="btn" id="checkBundle">Validate Bundle</button>
          <a class="btn secondary" href="./schema/evidence-bundle.schema.json" target="_blank" rel="noopener">Apri Schema JSON</a>
        </div>
      </article>

      <article class="card">
        <h2>Output</h2>
        <pre id="out" class="codeblock">Pronto. Inserisci dati e verifica.</pre>
        <div class="btnrow">
          <button class="btn secondary" id="copyBtn" type="button">Copia Output</button>
          <a class="btn secondary" href="../">Torna al Gateway</a>
        </div>
      </article>

      <article class="card">
        <h2>Regola di conformità</h2>
        <p class="muted">
          Verify è “tecnico”. La definizione di evento/opponibilità sta in <a href="../standards/">Standard</a>.
          L’operatività sta in <a href="../phase-1/">Fase 1</a>. La ricerca sta in <a href="../research/">Ricerca</a>.
        </p>
      </article>
    </section>
  </main>

  <footer class="wrap foot">
    <small>HERMETICUM B.C.E. S.r.l.</small>
  </footer>

<script>
  const out = document.getElementById("out");
  const copyBtn = document.getElementById("copyBtn");

  function isHex(s) { return /^[0-9a-fA-F]+$/.test(s); }
  function looksLikeSha256(h) { return typeof h === "string" && h.length === 64 && isHex(h); }

  function emit(status, details) {
    const payload = {
      status,
      ts_utc: new Date().toISOString(),
      details
    };
    out.textContent = JSON.stringify(payload, null, 2);
  }

  document.getElementById("checkHash").addEventListener("click", () => {
    const hash = (document.getElementById("hash").value || "").trim();
    const ts = (document.getElementById("ts").value || "").trim();

    if (!hash) return emit("INCONCLUSIVE", { reason: "Missing hash" });

    if (looksLikeSha256(hash)) {
      return emit("VALID", { type: "SHA-256", hash, timestamp: ts || null });
    }
    if (isHex(hash) && hash.length >= 32) {
      return emit("INCONCLUSIVE", { reason: "Hash format not recognized as SHA-256 (still hex-like)", hash_len: hash.length, timestamp: ts || null });
    }
    return emit("INVALID", { reason: "Hash not hex or too short", timestamp: ts || null });
  });

  document.getElementById("checkBundle").addEventListener("click", () => {
    const raw = (document.getElementById("bundle").value || "").trim();
    if (!raw) return emit("INCONCLUSIVE", { reason: "Missing bundle JSON" });

    let obj;
    try { obj = JSON.parse(raw); }
    catch { return emit("INVALID", { reason: "Invalid JSON" }); }

    // Minimal fail-closed checks
    const hasHRR = typeof obj.HRR === "string" && obj.HRR.length >= 8;
    const hasPolicy = typeof obj.POLICY === "string" && obj.POLICY.length >= 3;
    const hasPayload = obj.PAYLOAD_MIN && typeof obj.PAYLOAD_MIN === "object";

    const checks = { hasHRR, hasPolicy, hasPayload };
    const missing = Object.entries(checks).filter(([,v]) => !v).map(([k]) => k);

    if (missing.length) {
      return emit("INVALID", { reason: "Fail-closed: missing required fields", missing, checks });
    }

    // Optional sanity: HRR prefix
    const prefixOk = /^HRR-(L|S)-/i.test(obj.HRR) || /^HRR/i.test(obj.HRR);
    return emit(prefixOk ? "VALID" : "INCONCLUSIVE", {
      checks,
      note: prefixOk ? "Bundle structure OK" : "Bundle OK but HRR prefix not recognized",
      hrr: obj.HRR
    });
  });

  document.getElementById("reset").addEventListener("click", () => {
    document.getElementById("hash").value = "";
    document.getElementById("ts").value = "";
    document.getElementById("bundle").value = "";
    out.textContent = "Pronto. Inserisci dati e verifica.";
  });

  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(out.textContent);
      copyBtn.textContent = "Copiato";
      setTimeout(() => (copyBtn.textContent = "Copia Output"), 900);
    } catch { /* no-op */ }
  });
</script>
</body>
</html>
