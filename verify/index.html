<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify — Evento Hash-Only | Hermeticum B.C.E.</title>
  <meta name="description" content="Verifica evento hash-only: parsing JSON, checks fail-closed, policy UE-first/GDPR-min, controllo SHA-256 locale opzionale." />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;background:#0d1117;color:#e6edf3;line-height:1.6}
    header,main,footer{max-width:1100px;margin:auto;padding:2.5rem 1.5rem}
    .box{border:1px solid #30363d;border-radius:12px;padding:1.5rem;background:#0d1117}
    h1{font-size:2rem;margin:0 0 .5rem}
    h2{margin:0 0 .75rem}
    p,label{color:#9da7b1}
    textarea,input{
      width:100%;box-sizing:border-box;background:#161b22;color:#e6edf3;border:1px solid #30363d;border-radius:10px;
      padding:.8rem;font-size:1rem;outline:none
    }
    textarea{min-height:210px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .btns{display:flex;flex-wrap:wrap;gap:.75rem;margin-top:1rem}
    button{
      background:#238636;border:1px solid #2ea043;color:#fff;border-radius:10px;padding:.7rem 1rem;
      cursor:pointer;font-weight:600
    }
    button.secondary{background:#161b22;border:1px solid #30363d;color:#e6edf3}
    pre{
      background:#161b22;border:1px solid #30363d;border-radius:12px;padding:1rem;overflow:auto
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .ok{border-left:3px solid #2ea043;padding-left:1rem}
    .bad{border-left:3px solid #f85149;padding-left:1rem}
    .note{font-size:.95rem;color:#8b949e}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #30363d;color:#9da7b1;font-size:.85rem;margin-right:.4rem}
  </style>
</head>

<body>
<header>
  <span class="badge">UE-FIRST</span>
  <span class="badge">GDPR-MIN</span>
  <span class="badge">HASH-ONLY</span>
  <span class="badge">FAIL-CLOSED</span>

  <h1>Verify — Evento Hash-Only</h1>
  <p>
    Verifica locale di un evento (JSON): parsing, coerenza struttura, policy, territorio e formato hash.
    Se possiedi il payload off-chain, puoi ricalcolare lo SHA-256 localmente e confrontarlo.
  </p>
</header>

<main class="grid">
  <section class="box">
    <h2>1) Incolla evento JSON</h2>
    <label for="eventJson">Evento (JSON)</label>
    <textarea id="eventJson" class="mono" placeholder='Incolla qui l’evento generato da /create...'></textarea>

    <div class="btns">
      <button id="verifyBtn">Verifica evento</button>
      <button id="loadSampleBtn" class="secondary">Carica esempio</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <p class="note">
      Questa pagina non invia dati a server. Tutto resta nel browser.
    </p>
  </section>

  <section class="box">
    <h2>2) Payload off-chain (opzionale)</h2>
    <label for="payload">Payload off-chain (testo/JSON) — usato solo per ricalcolare SHA-256</label>
    <textarea id="payload" class="mono" placeholder="Se hai il payload originale, incollalo qui."></textarea>

    <div class="btns">
      <button id="rehashBtn" class="secondary">Ricalcola SHA-256 payload</button>
      <button id="compareBtn" class="secondary">Confronta con evento</button>
    </div>

    <pre id="payloadOut" class="mono">{}</pre>
  </section>

  <section class="box" style="grid-column:1/-1">
    <h2>Risultato verifica (fail-closed)</h2>
    <pre id="report" class="mono">{}</pre>
    <p class="note">
      “VALID” significa: struttura coerente + policy presenti + campi minimi OK.
      Non significa “identità vera”: quella resta nel dominio biologico e nel tuo off-chain.
    </p>
  </section>
</main>

<footer>
  <p class="note">
    HERMETICUM — BLINDATA · COMPUTABILE · EVOLUTIVA<br/>
    HERMETICUM B.C.E. S.r.l. — Verify (hash-only)
  </p>
</footer>

<script>
  const $ = (id) => document.getElementById(id);

  async function sha256Hex(text) {
    const enc = new TextEncoder();
    const data = enc.encode(text);
    const digest = await crypto.subtle.digest("SHA-256", data);
    const bytes = new Uint8Array(digest);
    return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function isISODate(s) {
    const d = new Date(s);
    return !isNaN(d.getTime()) && typeof s === "string" && s.includes("T");
  }

  function fail(msg, details = {}) {
    return { status: "REJECTED", reason: msg, ...details };
  }

  function ok(details = {}) {
    return { status: "VALID", ...details };
  }

  function requiredPolicySet() {
    return ["UE-FIRST", "GDPR-MIN", "HASH-ONLY", "FAIL-CLOSED"];
  }

  function hasAllPolicies(arr) {
    if (!Array.isArray(arr)) return false;
    const set = new Set(arr);
    return requiredPolicySet().every(p => set.has(p));
  }

  function validHashFormat(s) {
    // expected: "SHA-256:" + 64 hex
    if (typeof s !== "string") return false;
    if (!s.startsWith("SHA-256:")) return false;
    const hex = s.slice("SHA-256:".length);
    return /^[0-9a-f]{64}$/i.test(hex);
  }

  function minimalEventCheck(evt) {
    if (!evt || typeof evt !== "object") return fail("Evento non valido: JSON non oggetto.");

    const needed = ["event_type", "territory", "subject_ref", "payload_hash", "timestamp", "policy"];
    for (const k of needed) {
      if (!(k in evt)) return fail("FAIL-CLOSED: campo mancante.", { missing: k });
    }

    if (typeof evt.event_type !== "string" || !evt.event_type.trim()) return fail("FAIL-CLOSED: event_type non valido.");
    if (typeof evt.subject_ref !== "string" || !evt.subject_ref.trim()) return fail("FAIL-CLOSED: subject_ref non valido.");

    const t = evt.territory;
    if (!t || typeof t !== "object") return fail("FAIL-CLOSED: territory non valido.");
    const tk = ["country", "region", "city", "district"];
    for (const k of tk) {
      if (typeof t[k] !== "string" || !t[k].trim()) return fail("FAIL-CLOSED: territory incompleto.", { missing: "territory."+k });
    }

    if (!isISODate(evt.timestamp)) return fail("FAIL-CLOSED: timestamp non ISO-8601 valido.", { timestamp: evt.timestamp });

    if (!validHashFormat(evt.payload_hash)) return fail("FAIL-CLOSED: payload_hash formato non valido.", { payload_hash: evt.payload_hash });

    if (!hasAllPolicies(evt.policy)) return fail("FAIL-CLOSED: policy non completa.", { expected: requiredPolicySet(), got: evt.policy });

    return ok({
      event_type: evt.event_type,
      territory: t,
      subject_ref: evt.subject_ref,
      payload_hash: evt.payload_hash,
      timestamp: evt.timestamp,
      signature: evt.signature ?? null
    });
  }

  function pretty(o) { return JSON.stringify(o, null, 2); }

  $("verifyBtn").addEventListener("click", () => {
    const raw = $("eventJson").value.trim();
    if (!raw) { $("report").textContent = pretty(fail("FAIL-CLOSED: evento vuoto.")); return; }

    try {
      const evt = JSON.parse(raw);
      const rep = minimalEventCheck(evt);
      $("report").textContent = pretty(rep);
      $("report").className = "mono " + (rep.status === "VALID" ? "ok" : "bad");
    } catch (e) {
      const rep = fail("JSON non parsabile.", { error: String(e) });
      $("report").textContent = pretty(rep);
      $("report").className = "mono bad";
    }
  });

  $("rehashBtn").addEventListener("click", async () => {
    const payload = $("payload").value || "";
    const h = await sha256Hex(payload);
    $("payloadOut").textContent = pretty({ payload_hash: "SHA-256:" + h });
  });

  $("compareBtn").addEventListener("click", async () => {
    const raw = $("eventJson").value.trim();
    if (!raw) { $("report").textContent = pretty(fail("Serve un evento JSON per confrontare.")); $("report").className="mono bad"; return; }

    let evt;
    try { evt = JSON.parse(raw); }
    catch (e) { $("report").textContent = pretty(fail("Evento JSON non parsabile.", { error: String(e) })); $("report").className="mono bad"; return; }

    const base = minimalEventCheck(evt);
    if (base.status !== "VALID") { $("report").textContent = pretty(base); $("report").className="mono bad"; return; }

    const payload = $("payload").value || "";
    const h = await sha256Hex(payload);
    const calc = "SHA-256:" + h;

    const match = (calc.toLowerCase() === String(evt.payload_hash).toLowerCase());
    const rep = match
      ? ok({ check: "PAYLOAD_HASH_MATCH", calculated: calc, event: evt.payload_hash })
      : fail("PAYLOAD_HASH_MISMATCH", { calculated: calc, event: evt.payload_hash });

    $("report").textContent = pretty(rep);
    $("report").className = "mono " + (rep.status === "VALID" ? "ok" : "bad");
  });

  $("loadSampleBtn").addEventListener("click", () => {
    const sample = {
      event_type: "CITIZEN_NODE_REQUEST",
      territory: { country: "IT", region: "Piemonte", city: "Torino", district: "Barriera di Milano" },
      subject_ref: "IPR-3",
      payload_hash: "SHA-256:" + "0".repeat(64),
      timestamp: new Date().toISOString(),
      signature: null,
      policy: ["UE-FIRST","GDPR-MIN","HASH-ONLY","FAIL-CLOSED"]
    };
    $("eventJson").value = JSON.stringify(sample, null, 2);
    $("report").textContent = "{}";
    $("report").className = "mono";
  });

  $("resetBtn").addEventListener("click", () => {
    $("eventJson").value = "";
    $("payload").value = "";
    $("payloadOut").textContent = "{}";
    $("report").textContent = "{}";
    $("report").className = "mono";
  });
</script>
</body>
</html>
