<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifica IPR — HERMETICUM B.C.E.</title>
  <meta name="description" content="Verifica tecnica di un IPR: coerenza manifest, integrità hash, esito standard (valid/invalid/inconclusive) con fail-closed.">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#0b0b0b;color:#e6e6e6;line-height:1.6}
    header,section{max-width:1100px;margin:auto;padding:2.5rem 1rem}
    header{padding-top:3.5rem}
    h1{font-size:2.2rem;margin:0 0 .5rem}
    .sub{opacity:.85}
    .badge{display:inline-block;border:1px solid #444;border-radius:999px;padding:.15rem .6rem;font-size:.85rem;opacity:.9}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.2rem;margin-top:1.5rem}
    .card{border:1px solid #222;background:#111;border-radius:6px;padding:1.25rem}
    a{color:#9ad}
    textarea,input{width:100%;background:#0f0f0f;color:#e6e6e6;border:1px solid #222;border-radius:6px;padding:10px;box-sizing:border-box}
    label{display:block;margin:.75rem 0 .25rem;opacity:.9}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.75rem}
    button{background:#111;color:#fff;border:1px solid #444;border-radius:4px;padding:.7rem 1.1rem;cursor:pointer;font-weight:600}
    button.primary{border-color:#888}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .line{height:1px;background:#222;margin:1.2rem 0}
    .status{padding:.6rem .9rem;border:1px solid #444;border-radius:6px;display:inline-block}
    .hint{opacity:.85;font-size:.95rem}
  </style>
</head>
<body>

<header>
  <div class="badge">Verify / IPR</div>
  <h1>Verifica IPR</h1>
  <p class="sub">
    Verifica tecnica della coerenza e integrità di un IPR (manifest + hash).
    Regola: se qualcosa non torna → <strong>fail-closed</strong>.
  </p>

  <div style="margin-top:1rem;">
    <a href="../create/">Create</a> ·
    <a href="../create/success.html">Output IPR</a> ·
    <a href="../evidence/">Evidence</a> ·
    <a href="../terms/">Termini</a> ·
    <a href="../">Home</a>
  </div>
</header>

<section>
  <h2>Input</h2>
  <div class="grid">
    <div class="card">
      <h3>Manifest IPR</h3>
      <p class="hint">Precaricato automaticamente se presente nel browser (localStorage).</p>
      <textarea id="manifest" placeholder="Incolla qui il manifest IPR..."></textarea>

      <div class="row">
        <button class="primary" id="loadLocal">Carica dal browser</button>
        <button id="clearLocal">Pulisci</button>
      </div>
    </div>

    <div class="card">
      <h3>Contenuto (opzionale)</h3>
      <p class="hint">
        Se incolli lo stesso contenuto usato in Create, possiamo ricalcolare l’hash e verificare l’integrità.
        Se non lo fornisci, la verifica sarà <strong>Inconclusive</strong> sull’integrità del contenuto.
      </p>
      <textarea id="content" placeholder="Incolla qui il contenuto originale (opzionale)..."></textarea>
    </div>

    <div class="card">
      <h3>Esito</h3>
      <div id="result" class="status">—</div>
      <div class="line"></div>
      <div class="hint" id="details">Nessuna verifica eseguita.</div>

      <div class="row">
        <button class="primary" id="verifyBtn">Esegui verifica</button>
        <button id="saveManifest">Salva manifest nel browser</button>
      </div>
    </div>
  </div>
</section>

<section>
  <h2>Esiti standard</h2>
  <div class="grid">
    <div class="card">
      <h3>Valid</h3>
      <p>Manifest coerente e (se fornito il contenuto) hash verificato.</p>
    </div>
    <div class="card">
      <h3>Invalid</h3>
      <p>Mancanze o mismatch (schema, campi obbligatori, hash non coincide).</p>
    </div>
    <div class="card">
      <h3>Inconclusive</h3>
      <p>Dati insufficienti (es. contenuto non fornito): non accettare come prova in audit.</p>
    </div>
  </div>
</section>

<footer style="margin-top:4rem;padding:2rem 1rem;border-top:1px solid #222;font-size:0.9rem;opacity:0.85;">
  <div style="max-width:1100px;margin:auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;">
    <div>
      <strong>HERMETICUM B.C.E.</strong><br>
      HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA<br>
      <span class="sub">HERMETICUM B.C.E. S.r.l.</span>
    </div>
    <div>
      <a href="../legal/privacy.html">Privacy</a><br>
      <a href="../legal/cookies.html">Cookies</a><br>
      <a href="../legal/accessibility.html">Accessibility</a>
    </div>
    <div>
      <a href="../legal/legal-notice.html">Legal notice</a><br>
      <a href="../legal/contact.html">Contact</a>
    </div>
    <div>
      Platform status: <strong>Experimental</strong><br>
      Jurisdiction: <strong>EU</strong>
    </div>
  </div>
</footer>

<script>
  const manifestEl = document.getElementById("manifest");
  const contentEl  = document.getElementById("content");
  const resultEl   = document.getElementById("result");
  const detailsEl  = document.getElementById("details");

  function setResult(state, msg) {
    resultEl.textContent = state;
    detailsEl.textContent = msg || "";
  }

  function safeGetLocalManifest() {
    try {
      return localStorage.getItem("hbce_ipr_manifest") || "";
    } catch(e) { return ""; }
  }

  function loadFromLocal() {
    const saved = safeGetLocalManifest();
    if (saved && saved.trim().length > 0) {
      manifestEl.value = saved;
      setResult("—", "Manifest caricato dal browser.");
    } else {
      alert("Nessun manifest trovato nel browser (localStorage).");
    }
  }

  function clearAll() {
    manifestEl.value = "";
    contentEl.value = "";
    setResult("—", "Pulito.");
  }

  function saveManifestLocal() {
    const txt = manifestEl.value.trim();
    if (!txt) return alert("Manifest vuoto: nulla da salvare.");
    localStorage.setItem("hbce_ipr_manifest", txt);
    localStorage.setItem("hbce_ipr_saved_at", new Date().toISOString());
    alert("Manifest salvato nel browser.");
  }

  async function sha256(str) {
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function parseManifest(txt) {
    try {
      return { ok: true, data: JSON.parse(txt) };
    } catch (e) {
      return { ok: false, err: "Manifest non è JSON valido." };
    }
  }

  function validateSchema(m) {
    // Schema minimo per HBCE-IPR-1 (coerente con create)
    const required = ["schema", "title", "hash_sha256", "released_at", "jurisdiction", "status"];
    for (const k of required) {
      if (!(k in m)) return { ok: false, err: "Campo mancante: " + k };
      if (typeof m[k] !== "string" || m[k].trim().length === 0) return { ok: false, err: "Campo vuoto/non valido: " + k };
    }
    if (m.schema !== "HBCE-IPR-1") return { ok: false, err: "Schema non riconosciuto: " + m.schema };
    if (m.jurisdiction !== "EU") return { ok: false, err: "Jurisdiction non valida: " + m.jurisdiction };
    if (!/^([a-f0-9]{64})$/i.test(m.hash_sha256)) return { ok: false, err: "hash_sha256 non è un SHA-256 valido." };
    return { ok: true };
  }

  async function verify() {
    const mtxt = manifestEl.value.trim();
    if (!mtxt) {
      setResult("Invalid", "Manifest mancante.");
      return;
    }

    const parsed = parseManifest(mtxt);
    if (!parsed.ok) {
      setResult("Invalid", parsed.err);
      return;
    }

    const m = parsed.data;
    const schema = validateSchema(m);
    if (!schema.ok) {
      setResult("Invalid", schema.err);
      return;
    }

    const content = contentEl.value.trim();

    // Se non ho contenuto, non posso verificare integrità del contenuto → Inconclusive
    if (!content) {
      setResult(
        "Inconclusive",
        "Manifest coerente. Integrità del contenuto NON verificabile: contenuto originale non fornito (fail-closed in audit)."
      );
      return;
    }

    const h = await sha256(content);
    if (h.toLowerCase() !== String(m.hash_sha256).toLowerCase()) {
      setResult("Invalid", "Mismatch hash: contenuto non corrisponde al manifest (fail-closed).");
      return;
    }

    setResult("Valid", "Manifest coerente e hash verificato: integrità confermata.");
  }

  // Autoload all’apertura pagina
  (function autoLoad() {
    const saved = safeGetLocalManifest();
    if (saved && saved.trim().length > 0) {
      manifestEl.value = saved;
      setResult("—", "Manifest precaricato dal browser. Premi “Esegui verifica”.");
    }
  })();

  document.getElementById("loadLocal").addEventListener("click", loadFromLocal);
  document.getElementById("clearLocal").addEventListener("click", clearAll);
  document.getElementById("saveManifest").addEventListener("click", saveManifestLocal);
  document.getElementById("verifyBtn").addEventListener("click", verify);
</script>

</body>
</html>
