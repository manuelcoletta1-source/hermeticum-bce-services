<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <base href="/hermeticum-bce-platform/" />

  <title>Verify — PASS/FAIL (ex-ante)</title>
  <meta name="description" content="Verify: controlla coerenza tra ipr.canon.json e ipr.json (SHA-512). Se non allineati: FAIL. Hash-only, fail-closed, audit-first, no custody." />

  <link rel="stylesheet" href="../assets/hbce.css" />
  <style>
    .hbce-wrap{max-width:980px;margin:0 auto;padding:28px 18px}
    .hbce-top{border-bottom:1px solid rgba(255,255,255,.12);padding:18px}
    .hbce-top__inner{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hbce-brand__name{font-weight:800;letter-spacing:.3px}
    .hbce-brand__sub{opacity:.82}
    .hbce-nav a{margin-right:10px;text-decoration:none;opacity:.9}
    .hbce-nav a:hover{text-decoration:underline;opacity:1}
    .hbce-banner{margin:16px 0;padding:10px 12px;border:1px solid rgba(255,255,255,.14);border-radius:14px}
    .hbce-hr{border:0;height:1px;background:rgba(255,255,255,.12);margin:22px 0}
    .hbce-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    .hbce-card{grid-column:span 6;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
    @media(max-width:820px){.hbce-card{grid-column:span 12}}
    .hbce-muted{opacity:.82}
    .hbce-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .hbce-btn{display:inline-block;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);text-decoration:none;font-weight:600;cursor:pointer;background:transparent;color:inherit}
    .hbce-btn:hover{border-color:rgba(255,255,255,.35)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    pre{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;overflow:auto}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hbce-field{display:block;margin:10px 0}
    .hbce-field label{display:block;font-weight:650;margin-bottom:6px}
    .hbce-field textarea,.hbce-field input{
      width:100%; box-sizing:border-box; padding:10px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.15); color:inherit
    }
    .hbce-field textarea{min-height:140px; resize:vertical}
    .status{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-weight:800}
    .PASS{border-color:rgba(120,255,160,.55)}
    .FAIL{border-color:rgba(255,120,120,.55)}
    .hbce-footer{border-top:1px solid rgba(255,255,255,.12);padding:18px;opacity:.9}
    .small{font-size:.92rem}
  </style>
</head>

<body>
  <header class="hbce-top">
    <div class="hbce-top__inner">
      <div>
        <div class="hbce-brand__name">HERMETICUM</div>
        <div class="hbce-brand__sub">Verify · PASS/FAIL · coerenza canonico/digest</div>
      </div>

      <nav class="hbce-nav" aria-label="Navigazione">
        <a href="../">Home</a>
        <a href="../architecture/">Architecture</a>
        <a href="../modules/">IPR Stack</a>
        <a href="../gate/">Gate</a>
        <a href="../datacenter/">DataCenter</a>
        <a href="../use-cases/">Use-Cases</a>
        <a href="../governance/">Governance</a>
        <a href="../professional/">Company</a>
        <a href="./">Verify</a>
      </nav>
    </div>
  </header>

  <main class="hbce-wrap">
    <div class="hbce-banner">
      <strong>PUBLIC PILOT</strong> · NO DATA CUSTODY · HASH-ONLY · FAIL-CLOSED · AUDIT-FIRST
    </div>

    <h1>Verify — controllo di coerenza (ex-ante)</h1>

    <p>
      Verify controlla la coerenza tra <code>ipr.canon.json</code> e <code>ipr.json</code>.
      Se il digest SHA-512 calcolato sul canonico non coincide con il digest dichiarato → <strong>FAIL</strong>.
    </p>

    <p class="hbce-muted small">
      Regola unica: <strong>in assenza di prova verificabile → FAIL</strong>. Nessun fallback permissivo.
    </p>

    <div class="hbce-cta">
      <button class="hbce-btn" id="btn-auto">Auto-check (repo)</button>
      <button class="hbce-btn" id="btn-manual">Manual-check (incolla)</button>
      <a class="hbce-btn" href="../create/">Vai a Create</a>
      <a class="hbce-btn" href="../technology/">Specifica PASS/FAIL</a>
    </div>

    <hr class="hbce-hr" />

    <h2>Esito</h2>
    <p>
      Stato: <span id="status" class="status">—</span>
    </p>

    <h3>Dettagli</h3>
    <pre class="mono" id="details">—</pre>

    <hr class="hbce-hr" />

    <h2>Auto-check (dal repo)</h2>
    <div class="hbce-grid">
      <section class="hbce-card">
        <h3>File attesi in root</h3>
        <ul>
          <li><code>/ipr.canon.json</code></li>
          <li><code>/ipr.json</code></li>
        </ul>
        <p class="hbce-muted small">
          Se uno dei due file non è raggiungibile via GitHub Pages → FAIL (fail-closed).
        </p>
      </section>

      <section class="hbce-card">
        <h3>Digest calcolato</h3>
        <pre class="mono" id="calcDigest">—</pre>
        <h3>Digest dichiarato</h3>
        <pre class="mono" id="declDigest">—</pre>
      </section>
    </div>

    <hr class="hbce-hr" />

    <h2>Manual-check (incolla)</h2>
    <p class="hbce-muted small">
      Utile se stai lavorando offline o se vuoi validare un draft prima del commit.
    </p>

    <div class="hbce-grid">
      <section class="hbce-card">
        <div class="hbce-field">
          <label for="canonInput">ipr.canon.json (incolla qui)</label>
          <textarea id="canonInput" class="mono" placeholder='{"schema":"HBCE-IPR-CANON-v1", ... }'></textarea>
        </div>
      </section>

      <section class="hbce-card">
        <div class="hbce-field">
          <label for="digestInput">digest atteso (SHA-512 hex)</label>
          <input id="digestInput" class="mono" placeholder="es: da1564..." />
        </div>
        <p class="hbce-muted small">
          Nota: qui verifichiamo <em>coerenza</em>. Se incolli un canonico diverso → digest diverso → FAIL.
        </p>
      </section>
    </div>

    <hr class="hbce-hr" />

    <h2>Chiusura</h2>
    <p>
      Create produce un draft locale. Verify dimostra la coerenza.  
      Se canonico e digest non sono allineati: <strong>FAIL</strong>.
    </p>

    <hr class="hbce-hr" />

    <h2>Firma</h2>
    <p>
      <strong>HERMETICUM – BLINDATA · COMPUTABILE · EVOLUTIVA</strong><br />
      <strong>HERMETICUM B.C.E. S.r.l.</strong><br />
      Torino · Unione Europea
    </p>
  </main>

  <footer class="hbce-footer">
    <div class="hbce-muted">
      PUBLIC PILOT · NO DATA CUSTODY · HASH-ONLY · FAIL-CLOSED · AUDIT-FIRST
    </div>
  </footer>

  <script src="../assets/hbce.js" defer></script>

  <script>
    async function sha512Hex(str) {
      const enc = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-512", enc);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function setStatus(val, msg) {
      const el = document.getElementById("status");
      el.textContent = val;
      el.classList.remove("PASS","FAIL");
      if (val === "PASS") el.classList.add("PASS");
      if (val === "FAIL") el.classList.add("FAIL");
      document.getElementById("details").textContent = msg || "—";
    }

    // Stringify deterministico per lo schema canonico (stesso criterio di Create demo)
    function stableCanonStringify(obj) {
      const ordered = {
        context_fingerprint: obj.context_fingerprint,
        created_at: obj.created_at,
        limits: obj.limits,
        policy: obj.policy,
        schema: obj.schema,
        scope: obj.scope,
        subject: obj.subject,
        type: obj.type
      };
      return JSON.stringify(ordered, null, 2);
    }

    function failClosed(reason) {
      setStatus("FAIL", reason);
      document.getElementById("calcDigest").textContent = "—";
      document.getElementById("declDigest").textContent = "—";
    }

    async function autoCheck() {
      try {
        setStatus("—", "Auto-check in corso…");

        const canonRes = await fetch("../ipr.canon.json", { cache: "no-store" });
        if (!canonRes.ok) return failClosed("FAIL: /ipr.canon.json non raggiungibile (HTTP " + canonRes.status + ").");

        const digestRes = await fetch("../ipr.json", { cache: "no-store" });
        if (!digestRes.ok) return failClosed("FAIL: /ipr.json non raggiungibile (HTTP " + digestRes.status + ").");

        const canonObj = await canonRes.json();
        const digestObj = await digestRes.json();

        // Validazioni minime (fail-closed)
        if (!canonObj || canonObj.type !== "IPR_CANONICAL") return failClosed("FAIL: ipr.canon.json non valido (type atteso: IPR_CANONICAL).");
        if (!canonObj.schema) return failClosed("FAIL: ipr.canon.json senza schema.");
        if (!digestObj || digestObj.type !== "IPR_DIGEST") return failClosed("FAIL: ipr.json non valido (type atteso: IPR_DIGEST).");
        if (!digestObj.hash || digestObj.hash.algorithm !== "SHA-512" || !digestObj.hash.digest_hex) return failClosed("FAIL: ipr.json senza hash SHA-512.");

        const canonStr = stableCanonStringify(canonObj);
        const calc = await sha512Hex(canonStr);
        const decl = String(digestObj.hash.digest_hex).toLowerCase();

        document.getElementById("calcDigest").textContent = calc;
        document.getElementById("declDigest").textContent = decl;

        if (calc === decl) {
          setStatus("PASS", "PASS: digest calcolato == digest dichiarato. Esecuzione tecnicamente ammissibile (ex-ante).");
        } else {
          setStatus("FAIL", "FAIL: digest calcolato != digest dichiarato. Canonico e digest non sono allineati.");
        }
      } catch (e) {
        failClosed("FAIL: errore runtime in Verify (fail-closed). Dettaglio: " + (e && e.message ? e.message : String(e)));
      }
    }

    async function manualCheck() {
      try {
        setStatus("—", "Manual-check in corso…");
        const canonText = document.getElementById("canonInput").value.trim();
        const expected = document.getElementById("digestInput").value.trim().toLowerCase();

        if (!canonText) return failClosed("FAIL: canonico vuoto.");
        if (!expected) return failClosed("FAIL: digest atteso vuoto.");

        let canonObj;
        try { canonObj = JSON.parse(canonText); }
        catch { return failClosed("FAIL: canonico non è JSON valido."); }

        if (!canonObj || canonObj.type !== "IPR_CANONICAL") return failClosed("FAIL: canonico non valido (type atteso: IPR_CANONICAL).");

        const canonStr = stableCanonStringify(canonObj);
        const calc = await sha512Hex(canonStr);

        document.getElementById("calcDigest").textContent = calc;
        document.getElementById("declDigest").textContent = expected;

        if (calc === expected) {
          setStatus("PASS", "PASS: digest calcolato == digest atteso (manual-check).");
        } else {
          setStatus("FAIL", "FAIL: digest calcolato != digest atteso (manual-check).");
        }
      } catch (e) {
        failClosed("FAIL: errore runtime in Manual-check (fail-closed). Dettaglio: " + (e && e.message ? e.message : String(e)));
      }
    }

    document.getElementById("btn-auto").addEventListener("click", autoCheck);
    document.getElementById("btn-manual").addEventListener("click", manualCheck);

    // Opzionale: auto-run all'apertura per dare subito un esito
    autoCheck();
  </script>
</body>
</html>
