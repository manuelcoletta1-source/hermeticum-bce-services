<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verify / IPR — HERMETICUM B.C.E.</title>
  <meta name="description" content="Verifica un IPR: controlla struttura del manifest e (se disponibile) ricalcola SHA-256 per confermare integrità. Fail-closed." />
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1620; --muted:#9fb0c3; --text:#e9f1fb; --line:#1b2735;
      --accent:#7dd3fc; --good:#a7f3d0; --bad:#fca5a5; --warn:#fde68a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    a{color:inherit}
    .wrap{max-width:1040px;margin:0 auto;padding:22px 16px}
    .nav{display:flex;gap:10px;flex-wrap:wrap;border:1px solid var(--line);background:rgba(255,255,255,.02);padding:12px 14px;border-radius:16px}
    .pill{border:1px solid var(--line);background:rgba(255,255,255,.02);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    h1{margin:14px 0 6px;font-size:24px}
    p{margin:0 0 10px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media (min-width:980px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
    .card{border:1px solid var(--line);background:var(--card);border-radius:18px;padding:14px}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px}
    textarea,input{
      width:100%; border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text);
      padding:10px 10px; border-radius:14px; outline:none;
    }
    textarea{min-height:190px; resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button,.btn{
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text);
      padding:10px 12px; border-radius:14px; cursor:pointer; text-decoration:none; display:inline-flex;align-items:center;gap:8px;
    }
    button.primary{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.10)}
    .mini{font-size:12px;color:var(--muted)}
    .status{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.02)}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .tag.valid{border-color:rgba(167,243,208,.35);background:rgba(167,243,208,.08);color:var(--good)}
    .tag.invalid{border-color:rgba(252,165,165,.35);background:rgba(252,165,165,.08);color:var(--bad)}
    .tag.incon{border-color:rgba(253,230,138,.35);background:rgba(253,230,138,.08);color:var(--warn)}
    pre{
      margin:10px 0 0; padding:12px; border-radius:16px; border:1px solid var(--line);
      background:rgba(0,0,0,.18); overflow:auto; color:var(--text); font-size:12px;
    }
    footer{margin-top:14px;color:var(--muted);text-align:center}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="nav">
      <span class="pill"><a href="../create/">Create</a></span>
      <span class="pill"><a href="../evidence/">Evidence</a></span>
      <span class="pill"><a href="../professional/">Professional</a></span>
      <span class="pill"><a href="../">Home</a></span>
      <span class="pill">fail-closed</span>
    </div>

    <h1>Verifica un IPR</h1>
    <p>
      Verifica = confronto riproducibile. Nessuna promessa, nessuna autorità: solo coerenza tra <b>manifest</b> e <b>hash</b>.
      Esito: <b>Valid / Invalid / Inconclusive</b>.
    </p>

    <div class="grid cols-2">
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">1) Manifest</h2>
        <p class="mini">Incolla il manifest JSON oppure carica un file .json. (Prefill automatico se arrivi da Create/Output.)</p>

        <label>Carica manifest (.json)</label>
        <input id="fileManifest" type="file" accept=".json,application/json" />

        <label>Manifest (JSON)</label>
        <textarea id="taManifest" placeholder="{ ... }"></textarea>

        <div class="btns">
          <button id="btnPrefill">Prefill da browser</button>
          <button id="btnClearManifest">Pulisci</button>
        </div>

        <div class="mini" style="margin-top:8px">
          Campi attesi (minimo): <code>proto</code>, <code>version</code>, <code>ipr_id</code>, <code>created_at_utc</code>,
          <code>policy</code>, <code>object.hash.alg</code>, <code>object.hash.value</code>.
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">2) Contenuto (opzionale)</h2>
        <p>
          Se fornisci il contenuto, ricalcoliamo SHA-256 e confrontiamo.
          Se non lo fornisci, possiamo solo verificare la <b>struttura</b> → esito tipico: <b>Inconclusive</b>.
        </p>

        <label>Contenuto (testo)</label>
        <textarea id="taContent" placeholder="Incolla qui il testo originale usato per generare l’hash (Create)."></textarea>

        <div class="btns">
          <button id="btnPrefillContent">Prefill contenuto</button>
          <button id="btnClearContent">Pulisci</button>
        </div>

        <div class="mini" style="margin-top:8px">
          Per file binari: usa la procedura Evidence (hash locale del file) e confronta manualmente il valore con il manifest.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px;font-size:16px">3) Esito + report</h2>
      <div class="status" id="statusBox">
        <span class="tag incon" id="tagResult">Inconclusive</span>
        <div class="mini" id="statusText" style="margin-top:8px">Nessuna verifica eseguita.</div>
        <pre id="report">{ }</pre>
      </div>

      <div class="btns">
        <button class="primary" id="btnVerify">Verifica</button>
        <button id="btnCopyReport">Copia report</button>
        <button id="btnDownloadReport">Scarica report (.json)</button>
      </div>

      <div class="mini" style="margin-top:10px">
        Fail-closed: se un elemento critico è mancante o incoerente, l’esito non diventa “quasi valido”. Diventa <b>Invalid</b> o <b>Inconclusive</b>.
      </div>
    </div>

    <footer>
      <div style="margin-top:14px">
        <b>HERMETICUM B.C.E.</b><br/>
        HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA<br/>
        HERMETICUM B.C.E. S.r.l.
      </div>
      <div class="mini" style="margin-top:8px">Platform status: Experimental · Jurisdiction: EU</div>
    </footer>
  </div>

  <script>
    const KEY_MANIFEST = "HBCE_IPR_MANIFEST";
    const KEY_CONTENT  = "HBCE_IPR_CONTENT";

    const taManifest = document.getElementById("taManifest");
    const taContent  = document.getElementById("taContent");
    const tagResult  = document.getElementById("tagResult");
    const statusText = document.getElementById("statusText");
    const reportEl   = document.getElementById("report");

    function setResult(kind, msg){
      tagResult.className = "tag " + (kind === "Valid" ? "valid" : (kind === "Invalid" ? "invalid" : "incon"));
      tagResult.textContent = kind;
      statusText.textContent = msg;
    }

    function toHex(buf){
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    async function sha256Hex(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return toHex(hash);
    }

    function safeParseManifest(){
      const raw = taManifest.value.trim();
      if(!raw) return { ok:false, error:"Manifest mancante." };
      try{
        const obj = JSON.parse(raw);
        return { ok:true, obj };
      }catch(e){
        return { ok:false, error:"Manifest non è JSON valido." };
      }
    }

    function getPath(obj, path){
      return path.split(".").reduce((acc,k)=> (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
    }

    function validateStructure(m){
      const required = [
        "proto","version","ipr_id","created_at_utc","policy",
        "object.hash.alg","object.hash.value"
      ];
      const missing = required.filter(p => getPath(m,p) === undefined || getPath(m,p) === "");
      if(missing.length) return { ok:false, missing };
      if(getPath(m,"object.hash.alg") !== "SHA-256") return { ok:false, missing:[], error:"Algoritmo hash non supportato (atteso SHA-256)." };
      const hv = getPath(m,"object.hash.value");
      if(typeof hv !== "string" || hv.length !== 64) return { ok:false, missing:[], error:"Hash value non valido (atteso hex 64 chars)." };
      return { ok:true };
    }

    function makeReportBase(){
      return {
        verifier: "HERMETICUM_BCE_VERIFY",
        version: "0.1",
        verified_at_utc: new Date().toISOString(),
        result: "Inconclusive",
        notes: [],
        checks: {}
      };
    }

    document.getElementById("fileManifest").addEventListener("change", async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      const txt = await f.text();
      taManifest.value = txt;
    });

    document.getElementById("btnPrefill").addEventListener("click", ()=>{
      const raw = localStorage.getItem(KEY_MANIFEST);
      if(!raw){
        setResult("Inconclusive","Nessun manifest trovato nel browser (localStorage).");
        return;
      }
      taManifest.value = raw;
      setResult("Inconclusive","Manifest precaricato dal browser. Ora premi Verifica.");
    });

    document.getElementById("btnPrefillContent").addEventListener("click", ()=>{
      const raw = localStorage.getItem(KEY_CONTENT);
      if(!raw){
        setResult("Inconclusive","Nessun contenuto trovato nel browser (localStorage).");
        return;
      }
      taContent.value = raw;
      setResult("Inconclusive","Contenuto precaricato dal browser. Ora premi Verifica.");
    });

    document.getElementById("btnClearManifest").addEventListener("click", ()=>{
      taManifest.value = "";
    });

    document.getElementById("btnClearContent").addEventListener("click", ()=>{
      taContent.value = "";
    });

    document.getElementById("btnVerify").addEventListener("click", async ()=>{
      const rep = makeReportBase();

      const parsed = safeParseManifest();
      if(!parsed.ok){
        rep.result = "Invalid";
        rep.notes.push(parsed.error);
        rep.checks.structure = { ok:false, reason: parsed.error };
        reportEl.textContent = JSON.stringify(rep, null, 2);
        setResult("Invalid", parsed.error);
        return;
      }

      const m = parsed.obj;
      rep.checks.manifest = {
        ipr_id: m.ipr_id,
        created_at_utc: m.created_at_utc,
        hash_alg: getPath(m,"object.hash.alg"),
        hash_value: getPath(m,"object.hash.value")
      };

      const vs = validateStructure(m);
      if(!vs.ok){
        rep.result = "Invalid";
        if(vs.missing && vs.missing.length){
          rep.notes.push("Campi mancanti: " + vs.missing.join(", "));
          rep.checks.structure = { ok:false, missing: vs.missing };
          reportEl.textContent = JSON.stringify(rep, null, 2);
          setResult("Invalid","Manifest incompleto → Invalid (fail-closed).");
          return;
        }
        rep.notes.push(vs.error || "Struttura manifest non valida.");
        rep.checks.structure = { ok:false, reason: vs.error || "invalid" };
        reportEl.textContent = JSON.stringify(rep, null, 2);
        setResult("Invalid", vs.error || "Struttura non valida.");
        return;
      }

      rep.checks.structure = { ok:true };

      const content = taContent.value;
      if(!content || content.trim().length < 1){
        rep.result = "Inconclusive";
        rep.notes.push("Contenuto non fornito: verificata solo struttura manifest.");
        rep.checks.hash = { ok:false, reason:"no-content" };
        reportEl.textContent = JSON.stringify(rep, null, 2);
        setResult("Inconclusive","Struttura OK, ma contenuto assente → Inconclusive.");
        return;
      }

      const computed = await sha256Hex(content);
      const declared = getPath(m,"object.hash.value");
      rep.checks.hash = {
        declared,
        computed,
        match: computed === declared
      };

      if(computed === declared){
        rep.result = "Valid";
        rep.notes.push("Hash match: contenuto coerente col manifest.");
        reportEl.textContent = JSON.stringify(rep, null, 2);
        setResult("Valid","Valid: hash combacia → integrità verificata.");
        return;
      }else{
        rep.result = "Invalid";
        rep.notes.push("Hash mismatch: contenuto NON coerente col manifest.");
        reportEl.textContent = JSON.stringify(rep, null, 2);
        setResult("Invalid","Invalid: hash mismatch (fail-closed).");
        return;
      }
    });

    document.getElementById("btnCopyReport").addEventListener("click", async ()=>{
      const txt = reportEl.textContent || "";
      await navigator.clipboard.writeText(txt);
      setResult(tagResult.textContent, "Report copiato negli appunti.");
    });

    document.getElementById("btnDownloadReport").addEventListener("click", ()=>{
      const txt = reportEl.textContent || "{}";
      const blob = new Blob([txt], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "IPR-verify-report.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Auto-prefill soft (non intrusivo)
    (function(){
      const m = localStorage.getItem(KEY_MANIFEST);
      if(m && !taManifest.value.trim()) taManifest.value = m;
      const c = localStorage.getItem(KEY_CONTENT);
      if(c && !taContent.value.trim()) taContent.value = c;
    })();
  </script>
</body>
</html>
