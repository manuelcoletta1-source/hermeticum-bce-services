<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify | HERMETICUM B.C.E.</title>
  <meta name="description" content="Verify: validazione tecnica hash/bundle. Nessuna narrativa, esiti fail-closed. Tutto locale, nessun invio dati." />
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>
  <header class="wrap">
    <nav class="nav">
      <a class="brand" href="../">HERMETICUM - BLINDATA · COMPUTABILE · EVOLUTIVA</a>
      <div class="navlinks">
        <a href="../">Gateway</a>
        <a href="../standards/">Standard</a>
        <a href="../research/">Ricerca UE</a>
        <a href="../phase-1/">Fase 1</a>
        <a class="active" href="./">Verify</a>
        <a href="../legal/">Legal</a>
      </div>
    </nav>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>Verify — Hash-Only / Evidence Bundle</h1>
      <p class="lead">
        Verifica locale di un bundle (JSON): parsing, campi minimi, coerenza policy e formato hash.
        Se hai il payload off-chain, puoi ricalcolare lo SHA-256 nel browser e confrontarlo.
      </p>

      <div class="notice">
        <strong>Fail-closed:</strong> se manca un requisito minimo → <strong>INVALID</strong>.  
        <strong>VALID</strong> significa “coerenza tecnica minima”, non prova di identità.
      </div>

      <div class="btnrow" style="margin-top:14px;">
        <a class="btn secondary" href="../register/">Register</a>
        <a class="btn secondary" href="../create/">Create (bundle)</a>
        <a class="btn secondary" href="../catalog/">Catalog</a>
        <a class="btn secondary" href="../privacy/">Privacy</a>
      </div>
    </section>

    <section class="grid">
      <article class="card">
        <h2>1) Incolla Evidence Bundle (JSON)</h2>
        <label class="muted">Bundle (JSON)</label>
        <textarea id="eventJson" rows="12" style="width:100%;" placeholder='{"HRR":"...","POLICY":"...","PAYLOAD_MIN":{"desc":"...","content_hash_sha256":null}}'></textarea>

        <div class="btnrow" style="margin-top:12px;">
          <button class="btn" id="btnVerify" type="button">Verifica</button>
          <button class="btn secondary" id="btnLoadExample" type="button">Esempio</button>
          <button class="btn secondary" id="btnReset" type="button">Reset</button>
        </div>

        <p class="muted" style="margin-top:10px;">
          Nessun invio dati: tutto resta nel browser.
        </p>
      </article>

      <article class="card">
        <h2>2) Payload off-chain (opzionale)</h2>
        <label class="muted">Payload originale (testo/JSON) — usato solo per ricalcolare SHA-256</label>
        <textarea id="payload" rows="10" style="width:100%;" placeholder="Incolla qui il payload off-chain (se ce l'hai)"></textarea>

        <div class="btnrow" style="margin-top:12px;">
          <button class="btn secondary" id="btnHashPayload" type="button">Calcola SHA-256</button>
          <button class="btn secondary" id="btnCompare" type="button">Confronta con bundle</button>
        </div>

        <pre id="payloadHashOut" class="codeblock" style="margin-top:12px;">{}</pre>
      </article>

      <article class="card">
        <h2>Risultato (fail-closed)</h2>
        <pre id="result" class="codeblock">{}</pre>
        <p class="muted" style="margin-top:10px;">
          Esiti: <strong>VALID</strong> / <strong>INVALID</strong> / <strong>INCONCLUSIVE</strong>.
        </p>
      </article>

      <article class="card">
        <h2>Note operative</h2>
        <ul class="muted">
          <li>Verify valida struttura e coerenza minima (non identità).</li>
          <li>Non sostituisce CIE/SPID/eIDAS.</li>
          <li>Nessuna custodia di dati personali nel portale statico.</li>
        </ul>
        <div class="btnrow">
          <a class="btn secondary" href="../governance/">Governance</a>
          <a class="btn secondary" href="../terms/">Termini</a>
          <a class="btn secondary" href="../about/">About</a>
        </div>
      </article>
    </section>
  </main>

  <footer class="wrap foot">
    <small>HERMETICUM B.C.E. S.r.l. — Verify (local, hash-only)</small>
  </footer>

<script>
  const $ = (id) => document.getElementById(id);

  function out(obj){ $("result").textContent = JSON.stringify(obj, null, 2); }
  function outHash(obj){ $("payloadHashOut").textContent = JSON.stringify(obj, null, 2); }

  function isHex(s){ return /^[0-9a-fA-F]+$/.test(s); }
  function looksLikeSha256(h){ return typeof h==="string" && h.length===64 && isHex(h); }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function validateEvent(e){
    // Fail-closed minimal model: HRR + POLICY + PAYLOAD_MIN.desc
    if (!e || typeof e !== "object") return {status:"INVALID", reason:"Event is not an object"};
    if (!e.HRR || typeof e.HRR !== "string") return {status:"INVALID", reason:"Missing/invalid HRR"};
    if (!e.POLICY || typeof e.POLICY !== "string") return {status:"INVALID", reason:"Missing/invalid POLICY"};
    if (!e.PAYLOAD_MIN || typeof e.PAYLOAD_MIN !== "object") return {status:"INVALID", reason:"Missing PAYLOAD_MIN"};
    if (!e.PAYLOAD_MIN.desc || typeof e.PAYLOAD_MIN.desc !== "string") return {status:"INVALID", reason:"Missing PAYLOAD_MIN.desc"};

    const h = e.PAYLOAD_MIN.content_hash_sha256;
    if (h !== null && h !== undefined && h !== "") {
      if (typeof h !== "string" || !looksLikeSha256(h)) {
        return {status:"INVALID", reason:"PAYLOAD_MIN.content_hash_sha256 present but not SHA-256 hex"};
      }
    }

    return {
      status:"VALID",
      note:"Structure OK (does not prove identity)",
      checked_utc:new Date().toISOString()
    };
  }

  const example = {
    HRR: "HRR-L-DEMO-0001",
    POLICY: "UE-first | GDPR-min | hash-only | append-only | fail-closed",
    NOTE: "Demo. Not an identity proof.",
    PAYLOAD_MIN: {
      desc: "Esempio di bundle minimo per test Verify",
      content_hash_sha256: null,
      timestamp: null,
      created_utc: new Date().toISOString()
    }
  };

  $("btnVerify").addEventListener("click", () => {
    const raw = ($("eventJson").value || "").trim();
    if (!raw) return out({status:"INVALID", reason:"Empty input", ts_utc:new Date().toISOString()});
    try {
      const obj = JSON.parse(raw);
      out(validateEvent(obj));
    } catch (e) {
      out({status:"INVALID", reason:"Invalid JSON", detail:String(e), ts_utc:new Date().toISOString()});
    }
  });

  $("btnLoadExample").addEventListener("click", () => {
    $("eventJson").value = JSON.stringify(example, null, 2);
    out({status:"INCONCLUSIVE", note:"Example loaded. Click 'Verifica'.", ts_utc:new Date().toISOString()});
  });

  $("btnReset").addEventListener("click", () => {
    $("eventJson").value = "";
    $("payload").value = "";
    out({});
    outHash({});
  });

  $("btnHashPayload").addEventListener("click", async () => {
    const p = ($("payload").value || "");
    if (!p.trim()) return outHash({status:"INVALID", reason:"Empty payload"});
    const h = await sha256Hex(p);
    outHash({status:"OK", sha256: h});
  });

  $("btnCompare").addEventListener("click", async () => {
    let evt;
    try { evt = JSON.parse(($("eventJson").value || "").trim() || "{}"); }
    catch { return out({status:"INVALID", reason:"Event JSON invalid; cannot compare"}); }

    const expected = evt?.PAYLOAD_MIN?.content_hash_sha256;
    if (!expected || typeof expected !== "string") {
      return out({status:"INCONCLUSIVE", reason:"Bundle has no PAYLOAD_MIN.content_hash_sha256"});
    }
    if (!looksLikeSha256(expected)) {
      return out({status:"INVALID", reason:"Bundle hash is not valid SHA-256 hex"});
    }

    const p = ($("payload").value || "");
    if (!p.trim()) return out({status:"INVALID", reason:"Empty payload; cannot compute hash"});

    const actual = await sha256Hex(p);
    const ok = (actual.toLowerCase() === expected.toLowerCase());

    out({
      status: ok ? "VALID" : "INVALID",
      compare: { expected_sha256: expected, actual_sha256: actual },
      note: ok ? "Hash match." : "Hash mismatch.",
      ts_utc: new Date().toISOString()
    });
  });
</script>
</body>
</html>
