<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify — Verifica deterministica IPR (FAIL-CLOSED)</title>

  <!-- GitHub Pages project site base -->
  <base href="/hermeticum-bce-platform/">

  <link rel="stylesheet" href="assets/hbce.css" />
</head>
<body>
  <header class="topbar">
    <div class="wrap nav">
      <div class="brand">
        <div class="sig" aria-hidden="true"></div>
        <div>
          <h1>Verify</h1>
          <span class="sub">IPR verification · determinismo · fail-closed</span>
        </div>
      </div>
      <nav class="menu" aria-label="Navigazione principale">
        <a class="pill" data-nav href="./"><strong>Home</strong></a>
        <a class="pill" data-nav href="citizen/"><strong>Cittadini UE</strong></a>
        <a class="pill" data-nav href="ai-joker-c2/"><strong>AI JOKER-C2</strong></a>
        <a class="pill" data-nav href="institution/">Istituzioni UE</a>
        <a class="pill" data-nav href="member-states/">Stati Membri</a>
        <a class="pill" data-nav href="technology/">Tecnologia</a>
        <a class="pill active" data-nav href="verify/"><strong>Verify</strong></a>
        <a class="pill" data-nav href="security/">Sicurezza</a>
        <a class="pill" data-nav href="governance/">Governance</a>
        <a class="pill" data-nav href="manual/">Manuale</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="kicker">DETERMINISTIC · AUDITABLE · FAIL-CLOSED</div>
      <h2 class="title">Verifica IPR: se non è verificabile, è FAIL</h2>
      <p class="lead">
        Questa pagina esegue una verifica <strong>deterministica</strong> basata su SHA-512 tramite WebCrypto:
        scarica i file canonici dal repository, calcola l’hash e lo confronta con il digest pubblicato.
        Se un file non è raggiungibile o un valore non coincide → <strong>FAIL</strong>.
      </p>
      <div class="btnrow">
        <button class="btn" id="runBtn" type="button">Esegui verifica adesso</button>
        <a class="btn secondary" href="technology/">Come funziona (PASS/FAIL)</a>
        <a class="btn ghost" href="governance/">Limiti e garanzie</a>
      </div>
    </section>

    <section class="grid">
      <article class="card cols-12">
        <h3>Target di verifica (default)</h3>
        <p>Questi path sono relativi al repository e devono esistere. Se manca anche un solo file: FAIL.</p>

        <div class="grid" style="gap:12px">
          <div class="card cols-6" style="padding:14px">
            <div class="meta"><span class="tag">canon</span></div>
            <div><strong>IPR canonico</strong></div>
            <div class="mono" id="pathCanon">ipr.canon.json</div>
          </div>

          <div class="card cols-6" style="padding:14px">
            <div class="meta"><span class="tag">digest</span></div>
            <div><strong>Digest pubblicato</strong></div>
            <div class="mono" id="pathDigest">ipr.json</div>
          </div>

          <div class="card cols-6" style="padding:14px">
            <div class="meta"><span class="tag">receipt</span></div>
            <div><strong>Receipt (opzionale)</strong></div>
            <div class="mono" id="pathReceipt">receipt.json</div>
          </div>

          <div class="card cols-6" style="padding:14px">
            <div class="meta"><span class="tag">pubkey</span></div>
            <div><strong>ED25519 public key (opzionale)</strong></div>
            <div class="mono" id="pathPubkey">ed25519_pub.pem</div>
          </div>
        </div>
      </article>

      <article class="card cols-12">
        <h3>Esito</h3>
        <div id="statusBox" class="meta" style="margin-bottom:10px">
          <span class="tag warn" id="statusTag">IN ATTESA</span>
          <span class="tag">fail-closed</span>
          <span class="tag">sha-512</span>
        </div>

        <div class="card" style="padding:14px">
          <div><strong>Dettagli</strong></div>
          <pre id="log" style="margin:10px 0 0; white-space:pre-wrap; color:rgba(232,236,255,.92)">Premi “Esegui verifica adesso”.</pre>
        </div>
      </article>

      <article class="card cols-12">
        <h3>Nota sulla firma ED25519</h3>
        <p>
          La verifica della firma ED25519 <strong>non è garantita</strong> in tutti i browser via WebCrypto.
          Qui verifichiamo in modo affidabile la parte deterministica: <strong>hash SHA-512 del canonico</strong>.
          La firma resta verificabile offline tramite tool (approccio audit-first).
        </p>
      </article>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">
      <div class="notice">
        <strong>Fail-closed</strong><br/>
        Se questa pagina non riesce a scaricare un file o se un valore non coincide, mostra FAIL.
        Questo è voluto: l’assenza di evidenza non viene “interpretata”.
      </div>
    </div>
  </footer>

  <script src="assets/hbce.js"></script>
  <script>
    const paths = {
      canon: "ipr.canon.json",
      digest: "ipr.json",
      receipt: "receipt.json",
      pubkey: "ed25519_pub.pem"
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(kind, text) {
      const tag = $("statusTag");
      tag.className = "tag " + (kind === "PASS" ? "ok" : kind === "FAIL" ? "danger" : "warn");
      tag.textContent = text;
    }

    function logLine(line) {
      const el = $("log");
      el.textContent += (el.textContent.endsWith("\n") ? "" : "\n") + line;
    }

    async function fetchText(path) {
      // Fail-closed: qualsiasi non-200 è FAIL.
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`FETCH_FAIL ${path} → HTTP ${res.status}`);
      return await res.text();
    }

    async function sha512Hex(str) {
      const enc = new TextEncoder();
      const buf = enc.encode(str);
      const digest = await crypto.subtle.digest("SHA-512", buf);
      const bytes = new Uint8Array(digest);
      let hex = "";
      for (const b of bytes) hex += b.toString(16).padStart(2, "0");
      return hex;
    }

    function safeJsonParse(text, path) {
      try { return JSON.parse(text); }
      catch (e) { throw new Error(`JSON_PARSE_FAIL ${path}`); }
    }

    async function runVerify() {
      $("log").textContent = "";
      setStatus("PENDING", "IN CORSO");
      logLine("VERIFY_START");

      try {
        // 1) Fetch canon
        logLine(`FETCH ${paths.canon}`);
        const canonText = await fetchText(paths.canon);
        logLine(`OK ${paths.canon} (${canonText.length} bytes)`);

        // 2) Compute SHA-512
        logLine("HASH sha-512(canon) ...");
        const computedHex = await sha512Hex(canonText);
        logLine(`COMPUTED_SHA512 ${computedHex}`);

        // 3) Fetch digest file (ipr.json) and extract expected digest
        logLine(`FETCH ${paths.digest}`);
        const digestText = await fetchText(paths.digest);
        logLine(`OK ${paths.digest} (${digestText.length} bytes)`);

        const digestObj = safeJsonParse(digestText, paths.digest);

        // Support 2 formats:
        // A) { "hash": { "algorithm":"SHA-512", "digest_hex":"..." } }
        // B) { "algorithm":"SHA-512", "digest_hex":"..." }
        let expectedHex = null;
        if (digestObj && digestObj.hash && typeof digestObj.hash.digest_hex === "string") expectedHex = digestObj.hash.digest_hex;
        if (!expectedHex && typeof digestObj.digest_hex === "string") expectedHex = digestObj.digest_hex;

        if (!expectedHex) throw new Error("DIGEST_MISSING ipr.json must contain digest_hex");

        expectedHex = expectedHex.trim().toLowerCase();
        logLine(`EXPECTED_SHA512 ${expectedHex}`);

        // 4) Compare
        if (computedHex !== expectedHex) {
          throw new Error("HASH_MISMATCH computed_sha512 != expected_sha512 (virgola=FAIL)");
        }

        // 5) Optional: receipt fetch (does not affect PASS if missing, but logs it)
        try {
          logLine(`FETCH_OPT ${paths.receipt}`);
          const receiptText = await fetchText(paths.receipt);
          logLine(`OK_OPT ${paths.receipt} (${receiptText.length} bytes)`);
        } catch (e) {
          logLine(`WARN ${e.message}`);
        }

        // 6) Optional: pubkey fetch
        try {
          logLine(`FETCH_OPT ${paths.pubkey}`);
          const pubText = await fetchText(paths.pubkey);
          logLine(`OK_OPT ${paths.pubkey} (${pubText.length} bytes)`);
        } catch (e) {
          logLine(`WARN ${e.message}`);
        }

        setStatus("PASS", "PASS");
        logLine("VERIFY_RESULT PASS");
      } catch (err) {
        setStatus("FAIL", "FAIL");
        logLine(`VERIFY_RESULT FAIL`);
        logLine(`REASON ${err.message || String(err)}`);
      }
    }

    $("runBtn").addEventListener("click", runVerify);

    // Stamp paths in UI
    $("pathCanon").textContent = paths.canon;
    $("pathDigest").textContent = paths.digest;
    $("pathReceipt").textContent = paths.receipt;
    $("pathPubkey").textContent = paths.pubkey;
  </script>
</body>
</html>
