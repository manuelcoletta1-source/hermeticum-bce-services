
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create IPR — Profilo biocibernetico UE (hash-only)</title>
  <meta name="description" content="Creazione di un draft IPR partendo da dati standard UE dell’utente biologico. I dati restano nel browser: output hash-only. Fail-closed." />
  <link rel="stylesheet" href="../assets/style.css" />
</head>

<body>
  <header class="topbar">
    <div class="container">
      <a class="brand" href="../index.html">HERMETICUM B.C.E.</a>
      <nav class="nav">
        <a href="../ipr/index.html">IPR</a>
        <a class="active" href="./create.html">Create</a>
        <a href="../verify/index.html">Verify</a>
        <a href="../gate/index.html">Gate</a>
        <a href="../datacenter/index.html">DataCenter</a>
        <a href="../openapi/index.html">OpenAPI</a>
        <a href="../use-cases/index.html">Use Cases</a>
        <a href="../status/index.html">Status</a>
        <a href="../governance/index.html">Governance</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>Create IPR</h1>

    <p class="lead">
      Questa pagina è per l’<strong>utente biologico UE</strong>.
      Compili dati standard (come in un contesto amministrativo) e ottieni un <strong>draft hash-only</strong>.
      <br />
      <strong>Niente viene inviato a server.</strong> Tutto resta nel tuo browser.
    </p>

    <section class="card">
      <h2>Privacy (chiaro e verificabile)</h2>
      <ul>
        <li>Non salva dati personali sul sito</li>
        <li>Non invia dati a server</li>
        <li>Genera solo hash e un draft copiabile</li>
        <li>Regime: <strong>fail-closed</strong> (se mancano campi minimi → nessun output)</li>
      </ul>
      <p class="hint">
        I campi opzionali esistono solo per chiarezza. L’output finale è sempre hash-only.
      </p>
    </section>

    <section class="grid">

      <!-- PANEL A: BIOLOGICO -->
      <section class="card">
        <h2>A) Dati UE (utente biologico)</h2>
        <p class="hint">
          I dati in chiaro vengono usati solo per calcolare hash localmente.
        </p>

        <label for="full_name">Nome e cognome *</label>
        <input id="full_name" placeholder="es. Mario Rossi" />

        <label for="dob">Data di nascita *</label>
        <input id="dob" placeholder="es. 31/12/1990" />

        <label for="citizenship">Cittadinanza (codice) *</label>
        <input id="citizenship" placeholder="es. IT" />

        <label for="doc_type">Documento (tipo) *</label>
        <select id="doc_type">
          <option value="">Seleziona</option>
          <option value="CIE">Carta d’Identità (CIE)</option>
          <option value="PASSPORT">Passaporto</option>
          <option value="OTHER">Altro</option>
        </select>

        <label for="doc_id">Documento (numero o riferimento) *</label>
        <input id="doc_id" placeholder="es. CA12345AB (o ref interno)" />

        <label for="issuer">Ente emittente (opzionale)</label>
        <input id="issuer" placeholder="es. Comune / Stato / Autorità" />

        <label for="email">Contatto (opzionale)</label>
        <input id="email" placeholder="email/PEC (verrà hashata localmente)" />

        <hr />

        <label for="iprtype">Tipo di IPR</label>
        <select id="iprtype">
          <option value="PERSON">PERSON (biologico)</option>
          <option value="ORG">ORG (ente/organizzazione)</option>
          <option value="DEVICE">DEVICE (dispositivo/robot)</option>
        </select>

        <label for="purpose">Scopo dichiarato (breve)</label>
        <input id="purpose" placeholder="es. attivazione profilo biocibernetico UE" />

        <label for="timestamp">Timestamp (ISO-8601)</label>
        <input id="timestamp" placeholder="lascia vuoto per auto" />

        <div class="row">
          <button id="btn_generate">Genera IPR (hash-only)</button>
          <button id="btn_clear" class="secondary">Svuota</button>
        </div>

        <p class="hint">
          * Campi minimi richiesti. Se mancano → FAIL (fail-closed).
        </p>
      </section>

      <!-- PANEL B: OUTPUT -->
      <section class="card">
        <h2>B) Output (hash-only)</h2>
        <p class="hint">
          Copia e incolla nel tuo flusso (manifest, verify, gate). Questo portale non pubblica nulla.
        </p>

        <h3>Anteprima</h3>
        <pre id="hash_preview" class="code">Compila i campi e premi “Genera IPR (hash-only)”.</pre>

        <h3>Draft IPR</h3>
        <pre id="draft_out" class="code">Nessun draft generato.</pre>
      </section>

    </section>

    <section class="card">
      <h2>Prossimi passi</h2>
      <ol>
        <li>Genera il draft qui (hash-only)</li>
        <li>Pubblica il manifest nel tuo repo append-only</li>
        <li>Verifica con <a href="../verify/index.html">Verify</a></li>
        <li>Usa <a href="../gate/index.html">Gate</a> per PASS/FAIL ex-ante</li>
      </ol>
    </section>

    <footer class="footer">
      <p>Non cambio chi decide. Cambio quando un’azione è ammessa.</p>
    </footer>
  </main>

  <script>
    async function sha256Hex(str) {
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const digest = await crypto.subtle.digest("SHA-256", data);
      const arr = Array.from(new Uint8Array(digest));
      return arr.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function isoNowWithOffset() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");

      const y = d.getFullYear();
      const m = pad(d.getMonth() + 1);
      const day = pad(d.getDate());
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      const ss = pad(d.getSeconds());

      const off = -d.getTimezoneOffset(); // minuti
      const sign = off >= 0 ? "+" : "-";
      const offAbs = Math.abs(off);
      const offH = pad(Math.floor(offAbs / 60));
      const offM = pad(offAbs % 60);

      return `${y}-${m}-${day}T${hh}:${mm}:${ss}${sign}${offH}:${offM}`;
    }

    function failClosed(reason) {
      return { status: "FAIL", reason_code: reason, mode: "fail-closed" };
    }

    function getVal(id) {
      const el = document.getElementById(id);
      return (el && el.value) ? String(el.value).trim() : "";
    }

    function setText(id, txt) {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    }

    function minimalOk(profile) {
      if (!profile.full_name) return "MISSING_FULL_NAME";
      if (!profile.dob) return "MISSING_DATE_OF_BIRTH";
      if (!profile.citizenship) return "MISSING_CITIZENSHIP";
      if (!profile.doc_type) return "MISSING_DOCUMENT_TYPE";
      if (!profile.doc_id) return "MISSING_DOCUMENT_ID";
      return null;
    }

    document.getElementById("btn_generate").addEventListener("click", async () => {
      const ts = getVal("timestamp") || isoNowWithOffset();

      // FAIL-CLOSED: timestamp deve essere ISO parsabile
      if (isNaN(Date.parse(ts))) {
        setText("hash_preview", JSON.stringify(failClosed("INVALID_TIMESTAMP"), null, 2));
        setText("draft_out", "Nessun draft generato.");
        return;
      }

      const profile = {
        full_name: getVal("full_name"),
        dob: getVal("dob"),
        citizenship: getVal("citizenship"),
        doc_type: getVal("doc_type"),
        doc_id: getVal("doc_id"),
        issuer: getVal("issuer"),
        email: getVal("email"),
        iprtype: getVal("iprtype") || "PERSON",
        purpose: getVal("purpose"),
        timestamp: ts
      };

      const missing = minimalOk(profile);
      if (missing) {
        setText("hash_preview", JSON.stringify(failClosed(missing), null, 2));
        setText("draft_out", "Nessun draft generato.");
        return;
      }

      const canonical = {
        full_name: profile.full_name,
        dob: profile.dob,
        citizenship: profile.citizenship,
        doc: {
          type: profile.doc_type,
          id: profile.doc_id,
          issuer: profile.issuer || ""
        },
        contact_hash_only: profile.email ? "present" : "absent",
        iprtype: profile.iprtype,
        purpose: profile.purpose || "",
        timestamp: profile.timestamp
      };

      const payloadStr = JSON.stringify(canonical);
      const payloadHash = "sha256:" + await sha256Hex(payloadStr);

      const contextStr = JSON.stringify({
        context: "HBCE-IPR-CREATE-UE",
        iprtype: canonical.iprtype,
        purpose: canonical.purpose || "IPR creation",
        timestamp: canonical.timestamp
      });
      const contextHash = "sha256:" + await sha256Hex(contextStr);

      const subjectRef = "IPR-UE:" + (await sha256Hex(
        canonical.full_name + "|" + canonical.dob + "|" + canonical.citizenship + "|" + canonical.doc.type + "|" + canonical.doc.id
      )).slice(0, 24);

      setText("hash_preview", JSON.stringify({
        subject_ref: subjectRef,
        context_hash: contextHash,
        payload_hash: payloadHash,
        timestamp: canonical.timestamp,
        mode: "hash-only",
        policy: "UE-FIRST | AUDIT | FAIL-CLOSED | NO-CUSTODY",
        note: "Dati in chiaro solo nel browser. Output solo hash."
      }, null, 2));

      const draft = {
        proto: "HBCE-IPR-DRAFT-v2",
        mode: "hash-only",
        policy: "UE-FIRST | AUDIT | FAIL-CLOSED | NO-CUSTODY",
        subject_ref: subjectRef,
        context_hash: contextHash,
        payload_hash: payloadHash,
        timestamp: canonical.timestamp,
        next: {
          publish_manifest: "append-only repository",
          verify: "../verify/index.html",
          gate: "../gate/index.html"
        }
      };

      setText("draft_out", JSON.stringify(draft, null, 2));
    });

    document.getElementById("btn_clear").addEventListener("click", () => {
      ["full_name","dob","citizenship","doc_type","doc_id","issuer","email","purpose","timestamp"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      setText("hash_preview", "Compila i campi e premi “Genera IPR (hash-only)”.");
      setText("draft_out", "Nessun draft generato.");
    });
  </script>
</body>
</html>
