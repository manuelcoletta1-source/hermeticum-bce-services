<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attivazione IPR Base — Hermeticum B.C.E. Services</title>
  <meta name="description" content="Attivazione guidata IPR Base (1-2-3) — hashing locale, evidenze verificabili, zero data retention." />
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0c10;
      --panel:#0f1117;
      --line:#24262b;
      --text:#e8e8e8;
      --muted:#b8b8b8;
      --accent:#6ae3ff;
      --warn:#ffd36a;
      --ok:#73ffb3;
      --bad:#ff7a7a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    header, main, footer{
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
    }
    header{ padding-top: 28px; padding-bottom: 10px; }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .brand{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .sub{ color: var(--muted); font-size: 13px; }

    .card{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--panel);
      padding: 18px;
      margin-top: 14px;
    }
    h2{
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: .2px;
    }

    .disclaimer{
      border-left: 3px solid var(--warn);
      padding: 12px 14px;
      background: rgba(255,211,106,0.08);
      border-radius: 12px;
      font-size: 14px;
      margin-top: 12px;
    }

    .steps{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .step-pill{
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,0.12);
      border:1px solid var(--line);
    }
    .step-pill.active{
      color: var(--text);
      border-color: rgba(106,227,255,0.35);
      background: rgba(106,227,255,0.06);
    }
    .step-pill.active .dot{
      background: var(--accent);
      border-color: rgba(106,227,255,0.6);
    }
    .step-pill.done{
      color: var(--text);
      border-color: rgba(115,255,179,0.35);
      background: rgba(115,255,179,0.06);
    }
    .step-pill.done .dot{
      background: var(--ok);
      border-color: rgba(115,255,179,0.6);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(106,227,255,0.55);
      box-shadow: 0 0 0 3px rgba(106,227,255,0.08);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor:pointer;
    }
    .btn:hover{ border-color: rgba(106,227,255,0.35); }
    .btn.primary{
      background: var(--accent);
      color:#000;
      border-color: transparent;
    }
    .btn.primary:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .small{ font-size: 13px; color: var(--muted); }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      word-break: break-all;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 10px;
    }

    details summary{
      cursor:pointer;
      color: var(--accent);
      margin-top: 10px;
    }
    .footer-links{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
    }

    .status-ok{ color: var(--ok); }
    .status-bad{ color: var(--bad); }
    .hide{ display:none; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div>
        <h1>Attivazione IPR Base</h1>
        <div class="sub">Procedura guidata 1-2-3 · hashing locale · zero data retention</div>

        <div class="disclaimer">
          <strong>Nota:</strong> questa procedura genera evidenze <strong>localmente</strong> nel tuo browser.
          “UE-first” è un riferimento progettuale (GDPR, minimizzazione, auditabilità) e
          <strong>non è una certificazione ufficiale UE</strong>. Non sostituisce documenti statali.
        </div>

        <div class="steps" aria-label="stato procedura">
          <div id="pill1" class="step-pill active"><span class="dot"></span> 1) Dati minimi</div>
          <div id="pill2" class="step-pill"><span class="dot"></span> 2) Documento &amp; Hash</div>
          <div id="pill3" class="step-pill"><span class="dot"></span> 3) Bundle &amp; Download</div>
        </div>
      </div>

      <div class="sub">
        <a href="./index.html">Home</a> · <a href="./services.html">Servizi</a>
      </div>
    </div>
  </header>

  <main>
    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h2>Step 1 — Dati minimi (solo sul tuo dispositivo)</h2>
      <p class="small">
        Questi campi servono solo a creare un bundle coerente e verificabile <strong>localmente</strong>.
        Nulla viene inviato o archiviato.
      </p>

      <div class="grid">
        <div>
          <label for="cf">Codice Fiscale (obbligatorio)</label>
          <input id="cf" type="text" placeholder="es. RSSMRA80A01H501U" autocomplete="off" />
        </div>
        <div>
          <label for="mode">Modalità</label>
          <select id="mode">
            <option value="minimal">Minimale (solo CF + file)</option>
            <option value="full">Completa (anagrafica locale)</option>
          </select>
        </div>
      </div>

      <div id="fullBlock" class="grid hide" style="margin-top:12px;">
        <div>
          <label for="nome">Nome</label>
          <input id="nome" type="text" placeholder="Nome" autocomplete="off" />
        </div>
        <div>
          <label for="cognome">Cognome</label>
          <input id="cognome" type="text" placeholder="Cognome" autocomplete="off" />
        </div>
        <div>
          <label for="nascita">Data di nascita</label>
          <input id="nascita" type="date" />
        </div>
        <div>
          <label for="luogo">Luogo di nascita</label>
          <input id="luogo" type="text" placeholder="Comune / Provincia" autocomplete="off" />
        </div>
      </div>

      <div class="row">
        <button id="to2" class="btn primary" disabled>Continua → Step 2</button>
        <span id="s1status" class="small"></span>
      </div>

      <details>
        <summary>Perché chiediamo questi dati?</summary>
        <p class="small">
          Per generare un bundle locale con metadati coerenti e verificabili. Se non vuoi inserire anagrafica,
          usa la modalità <strong>Minimale</strong>.
        </p>
      </details>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card hide">
      <h2>Step 2 — Seleziona un documento e calcola l’hash (SHA-512)</h2>
      <p class="small">
        Il file resta sul tuo dispositivo. L’hash è una “impronta” che permette la verifica di integrità.
      </p>

      <div class="grid">
        <div>
          <label for="doc">Documento (PDF/JPG/PNG…)</label>
          <input id="doc" type="file" />
        </div>
        <div>
          <label>Stato</label>
          <input id="docInfo" type="text" value="Nessun file selezionato" readonly />
        </div>
      </div>

      <div class="row">
        <button id="hashBtn" class="btn primary" disabled>Calcola SHA-512</button>
        <button id="back1" class="btn">← Indietro</button>
        <span id="s2status" class="small"></span>
      </div>

      <div id="hashBox" class="mono hide" aria-label="hash sha-512"></div>

      <details>
        <summary>Verifica offline (consigliata)</summary>
        <div class="mono">
          Linux/macOS: <code>shasum -a 512 FILE</code><br />
          Windows PowerShell: <code>Get-FileHash -Algorithm SHA512 .\FILE</code>
        </div>
      </details>

      <div class="footer-links">
        <span class="muted">Link:</span>
        <a href="./privacy.html">Privacy</a>
        <a href="./terms.html">Terms</a>
        <a href="./security.html">Security</a>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="card hide">
      <h2>Step 3 — Genera bundle e scarica</h2>
      <p class="small">
        Il bundle contiene metadati e hash per verificare integrità e coerenza. È un file locale.
      </p>

      <div class="row">
        <button id="bundleBtn" class="btn primary" disabled>Genera Bundle (JSON)</button>
        <button id="downloadBtn" class="btn" disabled>Scarica</button>
        <button id="back2" class="btn">← Indietro</button>
        <span id="s3status" class="small"></span>
      </div>

      <div id="bundlePreview" class="mono hide"></div>

      <div class="footer-links">
        <span class="muted">Link:</span>
        <a href="./privacy.html">Privacy</a>
        <a href="./terms.html">Terms</a>
        <a href="./security.html">Security</a>
        <a href="./index.html">Home</a>
      </div>
    </section>
  </main>

  <footer class="muted" style="max-width:980px;margin:40px auto 0;padding:20px;border-top:1px solid #24262b;font-size:13px;">
    © Hermeticum B.C.E. — Services ·
    <a href="./privacy.html">Privacy</a> ·
    <a href="./terms.html">Terms</a> ·
    <a href="./security.html">Security</a>
    <span> — UE-first · audit-by-design · fail-closed</span>
  </footer>

  <script>
    // helpers
    const $ = (id) => document.getElementById(id);

    function resetPills(){
      ["pill1","pill2","pill3"].forEach(id => {
        const el = $(id);
        el.classList.remove("active");
        el.classList.remove("done");
      });
    }

    function setPills(step){
      const p1 = $("pill1"), p2 = $("pill2"), p3 = $("pill3");
      resetPills();
      if(step === 1){
        p1.classList.add("active");
      }else if(step === 2){
        p1.classList.add("done");
        p2.classList.add("active");
      }else if(step === 3){
        p1.classList.add("done");
        p2.classList.add("done");
        p3.classList.add("active");
      }
    }

    function showStep(n){
      $("step1").classList.toggle("hide", n !== 1);
      $("step2").classList.toggle("hide", n !== 2);
      $("step3").classList.toggle("hide", n !== 3);
      setPills(n);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // state
    let state = {
      mode: "minimal",
      cf: "",
      nome: "",
      cognome: "",
      nascita: "",
      luogo: "",
      file: null,
      fileHashHex: "",
      bundleJson: "",
      bundleBlob: null
    };

    // Step 1
    const cf = $("cf");
    const mode = $("mode");
    const fullBlock = $("fullBlock");
    const to2 = $("to2");
    const s1status = $("s1status");

    function validateStep1(){
      state.cf = (cf.value || "").trim().toUpperCase();
      const cfOk = state.cf.length >= 8; // light validation, avoids false negatives

      if(state.mode === "full"){
        state.nome = ($("nome").value || "").trim();
        state.cognome = ($("cognome").value || "").trim();
        state.nascita = ($("nascita").value || "").trim();
        state.luogo = ($("luogo").value || "").trim();

        const fullOk = state.nome.length >= 2 && state.cognome.length >= 2 && state.nascita.length > 0 && state.luogo.length >= 2;
        to2.disabled = !(cfOk && fullOk);
        s1status.textContent = to2.disabled ? "Compila CF e anagrafica (locale) per proseguire." : "OK. Puoi continuare.";
      }else{
        to2.disabled = !cfOk;
        s1status.textContent = to2.disabled ? "Inserisci almeno il Codice Fiscale per proseguire." : "OK. Puoi continuare.";
      }
    }

    mode.addEventListener("change", () => {
      state.mode = mode.value;
      fullBlock.classList.toggle("hide", state.mode !== "full");
      validateStep1();
    });
    cf.addEventListener("input", validateStep1);
    ["nome","cognome","nascita","luogo"].forEach(id => {
      const el = $(id);
      if(!el) return;
      el.addEventListener("input", validateStep1);
      if(el.type === "date") el.addEventListener("change", validateStep1);
    });

    to2.addEventListener("click", () => showStep(2));

    // Step 2
    const doc = $("doc");
    const docInfo = $("docInfo");
    const hashBtn = $("hashBtn");
    const back1 = $("back1");
    const s2status = $("s2status");
    const hashBox = $("hashBox");

    doc.addEventListener("change", () => {
      state.file = doc.files && doc.files[0] ? doc.files[0] : null;
      state.fileHashHex = "";
      hashBox.classList.add("hide");
      hashBox.textContent = "";
      $("bundleBtn").disabled = true;
      $("downloadBtn").disabled = true;
      $("bundlePreview").classList.add("hide");
      $("bundlePreview").textContent = "";
      state.bundleJson = "";
      state.bundleBlob = null;

      if(state.file){
        docInfo.value = `${state.file.name} (${state.file.type || "tipo sconosciuto"}, ${state.file.size} bytes)`;
        hashBtn.disabled = false;
        s2status.textContent = "File selezionato. Calcola l’hash.";
      }else{
        docInfo.value = "Nessun file selezionato";
        hashBtn.disabled = true;
        s2status.textContent = "";
      }
    });

    back1.addEventListener("click", () => showStep(1));

    async function sha512Hex(file){
      const buf = await file.arrayBuffer();
      const hashBuf = await crypto.subtle.digest("SHA-512", buf);
      const hashArr = Array.from(new Uint8Array(hashBuf));
      return hashArr.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    hashBtn.addEventListener("click", async () => {
      if(!state.file) return;

      hashBtn.disabled = true;
      s2status.textContent = "Calcolo hash in corso…";
      try{
        const hex = await sha512Hex(state.file);
        state.fileHashHex = hex;
        hashBox.textContent = `SHA-512:\n${hex}`;
        hashBox.classList.remove("hide");
        s2status.innerHTML = `<span class="status-ok">Hash calcolato.</span> Vai allo Step 3.`;
        showStep(3);
        $("bundleBtn").disabled = false;
      }catch(e){
        console.error(e);
        s2status.innerHTML = `<span class="status-bad">Errore:</span> impossibile calcolare l’hash in questo browser.`;
      }finally{
        hashBtn.disabled = false;
      }
    });

    // Step 3
    const bundleBtn = $("bundleBtn");
    const downloadBtn = $("downloadBtn");
    const back2 = $("back2");
    const s3status = $("s3status");
    const bundlePreview = $("bundlePreview");

    back2.addEventListener("click", () => showStep(2));

    function makeBundle(){
      const now = new Date();
      const iso = now.toISOString();

      const bundle = {
        schema: "HBCE-IPR-BASE",
        version: "0.1.0",
        created_at: iso,
        ue_first: true,
        privacy_by_design: true,
        zero_data_retention: true,
        subject: {
          mode: state.mode,
          cf: state.cf,
          ...(state.mode === "full" ? {
            nome: state.nome,
            cognome: state.cognome,
            nascita: state.nascita,
            luogo: state.luogo
          } : {})
        },
        document: {
          name: state.file ? state.file.name : null,
          type: state.file ? (state.file.type || null) : null,
          size_bytes: state.file ? state.file.size : null,
          sha512: state.fileHashHex || null
        },
        notes: [
          "Bundle generato localmente nel browser dell’utente (client-side).",
          "UE-first è standard di riferimento progettuale: non è certificazione ufficiale UE.",
          "Non sostituisce documenti statali. Verifica offline consigliata."
        ]
      };

      return JSON.stringify(bundle, null, 2);
    }

    bundleBtn.addEventListener("click", () => {
      if(!state.file || !state.fileHashHex){
        s3status.innerHTML = `<span class="status-bad">Errore:</span> serve un file con hash calcolato (Step 2).`;
        return;
      }
      state.bundleJson = makeBundle();
      state.bundleBlob = new Blob([state.bundleJson], { type: "application/json" });

      bundlePreview.textContent = state.bundleJson;
      bundlePreview.classList.remove("hide");

      downloadBtn.disabled = false;
      s3status.innerHTML = `<span class="status-ok">Bundle generato.</span> Ora puoi scaricare.`;
    });

    downloadBtn.addEventListener("click", () => {
      if(!state.bundleBlob) return;

      const safeCf = (state.cf || "CF").replace(/[^A-Z0-9]/g, "").slice(0, 16);
      const fname = `HBCE_IPR_BASE_${safeCf}_${new Date().toISOString().slice(0,10)}.json`;

      const url = URL.createObjectURL(state.bundleBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      s3status.innerHTML = `<span class="status-ok">Download avviato:</span> ${fname}`;
    });

    // init
    validateStep1();
    showStep(1);
  </script>
</body>
</html>
