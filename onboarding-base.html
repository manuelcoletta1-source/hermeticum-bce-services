<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hermeticum B.C.E. — Attivazione Base</title>
  <meta name="description" content="Attivazione Base Carta d’Identità Cibernetica: dati minimi + hashing locale dei file CIE. Nessun upload documento. Output: Bundle + PDAR + IPR (download)." />
  <style>
    :root{
      --bg:#0b0c10; --panel:#0f1117; --line:#24262b;
      --text:#e8e8e8; --muted:#9aa0a6; --accent:#6aa9ff;
      --ok:#2bd576; --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    header, main, footer{max-width:980px;margin:0 auto;padding:20px}
    header{border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:12px}
    a{color:var(--text);text-decoration:none}
    a:hover{color:var(--accent)}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:16px}
    label{display:block;margin-top:10px;font-size:0.95rem}
    input[type="text"], input[type="date"], input[type="file"]{
      width:100%;margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,0.03);color:var(--text)
    }
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .col{flex:1;min-width:240px}
    .btn{
      display:inline-block;padding:10px 14px;border:1px solid var(--line);
      border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer
    }
    .btn.primary{border-color:var(--accent);color:#fff}
    .btn:disabled{opacity:0.45;cursor:not-allowed}
    pre{
      white-space:pre-wrap;word-break:break-word;
      background:rgba(0,0,0,0.25);border:1px solid var(--line);
      padding:12px;border-radius:12px;color:var(--text);margin:10px 0 0
    }
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:0.8rem;color:var(--muted)}
    .pill.ok{border-color:rgba(43,213,118,0.35);color:rgba(43,213,118,0.95)}
    .note{font-size:0.9rem}
  </style>
</head>

<body>
<header>
  <div>
    <strong>Hermeticum B.C.E.</strong>
    <div class="muted" style="font-size:0.85rem">Attivazione Base · Carta d’Identità Cibernetica</div>
  </div>
  <nav class="muted" style="font-size:0.95rem">
    <a href="index.html">Home</a> ·
    <a href="services.html">Servizi</a>
  </nav>
</header>

<main>

  <section class="card">
    <h1 style="margin:0 0 8px">Attivazione Base</h1>
    <p class="muted" style="margin:0">
      Inserisci i dati minimi e seleziona i file CIE (fronte/retro).
      Il sistema calcola l’hash <strong>nel browser</strong>. I documenti <strong>non vengono caricati</strong>.
      Al termine puoi scaricare: <strong>Bundle</strong>, <strong>PDAR CIE</strong> e <strong>IPR Base</strong>.
    </p>
    <p class="muted note" style="margin:10px 0 0">
      Regola: <strong>fail-closed</strong>. Se mancano i file o gli hash, l’attivazione non procede.
    </p>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px">Dati minimi (uso interno)</h2>

    <div class="row">
      <div class="col">
        <label for="nome">Nome</label>
        <input id="nome" type="text" autocomplete="given-name" placeholder="Es. Manuel" />
      </div>
      <div class="col">
        <label for="cognome">Cognome</label>
        <input id="cognome" type="text" autocomplete="family-name" placeholder="Es. Coletta" />
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="nascita">Data di nascita</label>
        <input id="nascita" type="date" />
      </div>
      <div class="col">
        <label for="luogo">Luogo di nascita</label>
        <input id="luogo" type="text" placeholder="Es. Bologna (BO)" />
      </div>
    </div>

    <label for="cf">Codice Fiscale (uso interno, NON pubblicato)</label>
    <input id="cf" type="text" inputmode="latin" autocapitalize="characters" placeholder="Es. CLT..." />

    <p class="muted note" style="margin:10px 0 0">
      Nei record pubblici si usano solo evidenze (hash) e metadati minimali. Il CF non viene esportato in chiaro.
    </p>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px">Documento (CIE) — hashing locale</h2>

    <div class="row">
      <div class="col">
        <label for="cieFront">CIE fronte (file)</label>
        <input id="cieFront" type="file" accept="image/*,application/pdf" />
      </div>
      <div class="col">
        <label for="cieBack">CIE retro (file)</label>
        <input id="cieBack" type="file" accept="image/*,application/pdf" />
      </div>
    </div>

    <!-- TOOLBAR UNICA (4 bottoni) -->
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnHash">Calcola hash</button>
      <button class="btn" id="btnDownload" disabled>Scarica Bundle (JSON)</button>
      <button class="btn" id="btnDownloadPDAR" disabled>Scarica PDAR CIE (JSON)</button>
      <button class="btn primary" id="btnDownloadIPR" disabled>Scarica IPR Base (JSON)</button>
      <span class="pill" id="statePill">Stato: in attesa</span>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">Hash calcolati</h3>
      <div class="muted note">Fronte:</div>
      <pre id="outFront">(non calcolato)</pre>
      <div class="muted note" style="margin-top:10px">Retro:</div>
      <pre id="outBack">(non calcolato)</pre>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 8px">Bundle (anteprima)</h3>
      <pre id="outJson">{}</pre>
    </div>

    <p class="muted note" style="margin:10px 0 0">
      Output privati: Bundle, PDAR e IPR sono file scaricati localmente.
    </p>
  </section>

</main>

<footer>
  <p class="muted">
    Hermeticum B.C.E. — Attivazione Base · UE-first · GDPR minimization · fail-closed
  </p>
</footer>

<script>
  const $ = (id) => document.getElementById(id);

  function nowISO(){ return new Date().toISOString(); }

  function toHex(buffer){
    const bytes = new Uint8Array(buffer);
    let hex = "";
    for (const b of bytes) hex += b.toString(16).padStart(2, "0");
    return hex;
  }

  function setPill(text, ok){
    const pill = $("statePill");
    pill.textContent = text;
    pill.className = "pill" + (ok ? " ok" : "");
  }

  function downloadJSON(obj, filename){
    const data = JSON.stringify(obj, null, 2);
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function hashFileWithFallback(file){
    const buf = await file.arrayBuffer();
    try{
      const digest = await crypto.subtle.digest("SHA-512", buf);
      return { alg: "sha512", hex: toHex(digest) };
    }catch(e){
      const digest = await crypto.subtle.digest("SHA-256", buf);
      return { alg: "sha256", hex: toHex(digest) };
    }
  }

  function subjectMinimal(){
    const nome = $("nome").value.trim();
    const cognome = $("cognome").value.trim();
    const nascita = $("nascita").value;
    const luogo = $("luogo").value.trim();
    const cf = $("cf").value.trim().toUpperCase();

    return {
      given_name: nome || null,
      family_name: cognome || null,
      birth_date: nascita || null,
      birth_place: luogo || null,
      tax_code_internal: cf ? "[COLLECTED-PRIVATE]" : null
    };
  }

  function makeIPRId(subj){
    const baseA = (subj.given_name || "PRIVATE").replace(/\s+/g,"-");
    const baseB = (subj.family_name || "PRIVATE").replace(/\s+/g,"-");
    const stamp = new Date().toISOString().slice(0,10).replaceAll("-","");
    return `IPR-${(baseA+"-"+baseB).toUpperCase()}-BASE-${stamp}-0001`;
  }

  function buildBundle(subj, evidence){
    return {
      bundle_version: "1.0",
      type: "BaseActivationEvidenceBundle",
      namespace: "Hermeticum B.C.E.",
      service: "Services / Base Activation",
      created_at_utc: nowISO(),
      subject_minimal: subj,
      evidence,
      privacy: {
        no_document_upload: true,
        store_hash_only: true,
        public_records_no_plaintext_ids: true
      },
      fail_closed: [
        "Missing CIE front/back hash -> STOP"
      ]
    };
  }

  function buildPDAR(iprId, evidence){
    return {
      pdar_version: "1.0",
      type: "PublicDocumentAnchorRecord",
      namespace: "Hermeticum B.C.E.",
      service: "Services / Base Activation",
      status: "VALID-PRIVATE",
      subject: { ipr_id: iprId, holder_display_name: "[PRIVATE]", jurisdiction: "IT / UE" },
      identity_document: { doc_type: "Carta d’Identità (CIE)", scope: "KYC private evidence", storage: "NO-DOCUMENT-STORAGE" },
      evidence,
      compliance: { ue_first: true, gdpr_minimization: true, fail_closed: true }
    };
  }

  function buildIPR(iprId){
    return {
      ipr_version: "1.0",
      type: "IPR",
      namespace: "Hermeticum B.C.E.",
      ipr_id: iprId,
      status: "BASE-ACTIVE",
      issued_at_utc: nowISO(),
      privacy: { public_records_no_plaintext_ids: true, store_hash_only: true },
      policy: { ue_first: true, gdpr_minimization: true, fail_closed: true },
      links_private: {
        pdar_cie_filename: "PDAR-CIE-IT.json",
        evidence_bundle_filename: "HERMETICUM-BASE-EVIDENCE-BUNDLE.json"
      }
    };
  }

  let __bundle = null, __pdar = null, __ipr = null, __iprId = null;

  // inizializzazione
  $("btnDownload").disabled = true;
  $("btnDownloadPDAR").disabled = true;
  $("btnDownloadIPR").disabled = true;

  $("btnHash").addEventListener("click", async () => {
    const f = $("cieFront").files[0];
    const b = $("cieBack").files[0];

    if (!f || !b){
      setPill("Stato: FAIL-CLOSED (mancano file CIE)", false);
      alert("Seleziona CIE fronte e retro. Il processo è fail-closed.");
      return;
    }

    try{
      setPill("Stato: calcolo hash…", false);
      $("btnHash").disabled = true;

      const front = await hashFileWithFallback(f);
      const back  = await hashFileWithFallback(b);

      $("outFront").textContent = `${front.alg.toUpperCase()}: ${front.hex}`;
      $("outBack").textContent  = `${back.alg.toUpperCase()}: ${back.hex}`;

      const subj = subjectMinimal();
      const evidence = {
        cie_front: { alg: front.alg, hash: front.hex },
        cie_back:  { alg: back.alg,  hash: back.hex }
      };

      __bundle = buildBundle(subj, evidence);
      __iprId = makeIPRId(subj);
      __pdar = buildPDAR(__iprId, evidence);
      __ipr  = buildIPR(__iprId);

      $("outJson").textContent = JSON.stringify(__bundle, null, 2);

      $("btnDownload").disabled = false;
      $("btnDownloadPDAR").disabled = false;
      $("btnDownloadIPR").disabled = false;

      setPill(`Stato: IPR Base pronto (${front.alg.toUpperCase()})`, true);

    }catch(e){
      console.error(e);
      setPill("Stato: ERRORE hashing", false);
      alert("Errore durante il calcolo hash. Prova a cambiare file o browser e riprova.");
    }finally{
      $("btnHash").disabled = false;
    }
  });

  $("btnDownload").addEventListener("click", () => {
    if (!__bundle){ alert("Calcola prima gli hash."); return; }
    downloadJSON(__bundle, "HERMETICUM-BASE-EVIDENCE-BUNDLE.json");
  });

  $("btnDownloadPDAR").addEventListener("click", () => {
    if (!__pdar){ alert("Calcola prima gli hash."); return; }
    downloadJSON(__pdar, "PDAR-CIE-IT.json");
  });

  $("btnDownloadIPR").addEventListener("click", () => {
    if (!__ipr){ alert("Calcola prima gli hash."); return; }
    const filename = (__iprId || "IPR-BASE") + ".json";
    downloadJSON(__ipr, filename);
  });
</script>

</body>
</html>
