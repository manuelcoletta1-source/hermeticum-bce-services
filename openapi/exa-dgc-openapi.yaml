openapi: 3.1.0
info:
  title: EXA-DGC API
  version: "1.0.0"
  description: >
    Ex-Ante Cybernetic Decision Gate (DGC) API implementing fail-closed authorization
    for digital and algorithmic actions. Execution is permitted only if all ex-ante
    requirements are satisfied prior to execution.

servers:
  - url: https://api.example.tld
    description: Production (example)
  - url: https://sandbox.api.example.tld
    description: Sandbox (example)

tags:
  - name: dgc
    description: Decision Gate operations
  - name: execution
    description: Protected execution endpoints
  - name: audit
    description: Evidence retrieval for independent verification

security:
  - BearerAuth: []

paths:
  /dgc/actions:
    post:
      tags: [dgc]
      summary: Create action request
      operationId: createAction
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ActionCreateRequest"
      responses:
        "201":
          description: Action created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActionRecord"
        "400":
          $ref: "#/components/responses/BadRequest"

    get:
      tags: [dgc]
      summary: List actions
      operationId: listActions
      parameters:
        - in: query
          name: status
          schema:
            $ref: "#/components/schemas/ActionStatus"
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
        - in: query
          name: cursor
          schema:
            type: string
      responses:
        "200":
          description: Action list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActionList"

  /dgc/actions/{action_id}:
    get:
      tags: [dgc]
      summary: Get action
      operationId: getAction
      parameters:
        - $ref: "#/components/parameters/ActionId"
      responses:
        "200":
          description: Action record
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActionRecord"
        "404":
          $ref: "#/components/responses/NotFound"

  /dgc/actions/{action_id}/responsibility:
    post:
      tags: [dgc]
      summary: Declare responsibility
      operationId: declareResponsibility
      parameters:
        - $ref: "#/components/parameters/ActionId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResponsibilityDeclaration"
      responses:
        "200":
          description: Responsibility declared
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ActionRecord"
        "409":
          $ref: "#/components/responses/Conflict"

  /dgc/actions/{action_id}/validate:
    post:
      tags: [dgc]
      summary: Validate action ex-ante
      operationId: validateAction
      parameters:
        - $ref: "#/components/parameters/ActionId"
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationResult"
        "404":
          $ref: "#/components/responses/NotFound"

  /execution/actions/{action_id}/execute:
    post:
      tags: [execution]
      summary: Execute authorized action
      operationId: executeAction
      parameters:
        - $ref: "#/components/parameters/ActionId"
      security:
        - ActionTokenAuth: []
      responses:
        "200":
          description: Execution completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecutionResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          $ref: "#/components/responses/Conflict"

  /audit/evidence/{evidence_id}:
    get:
      tags: [audit]
      summary: Get evidence package
      operationId: getEvidence
      parameters:
        - in: path
          name: evidence_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Evidence package
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvidencePackage"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  parameters:
    ActionId:
      in: path
      name: action_id
      required: true
      schema:
        type: string
        format: uuid

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    ActionTokenAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token issued only after successful ex-ante validation.

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: State conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ActionStatus:
      type: string
      enum: [REQUESTED, VALIDATING, DENIED, AUTHORIZED, EXECUTED, RECORDED]

    ActionCreateRequest:
      type: object
      required: [action_type, context, requestor_system]
      properties:
        action_type:
          type: string
        context:
          type: string
        requestor_system:
          type: string
        payload_hash_hex:
          type: string

    ActionRecord:
      type: object
      required: [action_id, action_type, status, created_at]
      properties:
        action_id:
          type: string
          format: uuid
        action_type:
          type: string
        status:
          $ref: "#/components/schemas/ActionStatus"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        context:
          type: string
        requestor_system:
          type: string
        evidence_id:
          type: string
          format: uuid

    ActionList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ActionRecord"
        next_cursor:
          type: string
          nullable: true

    ResponsibilityDeclaration:
      type: object
      required: [human_subject_id, role, decision_statement]
      properties:
        human_subject_id:
          type: string
        role:
          type: string
        decision_statement:
          type: string
        decision_timestamp:
          type: string
          format: date-time

    ValidationChecks:
      type: object
      properties:
        responsibility:
          type: string
        explicit_decision:
          type: string
        opposable_trace:
          type: string
        non_neutralizable_cost:
          type: string
        temporal_exposure:
          type: string

    ValidationResult:
      type: object
      required: [status, action_id, checks]
      properties:
        status:
          type: string
          enum: [AUTHORIZED, DENIED]
        action_id:
          type: string
          format: uuid
        evidence_id:
          type: string
          format: uuid
        token:
          type: string
        reason_code:
          type: string
        checks:
          $ref: "#/components/schemas/ValidationChecks"

    ExecutionResult:
      type: object
      required: [action_id, executed_at, outcome]
      properties:
        action_id:
          type: string
          format: uuid
        executed_at:
          type: string
          format: date-time
        outcome:
          type: string
          enum: [SUCCESS, FAILURE]

    EvidencePackage:
      type: object
      required: [evidence_id, action_id, created_at, hash_algorithm, digest_hex]
      properties:
        evidence_id:
          type: string
          format: uuid
        action_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        hash_algorithm:
          type: string
        digest_hex:
          type: string

    ErrorResponse:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
        message:
          type: string
        reason_code:
          type: string
