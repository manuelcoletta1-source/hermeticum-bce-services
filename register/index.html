<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EVT-0012 — REGISTRATION_GATE</title>
  <meta name="description" content="EVT-0012 — REGISTRATION_GATE. Richiesta cittadino UE. Hash-only, UE-first, fail-closed." />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#0b0e11; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#5eead4;
      --card:#0f1318; --line:#1f2937; --warn:#f87171; --ok:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;line-height:1.45}
    main{min-height:100vh;display:grid;place-items:center;padding:24px}
    .panel{max-width:860px;width:100%;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:26px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    h1{margin:0 0 6px 0;font-size:1.45rem}
    .sub{color:var(--muted);margin:0 0 18px 0}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:.8rem;color:var(--muted);margin-bottom:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:760px){ .grid.two{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:.9rem;margin:0 0 6px 2px;color:var(--muted)}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:10px;
      border:1px solid var(--line); background:#0b0e11; color:var(--fg);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#334155}
    .row{display:grid;gap:12px}
    .section{margin-top:16px;padding-top:16px;border-top:1px dashed var(--line)}
    .hint{font-size:.85rem;color:var(--muted);margin-top:8px}
    .actions{display:grid;gap:10px;margin-top:14px}
    @media(min-width:760px){ .actions{grid-template-columns:1fr 1fr} }
    button{
      padding:13px 16px;border-radius:10px;border:1px solid var(--line);
      background:var(--accent); color:#022c22; font-weight:700; cursor:pointer;
    }
    button.secondary{background:transparent;color:var(--fg)}
    .box{
      margin-top:12px; padding:14px; border:1px solid var(--line); border-radius:10px;
      background:#0b0e11;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.85rem; white-space:pre-wrap; word-break:break-word;
    }
    .status{font-size:.9rem;margin-top:10px}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    a{color:var(--accent);text-decoration:none}
    .foot{margin-top:18px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;color:var(--muted);font-size:.8rem}
    .mini{font-size:.85rem;color:var(--muted)}
    .req{color:var(--warn);font-weight:700;margin-left:6px}
  </style>
</head>

<body>
<main>
  <div class="panel">
    <span class="badge">EVT-0012 · REGISTRATION_GATE · UE_FIRST · HASH_ONLY · FAIL_CLOSED</span>
    <h1>Richiesta Cittadino UE</h1>
    <p class="sub">
      Qui non crei un account: generi un <strong>evento territoriale</strong>.  
      L’output è un <strong>hash</strong> (SHA-256) del payload normalizzato. Nessun invio automatico.
    </p>

    <form id="regForm" novalidate>
      <div class="grid two">
        <div>
          <label for="nation">Nazione<span class="req">*</span></label>
          <input id="nation" name="nation" autocomplete="country-name" required placeholder="Es. Italia" />
        </div>
        <div>
          <label for="region">Regione<span class="req">*</span></label>
          <input id="region" name="region" required placeholder="Es. Piemonte" />
        </div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div>
          <label for="city">Città<span class="req">*</span></label>
          <input id="city" name="city" autocomplete="address-level2" required placeholder="Es. Torino" />
        </div>
        <div>
          <label for="district">Quartiere / Zona<span class="req">*</span></label>
          <input id="district" name="district" required placeholder="Es. Barriera di Milano" />
        </div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div>
          <label for="name">Nome<span class="req">*</span></label>
          <input id="name" name="name" autocomplete="given-name" required />
        </div>
        <div>
          <label for="surname">Cognome<span class="req">*</span></label>
          <input id="surname" name="surname" autocomplete="family-name" required />
        </div>
      </div>

      <div class="section">
        <div class="grid two">
          <div>
            <label for="cie">CIE (opzionale)</label>
            <input id="cie" name="cie" inputmode="text" placeholder="Inserisci identificativo CIE (se vuoi)" />
            <div class="hint">Aumenta la forza probatoria dell’evento (non obbligatorio).</div>
          </div>
          <div>
            <label for="taxcode">Codice Fiscale (opzionale)</label>
            <input id="taxcode" name="taxcode" inputmode="text" placeholder="Es. RSSMRA80A01H501U" />
            <div class="hint">Se presente, viene normalizzato (ma resta hash-only).</div>
          </div>
        </div>

        <div class="section">
          <div class="mini">
            <strong>Termini minimi (hash-only)</strong><br/>
            Proseguendo dichiari che i dati sono corretti e accetti che questa azione produca un
            <strong>evento opponibile</strong> in modalità <strong>append-only</strong>.  
            Nessun profilo viene creato. Nessun dato viene centralizzato su questa pagina.
          </div>
        </div>

        <div class="actions">
          <button type="submit">Genera evento (EVT-0012) + Hash</button>
          <button class="secondary" type="button" id="resetBtn">Reset</button>
        </div>
      </div>
    </form>

    <div class="section">
      <strong>Output (locale)</strong>
      <div class="status" id="statusLine">Stato: <span class="warn">INATTIVO</span></div>

      <div class="hint">Payload normalizzato (JSON):</div>
      <div class="box" id="payloadBox">—</div>

      <div class="hint">registration_hash (SHA-256 hex):</div>
      <div class="box" id="hashBox">—</div>
    </div>

    <div class="foot">
      <span>Politica: UE_FIRST · GDPR_MIN · HASH_ONLY</span>
      <span>Audit: APPEND_ONLY · FAIL_CLOSED</span>
    </div>
  </div>
</main>

<script>
  // --- Normalizzazione: semplice, deterministica, audit-friendly.
  function normSpaces(s) {
    return (s || "").trim().replace(/\s+/g, " ");
  }
  function normUpper(s) {
    return normSpaces(s).toUpperCase();
  }
  function normTitle(s) {
    // Title-case conservativo (non perfetto per tutte le lingue, ma stabile).
    const t = normSpaces(s).toLowerCase();
    return t.split(" ").filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
  }
  function onlyAlnumUpper(s) {
    return normUpper(s).replace(/[^A-Z0-9]/g, "");
  }

  async function sha256Hex(text) {
    const enc = new TextEncoder();
    const buf = enc.encode(text);
    const digest = await crypto.subtle.digest("SHA-256", buf);
    const bytes = Array.from(new Uint8Array(digest));
    return bytes.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  function nowRFC3339() {
    // ISO 8601 in UTC per output; coerente e confrontabile.
    return new Date().toISOString();
  }

  const form = document.getElementById("regForm");
  const resetBtn = document.getElementById("resetBtn");
  const payloadBox = document.getElementById("payloadBox");
  const hashBox = document.getElementById("hashBox");
  const statusLine = document.getElementById("statusLine");

  function setStatus(state, ok=false) {
    statusLine.innerHTML = 'Stato: <span class="' + (ok ? 'ok' : 'warn') + '">' + state + '</span>';
  }

  function buildNormalizedPayload(raw) {
    // Nota: nome/cognome in Title-case; luogo in Title-case; CF in alfanumerico uppercase.
    const declared = {
      nation: normTitle(raw.nation),
      region: normTitle(raw.region),
      city: normTitle(raw.city),
      district: normTitle(raw.district),
      name: normTitle(raw.name),
      surname: normTitle(raw.surname)
    };

    const docs = {};
    const cie = normSpaces(raw.cie);
    const tax = onlyAlnumUpper(raw.taxcode);

    if (cie) docs.cie = cie;
    if (tax) docs.tax_code = tax;

    // Envelope EVT-0012 (hash-only): niente PII “extra”, niente indirizzi, niente civico.
    const payload = {
      evt: "EVT-0012",
      name: "REGISTRATION_GATE",
      scope: "EU_CITIZEN_REQUEST",
      policy: ["UE_FIRST","GDPR_MIN","HASH_ONLY","FAIL_CLOSED"],
      time: nowRFC3339(),
      declared_identity: declared,
      identity_documents: Object.keys(docs).length ? docs : { none: true }
    };

    return payload;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // fail-closed: se mancano i required -> stop.
    const requiredIds = ["nation","region","city","district","name","surname"];
    for (const id of requiredIds) {
      const el = document.getElementById(id);
      if (!normSpaces(el.value)) {
        setStatus("DENY (campi obbligatori mancanti)", false);
        el.focus();
        return;
      }
    }

    setStatus("PROCESSING…", true);

    const raw = {
      nation: document.getElementById("nation").value,
      region: document.getElementById("region").value,
      city: document.getElementById("city").value,
      district: document.getElementById("district").value,
      name: document.getElementById("name").value,
      surname: document.getElementById("surname").value,
      cie: document.getElementById("cie").value,
      taxcode: document.getElementById("taxcode").value
    };

    const payload = buildNormalizedPayload(raw);
    const normalizedText = JSON.stringify(payload); // deterministico (ordine chiavi stabile in JS moderno)
    const hash = await sha256Hex(normalizedText);

    payloadBox.textContent = JSON.stringify(payload, null, 2);
    hashBox.textContent = hash;

    // Output stato locale (nessun invio da questa pagina)
    setStatus("PENDING (hash generato localmente)", true);
  });

  resetBtn.addEventListener("click", () => {
    form.reset();
    payloadBox.textContent = "—";
    hashBox.textContent = "—";
    setStatus("INATTIVO", false);
  });
</script>
</body>
</html>
